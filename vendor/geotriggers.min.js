/*! geotriggers-js - v0.0.3 - 2013-09-03
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/

(function(e,t){"object"==typeof module&&"object"==typeof module.exports&&(XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest,exports=module.exports=t()),"function"==typeof define&&define.amd&&define(t),"object"==typeof window&&(e.Geotriggers=t())})(this,function(){function e(e){this._requestQueue=[],this._events={},this._failedRefreshes=0,this.refreshTries=3;var s={preferLocalStorage:!0,persistSession:"undefined"!=typeof module&&module.exports?!1:!0,geotriggersUrl:t,tokenUrl:r,registerDeviceUrl:i,debug:!1,automaticRegistation:!0};if(!e.clientId)throw Error("Geotriggers.Session requires an `clientId` or a `session` parameter.");a.merge(this,a.merge(s,e)),this.authenticatedAs=this.clientId&&this.clientSecret?"application":"device",this.key="_geotriggers_"+this.authenticatedAs+"_"+this.clientId,this.persistSession&&(this.preferLocalStorage&&c?a.merge(this,u.get(this.key)):h&&a.merge(this,l.get(this.key))),(this.token&&Date.now()>new Date(this.expiresOn).getTime()||!this.token)&&this.refresh()}var t="https://geotrigger.arcgis.com/",r="https://arcgis.com/sharing/oauth2/token",i="https://arcgis.com/sharing/oauth2/registerDevice",s={},o="undefined"!=typeof XDomainRequest,n=function n(){this._thens=[]};n.prototype={then:function(e,t){return this._thens.push({resolve:e,reject:t}),this},success:function(e){return this.then(e),this},error:function(e){return this.then(null,e),this},resolve:function(e){this._complete("resolve",e)},reject:function(e){this._complete("reject",e)},_complete:function(e,t){this.then="resolve"===e?function(e){e(t)}:function(e,r){r(t)},this.success=function(e){e(t)},this.error=function(e){e(t)},this.resolve=this.reject=function(){throw Error("Deferred already completed.")};for(var r=0;this._thens.length>r;r++){var i=this._thens[r];i[e]&&i[e](t)}delete this._thens}},s.Deferred=n,e.prototype.authenticated=function(){return!!this.token},e.prototype._runQueue=function(){for(var e=0;this._requestQueue.length>e;e++){var t=this._requestQueue[e];this.request(t.method,t.options,t.deferred)}},e.prototype.refresh=function(){return this.log("refrehsing session"),this._failedRefreshes>=this.refreshTries?(this.emit("authentication:cannotrefresh"),this.log("failed to refresh token "+this._failedRefreshes+" times not continuing to refresh"),void 0):(this.clientSecret?(this.log("getting new application token"),this.request(this.tokenUrl,{params:{client_id:this.clientId,client_secret:this.clientSecret,f:"json",grant_type:"client_credentials"}}).then(a.bind(this,function(e){this.token=e.access_token,this.expiresOn=new Date((new Date).getTime()+1e3*(e.expires_in-300)),this._processAuth()}),a.bind(this,this._authError))):this.refreshToken?(this.log("getting new device token with a refresh token"),this.request(this.tokenUrl,{params:{client_id:this.clientId,refresh_token:this.refreshToken,f:"json",grant_type:"refresh_token"}}).then(a.bind(this,function(e){this.token=e.access_token,this.refreshToken=e.refresh_token,this.expiresOn=new Date((new Date).getTime()+1e3*(e.expires_in-300)),this._processAuth()}),a.bind(this,this._authError))):this.automaticRegistation&&(this.log("no applicaitonSecret or refreshToken, registering a new device"),this.request(this.registerDeviceUrl,{params:{client_id:this.clientId,f:"json"}}).then(a.bind(this,function(e){this.deviceId=e.device.deviceId,this.token=e.deviceToken.access_token,this.refreshToken=e.deviceToken.refresh_token,this.expiresOn=new Date((new Date).getTime()+1e3*(e.deviceToken.expires_in-300)),this._processAuth(e)}),a.bind(this,this._authError))),void 0)},e.prototype.toJSON=function(){var e={};for(var t in this)this.hasOwnProperty(t)&&this[t]&&!t.match(/^_.+/)&&(e[t]=this[t]);return e},e.prototype.on=function(e,t){this._events[e]===void 0&&(this._events[e]=[]),this._events[e].push(t)},e.prototype.emit=function(e){var t=[].splice.call(arguments,1);if(this._events[e]instanceof Array)for(var r=this._events[e],i=0,s=r.length;s>i;i++)r[i].apply(this,t)},e.prototype.off=function(e,t){if(this._events[e]instanceof Array)for(var r=this._events[e],i=0,s=r.length;s>i;i++)if(r[i]===t){r.splice(i,1);break}},e.prototype._processAuth=function(e){this._failedRefreshes=0,this.persistSession&&this.persist(),this.log("session refreshed running queue"),this._runQueue(),this.emit("authentication:success",e),this.emit("authenticated",e)},e.prototype._authError=function(e){this._failedRefreshes++,this.log("error getting token or registering device from ArcGIS, "+e.error_description),this.emit("authentication:failure",e),this.refresh()},e.prototype.log=function(){var e=Array.prototype.slice.apply(arguments);e.unshift(this.key),this.debug&&a.log.apply(this,e)},e.prototype.request=function(e,t,r){var i,n=this,c={params:{},callback:null,addCallbacksToDeferred:!0},h=r||new s.Deferred,u=a.merge(c,t),l=!e.match(/^https?:\/\//),p=l?this.geotriggersUrl+e:e;this.log("making request to "+p+" as a "+this.authenticatedAs);var f=function(){n.log("successful http request to "+p+" as a "+n.authenticatedAs);var t=JSON.parse(i.responseText),r=t.error?null:t,s=t.error?t.error:null;if(s&&"invalidHeader"===s.type&&s.headers.Authorization)n.log("invalid authentication for http request to "+p+" trying to refresh token"),n._requestQueue.push({method:e,options:u,deferred:h}),n.refresh();else if(s)if(s)n.log("running error callback for request to "+p+" with ",r),h.reject(s,i),u.callback&&u.callback(s,null,i);else{var o={type:"unexpected_response",message:"the api returned a non json or unexpected data"};n.log("running error callback for request to "+p+" with ",o),h.reject(o,i),u.callback&&u.callback(o,null,i)}else n.log("running success callback for request to "+p+" with ",r),h.resolve(r,i),u.callback&&u.callback(null,r,i)},d=function(){var e=JSON.parse(i.responseText);n.log("request to "+p+" as a "+n.authenticatedAs+" failed with ",e);var t={type:"http_error",message:e};h.reject(t)},g=function(){4===i.readyState&&400>i.status?f():4===i.readyState&&i.status>=400&&d()};if(o)i=new XDomainRequest,i.onload=f,i.onerror=d,i.ontimeout=d;else{if("undefined"==typeof XMLHttpRequest)throw Error("This browser does not support XMLHttpRequest or XDomainRequest");i=new XMLHttpRequest,i.onreadystatechange=g}l&&(u.params.token=this.token);var y=l?JSON.stringify(u.params):a.serialize(u.params);if(i.open("POST",p),!o){var m=l?"application/json":"application/x-www-form-urlencoded";i.setRequestHeader("Content-Type",m)}return i.send(y),this.log("sent request to "+p+" as a "+this.authenticatedAs+" with",u.params),h},e.prototype.persist=function(){var e={};this.clientSecret&&(e.clientSecret=this.clientSecret),this.token&&(e.token=this.token),this.refreshToken&&(e.refreshToken=this.refreshToken),this.deviceId&&(e.deviceId=this.deviceId),this.preferLocalStorage&&c?(this.log("persisting session to localStorage ",e),u.set(this.key,e)):h&&(this.log("persisting session to cookie ",e),l.set(this.key,e))},e.prototype.destroy=function(){this.log("destorying persisted session"),this.preferLocalStorage&&c?u.erase(this.key):h&&l.erase(this.key)},s.Session=e;var a={bind:function(e,t){var r,i;if("function"!=typeof t)throw new TypeError;return"function"==typeof Function.prototype.bind?t.bind(e):(i=Array.prototype.slice.call(arguments,2),r=function(){if(!(this instanceof r))return t.apply(e,i.concat(Array.prototype.slice.call(arguments)));var s;s.prototype=t.prototype;var o=new s,n=t.apply(o,i.concat(Array.prototype.slice.call(arguments)));return Object(n)===n?n:o})},merge:function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e},log:function(){var e=Array.prototype.slice.apply(arguments);if(Function.prototype.bind&&void 0!==typeof console&&console.log){var t=Function.prototype.bind.call(console.log,console);t.apply(console,e)}},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},serialize:function(e,t){var r=encodeURIComponent,i=[];for(var s in e){var o,n=t?t+"["+s+"]":s,c=e[s];o="properties"===n||"condition[geo][geojson]"===n||"locations"===n||"data"===n?r(n)+"="+r(JSON.stringify(c)):a.isObject(c)?a.serialize(c,n):r(n)+"="+r(c),i.push(o)}return i.join("&")}},c="object"==typeof window&&"object"==typeof window.localStorage?!0:!1,h="object"==typeof document&&"string"==typeof document.cookie?!0:!1,u={set:function(e,t){window.localStorage.setItem(e,JSON.stringify(t))},get:function(e){return JSON.parse(window.localStorage.getItem(e))},erase:function(e){window.localStorage.removeItem(e)}},l={get:function(e){var t=document.cookie.match(RegExp(e+"=[a-zA-Z0-9.()=|%/_]+($|;)","g"));return t&&t[0]?JSON.parse(t[0].substring(e.length+1,t[0].length).replace(";",""))||null:null},set:function(e,t,r){var i=[e+"="+JSON.stringify(t),"path=/","domain="+window.location.host],s=new Date;return s.setFullYear(s.getFullYear()+1),i.push(s.toGMTString()),r&&i.push("secure"),document.cookie=i.join("; ")},erase:function(e){document.cookie=e+"; "+new Date(0).toUTCString()}};return s});