/*! geotrigger-js - v0.1.4 - 2013-11-20
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/

(function(e,t){"object"==typeof module&&"object"==typeof module.exports&&(XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest,exports=module.exports=t()),"object"==typeof window&&(e.Geotrigger=t())})(this,function(){function e(e){this._queue=[],this._requestQueue=[],this._events={};var s={preferLocalStorage:!0,persistSession:"undefined"!=typeof module&&module.exports?!1:!0,geotriggersUrl:t,tokenUrl:r,registerDeviceUrl:i,automaticRegistation:!0,proxy:!1};if(!e||!e.clientId)throw Error("Geotrigger.Session requires an `clientId` or a `session` parameter.");if(!e.proxy&&!n)throw Error("This browser does not support CORS and a proxy has not been set.");o.merge(this,o.merge(s,e)),this.authenticatedAs=this.clientId&&this.clientSecret?"application":"device",this.key="geotriggers_"+this.authenticatedAs+"_"+this.clientId,this.persistSession&&(this.preferLocalStorage&&h?o.merge(this,c.get(this.key)):a&&o.merge(this,p.get(this.key))),(this.token&&Date.now()>new Date(this.expiresOn).getTime()||!this.token)&&this.refresh()}var t="https://geotrigger.arcgis.com/",r="https://arcgis.com/sharing/oauth2/token",i="https://arcgis.com/sharing/oauth2/registerDevice",s={},n=!0;"object"==typeof window&&(n=!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest)),Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),r=this,i=function(){},s=function(){return r.apply(this instanceof i&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return i.prototype=this.prototype,s.prototype=new i,s}),e.prototype.authenticated=function(){return!!this.token},e.prototype.refresh=function(){if(!this.refreshing){this.refreshing=!0;var e=this.tokenUrl,t={client_id:this.clientId,f:"json"};this.clientSecret?(t.client_secret=this.clientSecret,t.grant_type="client_credentials"):this.refreshToken?(t.refresh_token=this.refreshToken,t.grant_type="refresh_token"):this.automaticRegistation&&(e=this.registerDeviceUrl),this.request(e,t,function(e,t){if(this.refreshing=!1,e)return this.emit("authentication:error",e),void 0;for(this.expiresOn=new Date((new Date).getTime()+1e3*(t.expires_in-300)),t.deviceToken?(this.refreshToken=t.deviceToken.refresh_token,this.token=t.deviceToken.access_token,this.deviceId=t.device.deviceId):(this.refreshToken=t.refresh_token,this.token=t.access_token),this.persistSession&&this.persist();this._queue.length;)this._queue.shift().apply(this);for(;this._requestQueue.length;)this.request.apply(this,this._requestQueue.shift());this.emit("authentication:success")}.bind(this))}},e.prototype.toJSON=function(){var e={};for(var t in this)this.hasOwnProperty(t)&&this[t]&&!t.match(/^_.+/)&&(e[t]=this[t]);return e},e.prototype.on=function(e,t){this._events[e]===void 0&&(this._events[e]=[]),this._events[e].push(t)},e.prototype.emit=function(e){var t=[].splice.call(arguments,1);if(this._events[e]instanceof Array)for(var r=this._events[e],i=0,s=r.length;s>i;i++)r[i].apply(this,t)},e.prototype.off=function(e,t){if(this._events[e]instanceof Array)for(var r=this._events[e],i=0,s=r.length;s>i;i++)if(r[i]===t){r.splice(i,1);break}},e.prototype.queue=function(e){return this.token?(e.apply(this),void 0):(this._queue.push(e),this.refresh(),void 0)},e.prototype.request=function(e,t,r){var i,s,n,h,a=Array.prototype.slice.apply(arguments),c=!e.match(/^https?:\/\//),p=c?this.geotriggersUrl+e:e;if(this.proxy&&(p=this.proxy+p),"function"==typeof t&&(r=t,t={}),c&&!this.token)return this._requestQueue.push(a),this.refresh(),void 0;var u=function(){try{i=JSON.parse(h.responseText),n=i.error?null:i,s=i.error?i.error:null}catch(e){n=null,s={type:"parse_error",message:"cound not parse response as JSON"}}if(s&&"invalidHeader"===s.type&&s.headers.Authorization)this._requestQueue.push(a),this.refresh();else if(s)if(s)r(s,null,h);else{var t={type:"unexpected_response",message:"the api returned a non JSON or unexpected data"};r(t,null,h)}else r(null,n,h)}.bind(this),l=function(){var e={type:"http_error"};try{e.message=JSON.parse(h.responseText)}catch(t){e.message="http error and cound not parse response as JSON"}r(e,null,h)}.bind(this),f=function(){4===h.readyState&&400>h.status?u():4===h.readyState&&h.status>=400&&l()}.bind(this);h=new XMLHttpRequest,h.onreadystatechange=f;var d;c?(t.token=this.token,d=JSON.stringify(t)):d=o.serialize(t),h.open("POST",p),h.setRequestHeader("Content-Type",c?"application/json":"application/x-www-form-urlencoded"),h.send(d)},e.prototype.persist=function(){var e={};this.clientId&&(e.clientId=this.clientId),this.clientSecret&&(e.clientSecret=this.clientSecret),this.token&&(e.token=this.token),this.refreshToken&&(e.refreshToken=this.refreshToken),this.deviceId&&(e.deviceId=this.deviceId),this.preferLocalStorage&&h?c.set(this.key,e):a&&p.set(this.key,e)},e.prototype.destroy=function(){this.preferLocalStorage&&h?c.erase(this.key):a&&p.erase(this.key)},s.Session=e;var o={merge:function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},serialize:function(e,t){var r=encodeURIComponent,i=[];for(var s in e)if(e.hasOwnProperty(s)){var n,h=t?t+"["+s+"]":s,a=e[s];n=o.isObject(a)?o.serialize(a,h):r(h)+"="+r(a),i.push(n)}return i.join("&")}},h="object"==typeof window&&"object"==typeof window.localStorage?!0:!1,a="object"==typeof document&&"string"==typeof document.cookie?!0:!1,c={set:function(e,t){window.localStorage.setItem(e,JSON.stringify(t))},get:function(e){return JSON.parse(window.localStorage.getItem(e))},erase:function(e){window.localStorage.removeItem(e)}},p={get:function(e){var t=document.cookie.match(RegExp(e+"=[a-zA-Z0-9.()=|%/_]+($|;)","g"));return t&&t[0]?JSON.parse(t[0].substring(e.length+1,t[0].length).replace(";",""))||null:null},set:function(e,t,r){var i=[e+"="+JSON.stringify(t),"path=/","domain="+window.location.host],s=new Date;return s.setFullYear(s.getFullYear()+1),i.push(s.toGMTString()),r&&i.push("secure"),document.cookie=i.join("; ")},erase:function(e){document.cookie=e+"; "+new Date(0).toUTCString()}};return s});