/*! geotrigger-editor 2013-09-04 */
GeotriggerEditor.module("API",function(a,b){a.addInitializer(function(){this.session=new Geotriggers.Session({clientId:b.Config.session.clientId,clientSecret:b.Config.session.clientSecret,persistSession:!1})})}),GeotriggerEditor.module("Config",function(a){var b={showArea:!1,shapeOptions:{stroke:!0,color:"#00b1dc",weight:2,opacity:.8,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}};_.extend(a,{Map:{basemap:"Streets",center:[45.516484,-122.676339],zoom:12},imagePath:"/images",polygonOptions:b,circleOptions:b,drivetimeOptions:{icon:L.icon({iconUrl:"img/blue-dot.png",iconRetinaUrl:"img/blue-dot@2x.png",iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[0,0],shadowUrl:null,shadowRetinaUrl:null,shadowSize:[0,0],shadowAnchor:[0,0]})},session:{clientId:"rcMNAPBoIn2M1JoI",clientSecret:"77edd9c16dde46ad9a93b79c83229887"}})}),GeotriggerEditor.module("Map.Draw",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{editLayer:null,tools:{polygon:null,radius:null},_eventBindings:function(){b.vent.on("map:draw:tool:enable",this.enableTool,this),b.vent.on("trigger:new",function(a){a&&(this.editTrigger(a),b.vent.trigger("controls:tools:disable-draw"))},this),b.vent.on("trigger:create trigger:update trigger:new:cancel",function(){this.clear()},this),b.vent.on("trigger:edit",function(a){this.clearShape(a),this.editTrigger(a),b.Map.zoomToLayer(a)},this),b.map.on("draw:created",function(a){a.layerType;var c=a.layer;b.vent.trigger("trigger:new",c)})},editTrigger:function(a){this.clear(),a.editing.enable(),this.editLayer.addLayer(a)},polygon:function(a,c){return polygon=new L.GeoJSON(a,{style:function(){return b.Config.polygonOptions.shapeOptions}}),this.mainLayer.addLayer(polygon),polygon.triggerId=c,polygon.on("click",function(a){console.log(a.target.triggerId)}),polygon},radius:function(a,c){var d=L.circle([a.latitude,a.longitude],a.distance,b.Config.circleOptions.shapeOptions);return this.mainLayer.addLayer(d),d.triggerId=c,d.on("click",function(a){console.log(a.target.triggerId)}),d},clearShape:function(a){b.map.removeLayer(a)},clear:function(){this.editLayer.clearLayers()},enableTool:function(a){this.disableTool(),this.tools[a].enable()},disableTool:function(a){for(var b in this.tools)("undefined"==typeof a||b===a)&&this.tools[b].disable()}}),a.addInitializer(function(){this.editLayer=new L.FeatureGroup,this.mainLayer=new L.FeatureGroup,b.map.addLayer(this.editLayer),b.map.addLayer(this.mainLayer),this.tools.polygon=new L.Draw.Polygon(b.map,b.Config.polygonOptions),this.tools.radius=new L.Draw.Circle(b.map,b.Config.circleOptions),this._eventBindings()})}),GeotriggerEditor.module("Editor",function(a,b,c,d,e,f){a.Router=d.AppRouter.extend({appRoutes:{":id/edit":"edit","new":"new","":"list"}});var g=function(){this.triggerCollection=new b.Collections.Triggers,this.notificationCollection=new b.Collections.Notifications};f.extend(g.prototype,{start:function(){this.setupMap(),this.setupControls(),this.setupDrawers(this.triggerCollection),this.setupNotifications(),b.vent.trigger("notify",{type:"info",message:"Triggers loading"}),this.triggerCollection.fetch({reset:!0,success:function(){b.vent.trigger("notify:clear"),b.vent.trigger("controls:list:toggle"),b.map.fitBounds(b.Map.Draw.mainLayer.getBounds())}}),b.vent.on("trigger:create",this.createTrigger,this),b.vent.on("trigger:update",this.updateTrigger,this)},setupMap:function(){var a=new b.Views.Map;b.mapRegion.show(a)},setupControls:function(){var a=new b.Views.Controls;b.controlsRegion.show(a)},setupDrawers:function(a){this.drawers=new b.Layouts.Drawers;var c=new b.Views.List({collection:a});b.listDrawerRegion.show(this.drawers),this.drawers.listRegion.show(c)},setupNotifications:function(){var a=new b.Views.NotificationList({collection:this.notificationCollection});b.notificationsRegion.show(a),b.vent.on("notify",function(a){var c=new b.Models.Notification(a);this.notificationCollection.add(c)},this)},list:function(){console.log("list")},"new":function(){console.log("new");var a=new b.Views.New;b.newDrawerRegion.show(a)},edit:function(a){console.log("edit "+a);var c=this.triggerCollection.get(a),d=new b.Views.Edit({model:c});this.drawers.editRegion.show(d),this.drawers.$el.addClass("gt-panel-editing")},createTrigger:function(a){this.triggerCollection.create(a)},updateTrigger:function(a){var b=this.triggerCollection.get(a.triggerId);b.set(a),b.save()}}),a.addInitializer(function(){a.Controller=new g,new a.Router({controller:a.Controller}),a.Controller.start()})}),GeotriggerEditor.module("Map",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{zoomToLayer:function(a){b.map.fitBounds(a.getBounds(),{padding:[100,100]})}}),a.addInitializer(function(a){var c=a.el;b.map=L.map(c).setView(b.Config.Map.center,b.Config.Map.zoom),b.map.zoomControl.setPosition("topright"),L.esri.basemapLayer(b.Config.Map.basemap).addTo(b.map),this.Draw.start()})}),GeotriggerEditor.module("util",function(a){a.removeEmptyStrings=function(b){for(var c in b){if(""===b[c]&&delete b[c],b[c]instanceof Array){for(var d=!0,e=0;e<b[c].length;e++)if(""!==b[c][e]){d=!1;break}d&&delete b[c]}if("object"==typeof b[c]){b[c]=a.removeEmptyStrings(b[c]);var f=!1;for(var g in b[c]){f=!0;break}f||delete b[c]}}return b}}),GeotriggerEditor.module("Models",function(a,b,c){a.Notification=c.Model.extend({defaults:{type:"info",message:"everything's fine"}})}),GeotriggerEditor.module("Models",function(a,b,c,d,e,f){a.Trigger=c.Model.extend({idAttribute:"triggerId",sync:function(a,c,d){console.log("sync:"+a);var e=this.get("triggerId"),g=f.bind(function(a,b){a?d&&d.error&&d.error("Record Not Found"):d&&d.success&&d.success(b)},this),h=function(a,c){b.API.session.request(a,{params:c,callback:g})};switch(a){case"read":h("trigger/list",{triggerIds:[e]});break;case"create":h("trigger/create",c.toJSON());break;case"update":var i={triggerIds:e,condition:this.get("condition"),action:this.get("action"),setTags:this.get("tags")};h("trigger/update",i);break;case"delete":h("trigger/delete",{triggerIds:e})}}})}),GeotriggerEditor.module("Collections",function(a,b,c){a.Notifications=c.Collection.extend({model:b.Models.Notification})}),GeotriggerEditor.module("Collections",function(a,b,c,d,e,f){a.Triggers=c.Collection.extend({model:b.Models.Trigger,fetch:function(a){var c=f.bind(function(b,c){a.reset?this.reset(this.parse(c)):this.set(this.parse(c)),a.success&&a.success(this,this.parse(c),a)},this);b.API.session.request("trigger/list",{callback:c})},parse:function(a){return a.triggers}})}),GeotriggerEditor.module("Layouts",function(a,b,c,d,e){a.Drawers=c.Marionette.Layout.extend({template:b.Templates["drawer-list"],className:"gt-panel-wrap",events:{"click .gt-back-to-list":"backToList","click .gt-close-drawer":"closeDrawer"},regions:{listRegion:".gt-panel-list",editRegion:".gt-panel-edit"},initialize:function(){this.listenTo(b.vent,"drawer:list:toggle",this.toggleDrawer),this.listenTo(b.vent,"drawer:list:reset-buttons",this.resetButtons),this.listenTo(b.vent,"drawer:close",this.closeDrawer),this.listenTo(b.vent,"trigger:update",this.backToList)},toggleDrawer:function(a){"undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),this.$el.parent().hasClass("gt-open")?this.closeDrawer():this.openDrawer()},backToList:function(a){"undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),this.$el.removeClass("gt-panel-editing")},resetButtons:function(){this.$el.find(".gt-item-confirm-delete").removeClass("gt-item-confirm-delete"),this.$el.find(".gt-reset-delete").removeClass("gt-reset-flyout")},openDrawer:function(a){"undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),this.resetButtons(),this.$el.removeClass("gt-panel-editing"),this.$el.parent().addClass("gt-open"),e("#gt-map-region").addClass("gt-open-drawer"),b.map.invalidateSize()},closeDrawer:function(a){"undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),this.resetButtons(),this.$el.parent().removeClass("gt-open"),b.vent.trigger("controls:restore-shape"),b.vent.trigger("controls:deactivate","list"),e("#gt-map-region").removeClass("gt-open-drawer"),b.map.invalidateSize()}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Controls=d.ItemView.extend({template:b.Templates.controls,className:"gt-control-group",events:{"click .gt-tool-list":"toggleList","click .gt-tool-create":"toggleNew","click .gt-tool-polygon":"polygon","click .gt-tool-radius":"radius"},initialize:function(){this.listenTo(b.vent,"controls:deactivate",this.hideControl),this.listenTo(b.vent,"controls:restore-shape",this.restoreShape),this.listenTo(b.vent,"controls:tools:disable-draw",this.disableDrawTool),this.listenTo(b.vent,"trigger:new",this.showNew),this.listenTo(b.vent,"controls:list:toggle",this.toggleList)},hideControl:function(a){this.$el.find(".gt-tool-"+a).removeClass("gt-active")},showControl:function(a){this.$el.find(".gt-tool-"+a).addClass("gt-active")},toggleControl:function(a){this.$el.find(".gt-tool-"+a).toggleClass("gt-active")},toggleList:function(a){"undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),b.vent.trigger("drawer:new:close"),b.vent.trigger("drawer:list:toggle"),this.toggleControl("list"),this.restoreShape()},toggleNew:function(a){if("undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),b.vent.trigger("drawer:close"),!b.newDrawerRegion.currentView||!b.newDrawerRegion.$el.hasClass("gt-open")){var c=new b.Views.New;b.newDrawerRegion.show(c)}b.vent.trigger("drawer:new:toggle"),b.vent.trigger("drawer:list:reset-buttons"),this.toggleControl("create"),this.restoreShape()},showNew:function(){var a=new b.Views.New;b.newDrawerRegion.show(a),b.vent.trigger("drawer:close"),b.vent.trigger("drawer:new:open"),this.showControl("create"),b.vent.trigger("drawer:list:reset-buttons"),this.restoreShape()},polygon:function(a){a.preventDefault(),this.enableDrawTool("polygon")},radius:function(a){a.preventDefault(),this.enableDrawTool("radius")},enableDrawTool:function(a){this.disableDrawTool(),b.vent.trigger("map:draw:tool:enable",a),this.showControl(a),b.vent.trigger("drawer:list:reset-buttons")},disableDrawTool:function(a){a&&b.Map.Draw.disableTool(a),this.$el.find(".gt-draw-tools .gt-tool").removeClass("gt-active")},restoreShape:function(){b.Editor.Controller.drawers.editRegion.currentView&&b.Editor.Controller.drawers.editRegion.currentView.restoreShape()}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e){a.Edit=d.ItemView.extend({template:b.Templates.edit,className:"gt-edit",events:{"change .gt-geometry-type":"startDrawing","change .gt-action-selector":"toggleActions","click .gt-submit":"parseForm"},onShow:function(){var a,c=this.options.item;if(c.shape.getLayers)a=c.shape.getLayers()[0];else{if(!c.shape.editing)throw new Error("Unknown Layer Error");a=c.shape}b.vent.trigger("trigger:edit",a)},restoreShape:function(){this.options.item.restoreShape()},startDrawing:function(a){var c=e(a.target).val();b.Map.Draw.clear(),b.Map.Draw.enableTool(c)},toggleActions:function(a){var b=e(a.target).val();this.$el.find(".gt-action").hide(),this.$el.find(".gt-action-"+b).show()},parseForm:function(a){a.preventDefault();var c=this.$el.find("form").serializeObject();if(c=b.util.removeEmptyStrings(c),c.tags){var d=c.tags;d=d.split(",");for(var e=d.length-1;e>0;e--)d[e]=d[e].trim();c.tags=d}c&&this.updateTrigger(c)},updateTrigger:function(a){var c=b.Map.Draw.editLayer.getLayers()[0];if(c instanceof L.Circle){var d=c.getLatLng();a.condition.geo={latitude:d.lat,longitude:d.lng,distance:c.getRadius()}}else a.condition.geo={geojson:c.toGeoJSON()};a.triggerId=this.model.get("triggerId"),b.vent.trigger("trigger:update",a)}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.ListItem=d.ItemView.extend({template:b.Templates.item,tagName:"li",className:"gt-result",events:{"click .gt-item-edit":"editItem","click .gt-item-delete":"confirmDelete","click .gt-reset-delete":"resetDelete","click .gt-item-confirm-delete":"destroyModel"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change",this.renderShape)},onShow:function(){this.renderShape()},renderShape:function(){this.shape&&(b.Map.Draw.clearShape(this.shape),this.shape=null);var a=this.model.get("triggerId"),c=this.model.get("condition").geo;this.shape=c.geojson?b.Map.Draw.polygon(c.geojson,a):b.Map.Draw.radius(c,a)},restoreShape:function(){b.map.hasLayer(this.shape)||(b.Map.Draw.clear(),this.renderShape())},editItem:function(a){a.preventDefault();var c=new b.Views.Edit({model:this.model,item:this});b.Editor.Controller.drawers.editRegion.show(c),b.Editor.Controller.drawers.$el.addClass("gt-panel-editing"),b.vent.trigger("drawer:list:reset-buttons")},confirmDelete:function(a){a.preventDefault(),this.$el.find(".gt-item-delete").addClass("gt-item-confirm-delete"),this.$el.find(".gt-reset-delete").addClass("gt-reset-flyout")},resetDelete:function(a){a.preventDefault(),this.$el.find(".gt-item-confirm-delete").removeClass("gt-item-confirm-delete"),this.$el.find(".gt-reset-delete").removeClass("gt-reset-flyout")},destroyModel:function(a){window.test=this.model,a.preventDefault(),b.Map.Draw.clearShape(this.shape),this.model.destroy()}}),a.Empty=d.ItemView.extend({template:b.Templates.empty,className:"gt-list-empty",events:{"click .gt-tool-create":"newTrigger"},newTrigger:function(a){a.preventDefault(),b.vent.trigger("trigger:new")}}),a.List=d.CompositeView.extend({template:b.Templates.list,className:"gt-list",itemView:a.ListItem,itemViewContainer:".gt-results",emptyView:a.Empty,initialize:function(){var a=this;this.collection.on("change reset add remove",function(){a.collection.length?a.$el.find(".gt-list-header").removeClass("gt-hide"):a.$el.find(".gt-list-header").addClass("gt-hide")})}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Main=d.ItemView.extend({id:"gt-regions",template:b.Templates.main})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Map=d.ItemView.extend({id:"gt-map",render:function(){return this.isClosed=!1,this.triggerMethod("before:render",this),this.triggerMethod("item:before:render",this),this.triggerMethod("render",this),this.triggerMethod("item:rendered",this),this},onShow:function(){b.Map.start({el:this.el})}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e){a.New=d.ItemView.extend({template:b.Templates["new"],className:"gt-new gt-panel-wrap",events:{"click .gt-close-drawer":"closeDrawer","change .gt-geometry-type":"startDrawing","change .gt-action-selector":"toggleActions","click .gt-submit":"parseForm"},initialize:function(){var a=b.Map.Draw.editLayer;a.getLayers().length&&b.Map.zoomToLayer(a),this.listenTo(b.vent,"drawer:new:open",this.openDrawer),this.listenTo(b.vent,"drawer:new:close",this.closeDrawer),this.listenTo(b.vent,"drawer:new:toggle",this.toggle)},openDrawer:function(){this.$el.parent().addClass("gt-open"),e("#gt-map-region").addClass("gt-open-drawer"),b.map.invalidateSize()},closeDrawer:function(a){"undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),this.$el.parent().removeClass("gt-open"),e("#gt-map-region").removeClass("gt-open-drawer"),b.map.invalidateSize(),b.vent.trigger("controls:deactivate","create"),b.vent.trigger("trigger:new:cancel")},toggle:function(){this.$el.parent().hasClass("gt-open")?this.closeDrawer():this.openDrawer()},startDrawing:function(a){var c=e(a.target).val();b.Map.Draw.clear(),b.Map.Draw.enableTool(c)},toggleActions:function(a){var b=e(a.target).val();this.$el.find(".gt-action").hide(),this.$el.find(".gt-action-"+b).show()},parseForm:function(a){a.preventDefault();var c=this.$el.find("form").serializeObject();c=b.util.removeEmptyStrings(c),c&&(this.createTrigger(c),b.vent.trigger("controls:list:toggle"))},createTrigger:function(a){console.log(a);var c=b.Map.Draw.editLayer.getLayers()[0];if(c instanceof L.Circle){var d=c.getLatLng();a.condition.geo={latitude:d.lat,longitude:d.lng,distance:c.getRadius()}}else a.condition.geo={geojson:c.toGeoJSON()};b.vent.trigger("trigger:create",a)}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Notification=d.ItemView.extend({template:b.Templates.notification,className:"gt-notification",tagName:"li",events:{"click .gt-close":"destroyNotification"},render:function(){d.ItemView.prototype.render.apply(this,arguments),this.$el.addClass(this.model.get("type")),this.listenTo(b.vent,"notify:clear",this.destroyNotification)},destroyNotification:function(){this.model.destroy()}}),a.NotificationList=d.CollectionView.extend({itemView:a.Notification,className:"gt-notification-list",tagName:"ul"})});