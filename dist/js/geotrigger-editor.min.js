/*! geotrigger-editor 2013-09-09 */
GeotriggerEditor.module("API",function(a){a.addInitializer(function(a){try{if(!(a&&a.credentials&&a.credentials.clientId&&a.credentials.clientSecret))throw new Error("GeotriggerEditor requires a `credentials` object with `clientId` and `clientSecret` properties");this.session=new Geotriggers.Session({clientId:a.credentials.clientId,clientSecret:a.credentials.clientSecret,persistSession:!1})}catch(b){console.error(b.name+": "+b.message)}})}),GeotriggerEditor.module("Config",function(a){var b={showArea:!1,shapeOptions:{stroke:!0,color:"#00b1dc",weight:2,opacity:.8,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},c={showArea:!1,shapeOptions:{stroke:!0,color:"#00dcb1",weight:2,opacity:.8,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}};_.extend(a,{Map:{basemap:"Streets",center:[45.516484,-122.676339],zoom:12},imagePath:"/images",sharedOptions:b,editOptions:c})}),GeotriggerEditor.module("util",function(a){a.removeEmptyStrings=function(b){for(var c in b){if(""===b[c]&&delete b[c],b[c]instanceof Array){for(var d=!0,e=0;e<b[c].length;e++)if(""!==b[c][e]){d=!1;break}d&&delete b[c]}if("object"==typeof b[c]){b[c]=a.removeEmptyStrings(b[c]);var f=!1;for(var g in b[c]){f=!0;break}f||delete b[c]}}return b}}),GeotriggerEditor.module("Map.Draw",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_tools:{polygon:null,radius:null},_setup:function(){this._tools.polygon=new L.Draw.Polygon(b.map,b.Config.editOptions),this._tools.radius=new L.Draw.Circle(b.map,b.Config.editOptions),this._eventBindings()},_eventBindings:function(){b.vent.on("draw:new",function(a){this.editLayer(a)},this),b.vent.on("index trigger:list trigger:edit",function(){this.clear()},this),b.vent.on("trigger:edit",function(a){var b=this.newShape(a);this.editLayer(b)},this),b.map.on("draw:created",function(a){a.layerType;var c=a.layer;b.vent.trigger("draw:new",c)}),b.reqres.setHandler("draw:layer",f.bind(function(){return b.Map.Layers.edit.getLayers()[0]},this)),b.commands.setHandler("draw:clear",f.bind(function(){this.clear()},this)),b.commands.setHandler("draw:enable",f.bind(function(a){this.enableTool(a)},this)),b.commands.setHandler("draw:disable",f.bind(function(a){this.disableTool(a)},this))},newShape:function(a){var c=b.collections.triggers.get(a);c.get("triggerId");var d,e=c.get("condition").geo;return d=e.geojson?b.Map.polygon(e.geojson,b.Config.editOptions.shapeOptions,!1).getLayers()[0]:b.Map.circle(e,b.Config.editOptions.shapeOptions,!1)},editLayer:function(a){this.clear(),a.editing.enable(),b.Map.Layers.edit.addLayer(a)},clear:function(){b.Map.Layers.edit.clearLayers()},enableTool:function(a){this.disableTool(),this._tools[a].enable()},disableTool:function(a){for(var b in this._tools)("undefined"==typeof a||b===a)&&this._tools[b].disable()}}),a.addInitializer(function(){this._setup()})}),GeotriggerEditor.module("Editor",function(a,b,c,d,e,f){var g=d.AppRouter.extend({appRoutes:{"":"index",list:"list","new":"new",":id/edit":"edit","*notfound":"notFound"}}),h=function(){b.collections=b.collections||{},b.collections.triggers=new b.Collections.Triggers,b.collections.notifications=new b.Collections.Notifications};f.extend(h.prototype,{start:function(){this.setup(),b.vent.trigger("notify","Triggers loading"),b.collections.triggers.fetch({reset:!0,success:function(){b.vent.trigger("notify:clear"),b.execute("map:fit"),c.history.start()}}),b.vent.on("draw:new",function(){"new"===c.history.fragment||c.history.fragment.match("edit")||b.router.navigate("new",{trigger:!0})},this),b.vent.on("trigger:create",this.createTrigger,this),b.vent.on("trigger:update",this.updateTrigger,this),b.vent.on("trigger:destroy",this.deleteTrigger,this)},setup:function(){this.setupMap(),this.setupDrawer(),this.setupControls(),this.setupNotifications()},setupMap:function(){var a=new b.Views.Map({collection:b.collections.triggers});b.regions.map.show(a)},setupDrawer:function(){var a=b.regions.drawer,c=b.mainRegion.$el.find("#gt-content");a.on("show",function(){c.addClass("gt-active"),b.map.invalidateSize()}),a.on("close",function(){c.removeClass("gt-active"),b.map.invalidateSize()})},setupControls:function(){var a=new b.Views.Controls;b.regions.controls.show(a)},setupNotifications:function(){var a=new b.Views.NotificationList({collection:b.collections.notifications});b.regions.notes.show(a),b.vent.on("notify",function(a){"string"==typeof a&&(a={type:"info",message:a});var c=new b.Models.Notification(a);b.collections.notifications.add(c)},this)},index:function(){b.vent.trigger("index"),b.regions.drawer.close()},list:function(){b.vent.trigger("trigger:list");var a=new b.Views.List({collection:b.collections.triggers});b.regions.drawer.show(a)},"new":function(){b.vent.trigger("trigger:new");var a=new b.Views.New;b.regions.drawer.show(a)},edit:function(a){var c=this.getTrigger(a);if(c){var d=new b.Views.Edit({model:c});b.regions.drawer.show(d),b.vent.trigger("trigger:edit",a)}else this.notFound()},notFound:function(){b.vent.trigger("notify",{type:"error",message:"404: Not Found"})},createTrigger:function(a){b.collections.triggers.once("add",function(){b.router.navigate("list",{trigger:!0})}),b.collections.triggers.create(a,{wait:!0})},getTrigger:function(a){var c=b.collections.triggers.get(a);return c},updateTrigger:function(a){b.collections.triggers.once("change",function(){b.router.navigate("list",{trigger:!0})});var c=b.collections.triggers.get(a.triggerId);c.set(a),c.save()},deleteTrigger:function(a){b.collections.triggers.once("remove",function(){c.history.fragment.match("edit")&&b.router.navigate("list",{trigger:!0})}),a.destroy()}}),a.addInitializer(function(){var a=new h;b.router=new g({controller:a}),a.start()})}),GeotriggerEditor.module("Map.Layers",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_setup:function(){this.main=new L.FeatureGroup,b.map.addLayer(this.main),this.edit=new L.FeatureGroup,b.map.addLayer(this.edit)}}),a.addInitializer(function(){this._setup()})}),GeotriggerEditor.module("Map",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_setup:function(a){b.map=this.map=L.map(a.el).setView(b.Config.Map.center,b.Config.Map.zoom),this.map.zoomControl.setPosition("topright"),L.esri.basemapLayer(b.Config.Map.basemap).addTo(b.map),this.Layers.start(),this._eventBindings()},_eventBindings:function(){b.commands.setHandler("map:fit",f.bind(function(){this.map.fitBounds(this.Layers.main.getBounds())},this))},panToLayer:function(a){var b;a.getLatLng?b=a.getLatLng():a.getCenter&&(b=a.getCenter()),b&&this.map.panTo(b,{animate:!1})},zoomToLayer:function(a){this.map.fitBounds(a.getBounds(),{padding:[60,60]})},removeShape:function(a){this.map.removeLayer(a)},polygon:function(a,c,d){c=c||b.Config.sharedOptions.shapeOptions;var e=new L.GeoJSON(a,{style:function(){return c}});return d!==!1&&this.Layers.main.addLayer(e),e},circle:function(a,c,d){c=c||b.Config.sharedOptions.shapeOptions;var e=L.circle([a.latitude,a.longitude],a.distance,c);return d!==!1&&this.Layers.main.addLayer(e),e}}),a.addInitializer(function(a){this._setup(a),this.Draw.start()})}),GeotriggerEditor.module("Models",function(a,b,c){a.Notification=c.Model.extend({defaults:{type:"info",message:"everything's fine"}})}),GeotriggerEditor.module("Models",function(a,b,c,d,e,f){a.Trigger=c.Model.extend({idAttribute:"triggerId",sync:function(a,c,d){console.log("sync:"+a);var e=this.get("triggerId"),g=f.bind(function(c,e){c?d&&d.error&&d.error("Record Not Found"):("read"!==a&&b.vent.trigger("notify","Trigger "+a+"d successfully"),d&&d.success&&d.success(e))},this),h=function(a,c){b.API.session.request(a,{params:c,callback:g})};switch(a){case"read":h("trigger/list",{triggerIds:[e]});break;case"create":h("trigger/create",c.toJSON());break;case"update":var i={properties:this.get("properties"),triggerIds:e,condition:this.get("condition"),action:this.get("action"),setTags:this.get("tags")};h("trigger/update",i);break;case"delete":h("trigger/delete",{triggerIds:e})}}})}),GeotriggerEditor.module("Collections",function(a,b,c){a.Notifications=c.Collection.extend({model:b.Models.Notification})}),GeotriggerEditor.module("Collections",function(a,b,c,d,e,f){a.Triggers=c.Collection.extend({model:b.Models.Trigger,fetch:function(a){var c=f.bind(function(b,c){a.reset?this.reset(this.parse(c)):this.set(this.parse(c)),a.success&&a.success(this,this.parse(c),a)},this);b.API.session.request("trigger/list",{callback:c})},parse:function(a){return a.triggers}})}),GeotriggerEditor.module("Layouts",function(a,b,c){a.Drawers=c.Marionette.Layout.extend({template:b.Templates.drawers,className:"gt-panel-wrap",events:{},regions:{list:".gt-panel-list",edit:".gt-panel-edit",create:".gt-panel-new"},initialize:function(){this.listenTo(b.vent,"trigger:list",this.showList),this.listenTo(b.vent,"trigger:edit",this.showEdit),this.listenTo(b.vent,"trigger:new",this.showNew)},showList:function(){var a=new b.Views.List({collection:b.collections.triggers});this.list.show(a)},showEdit:function(a){var c=b.collections.triggers.get(a),d=new b.Views.Edit({model:c});this.edit.show(d)},showNew:function(){var a=new b.Views.New;this.create.show(a)}})}),GeotriggerEditor.module("Layouts",function(a,b,c){a.Main=c.Marionette.Layout.extend({template:b.Templates.main,id:"gt-regions",regions:{controls:"#gt-controls-region",drawer:"#gt-drawer-region",map:"#gt-map-region",notes:"#gt-notes-region"}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Controls=d.ItemView.extend({template:b.Templates.controls,className:"gt-control-group",events:{"click .gt-tool-list":"toggleList","click .gt-tool-create":"toggleNew","click .gt-tool-polygon":"togglePolygon","click .gt-tool-radius":"toggleRadius"},ui:{drawers:".gt-drawer-controls",tools:".gt-tool-controls",list:".gt-drawer-controls .gt-tool-list",create:".gt-drawer-controls .gt-tool-create",polygon:".gt-tool-controls .gt-tool-polygon",radius:".gt-tool-controls .gt-tool-radius",all:".gt-tool"},onRender:function(){this.listenTo(b.router,"route",this.handleStateChange),this.listenTo(b.vent,"draw:new",this.disableTool)},handleStateChange:function(a){switch(this.clear("drawers"),a){case"new":this.activate("create");break;case"edit":this.activate("list");break;case"list":this.activate("list")}},toggleList:function(a){this.ui.list.hasClass("gt-active")&&(a.preventDefault(),b.router.navigate("",{trigger:!0}))},toggleNew:function(a){this.ui.create.hasClass("gt-active")&&(a.preventDefault(),b.router.navigate("",{trigger:!0}))},togglePolygon:function(){this.ui.polygon.hasClass("gt-active")?this.disableTool("polygon"):this.activateTool("polygon")},toggleRadius:function(){this.ui.radius.hasClass("gt-active")?this.disableTool("radius"):this.activateTool("radius")},activateTool:function(a){this.disableTool(),b.execute("draw:enable",a),this.activate(a)},disableTool:function(a){a&&b.execute("draw:disable",a),this.ui.tools.find(".gt-tool").removeClass("gt-active")},activate:function(a){this.ui[a].addClass("gt-active")},toggle:function(a){"list"===a?(this.ui.list.toggleClass("gt-active"),this.ui.create.removeClass("gt-active")):"create"===a&&(this.ui.create.toggleClass("gt-active"),this.ui.list.removeClass("gt-active"))},clear:function(a){"drawers"===a?this.ui.drawers.find(".gt-tool").removeClass("gt-active"):"tools"===a?this.ui.tools.find(".gt-tool").removeClass("gt-active"):this.ui.all.removeClass("gt-active")}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e){a.Edit=d.ItemView.extend({template:b.Templates.edit,className:"gt-edit gt-panel",events:{"change .gt-geometry-type":"startDrawing","change .gt-action-selector":"toggleActions","click .gt-submit":"parseForm","click .gt-trigger-delete":"destroyModel"},ui:{actions:".gt-action",form:"form"},startDrawing:function(a){var c=e(a.target).val();b.execute("draw:clear"),b.execute("draw:enable",c)},toggleActions:function(a){var b=e(a.target).val();this.ui.actions.hide(),this.$el.find(".gt-action-"+b).show()},parseForm:function(a){a.preventDefault();var c=this.ui.form.serializeObject();if(c=b.util.removeEmptyStrings(c),c.tags){var d=c.tags;d=d.split(",");for(var e=d.length-1;e>0;e--)d[e]=d[e].trim();c.tags=d}c&&this.updateTrigger(c)},updateTrigger:function(a){var c=b.request("draw:layer");if(c instanceof L.Circle){var d=c.getLatLng();a.condition.geo={latitude:d.lat,longitude:d.lng,distance:c.getRadius()}}else a.condition.geo={geojson:c.toGeoJSON()};a.triggerId=this.model.get("triggerId"),b.vent.trigger("trigger:update",a)},destroyModel:function(a){a.preventDefault(),b.vent.trigger("trigger:destroy",this.model)}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e){a.ListItem=d.ItemView.extend({template:b.Templates.item,tagName:"li",className:"gt-result",events:{"click .gt-item-delete":"confirmDelete","click .gt-reset-delete":"resetDelete","click .gt-item-confirm-delete":"destroyModel"},ui:{deleteItem:".gt-item-delete",confirm:".gt-item-confirm-delete",reset:".gt-reset-delete"},modelEvents:{change:"modelChanged"},modelChanged:function(){this.render()},confirmDelete:function(a){a.preventDefault(),this.ui.deleteItem.addClass("gt-item-confirm-delete"),this.ui.reset.addClass("gt-reset-flyout")},resetDelete:function(a){a.preventDefault(),this.ui.deleteItem.removeClass("gt-item-confirm-delete"),this.ui.reset.removeClass("gt-reset-flyout")},destroyModel:function(a){a.preventDefault(),b.vent.trigger("trigger:destroy",this.model)}}),a.Empty=d.ItemView.extend({template:b.Templates.empty,className:"gt-list-empty"}),a.List=d.CompositeView.extend({template:b.Templates.list,className:"gt-list gt-panel",itemView:a.ListItem,itemViewContainer:".gt-results",emptyView:a.Empty,events:{"keyup .gt-search":"filter"},ui:{header:".gt-list-header",search:".gt-search input",results:".gt-results"},onShow:function(){this.headerCheck(),this.listenTo(this.collection,"change reset add remove",this.headerCheck)},headerCheck:function(){this.collection.length?this.ui.header.removeClass("gt-hide"):this.ui.header.addClass("gt-hide")},filter:function(){var a=this.ui.search.val();if(a.length){this.ui.results.addClass("gt-filtering");var b=this.ui.results.find(".gt-result"),c=this.ui.search.val().split(/\s+/),d="(?=.*"+c.join(")(?=.*")+")",f=new RegExp(d,"i");b.each(function(){var a=e(this),b=a.find(".gt-tags li"),c="";c+=a.find(".gt-item-edit span").text(),b.each(function(){c+=e(this).text()}),f.exec(c)?a.addClass("gt-list-visible"):a.removeClass("gt-list-visible")})}else this.ui.results.removeClass("gt-filtering")}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e,f){a.Shape=d.View.extend({modelEvents:{change:"render"},render:function(){return this.isClosed=!1,this.triggerMethod("before:render",this),this.triggerMethod("item:before:render",this),this.renderShape(),this.triggerMethod("render",this),this.triggerMethod("item:rendered",this),this},renderShape:function(){this.model.get("triggerId");var a=this.model.get("condition").geo;this.removeShape(),this._shape=a.geojson?b.Map.polygon(a.geojson):b.Map.circle(a),this._shape.on("click",f.bind(function(){b.router.navigate(this.model.id+"/edit",{trigger:!0})},this))},removeShape:function(){this._shape&&(b.Map.removeShape(this._shape),delete this._shape)},onClose:function(){this.removeShape()}}),a.Map=d.CollectionView.extend({id:"gt-map",itemView:a.Shape,onShow:function(){b.Map.start({el:this.el}),this.listenTo(b.vent,"trigger:edit",this.hideShape),this.listenTo(b.vent,"index trigger:new trigger:list trigger:edit",this.restore)},hideShape:function(a){var c=b.collections.triggers.get(a),d=this.children.findByModel(c);d.removeShape()},restore:function(a){this.children.each(function(b){if(!b._shape){var c=b.model.get("triggerId");a&&c===a||b.render()}})}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e){a.New=d.ItemView.extend({template:b.Templates["new"],className:"gt-new gt-panel",events:{"change .gt-geometry-type":"startDrawing","change .gt-action-selector":"toggleActions","click .gt-submit":"parseForm"},ui:{actions:".gt-action",form:"form"},onShow:function(){b.request("draw:layer")},startDrawing:function(a){var c=e(a.target).val();b.execute("draw:clear"),b.execute("draw:enable",c)},toggleActions:function(a){var b=e(a.target).val();this.ui.actions.hide(),this.$el.find(".gt-action-"+b).show()},parseForm:function(a){a.preventDefault();var c=this.ui.form.serializeObject();if(c=b.util.removeEmptyStrings(c),c.tags){var d=c.tags;d=d.split(",");for(var e=d.length-1;e>0;e--)d[e]=d[e].trim();c.tags=d}c&&this.createTrigger(c)},createTrigger:function(a){var c=b.request("draw:layer");if(c instanceof L.Circle){var d=c.getLatLng();a.condition.geo={latitude:d.lat,longitude:d.lng,distance:c.getRadius()}}else a.condition.geo={geojson:c.toGeoJSON()};b.vent.trigger("trigger:create",a)}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Notification=d.ItemView.extend({template:b.Templates.notification,className:"gt-notification",tagName:"li",events:{"click .gt-close":"destroyNotification"},render:function(){d.ItemView.prototype.render.apply(this,arguments);var a=this.model.get("type");this.$el.addClass(a),this.listenTo(b.vent,"notify:clear",this.destroyNotification)},destroyNotification:function(){this.model.destroy()}}),a.NotificationList=d.CollectionView.extend({itemView:a.Notification,className:"gt-notification-list",tagName:"ul"})});