/*! geotrigger-editor 0.0.0 2013-11-18 */
var GeotriggerEditor=new Backbone.Marionette.Application;GeotriggerEditor.addInitializer(function(a){this.Config.start(a),this.API.start(),this.regions=new this.Layouts.Main,this.addRegions({mainRegion:this.config.el}),this.mainRegion.show(this.regions)}),this.GeotriggerEditor=this.GeotriggerEditor||{},this.GeotriggerEditor.Templates=this.GeotriggerEditor.Templates||{},this.GeotriggerEditor.Templates.controls=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},'<div class="gt-drawer-controls">\n  <a href="#list" class="gt-tool gt-tool-list active gt-tooltip"><span>List</span></a>\n</div>\n<div class="gt-tool-controls">\n  <button class="gt-tool gt-tool-polygon gt-tooltip"><span>New Polygon Tool</span></button>\n  <button class="gt-tool gt-tool-radius gt-tooltip"><span>New Radius Tool</span></button>\n</div>'}),this.GeotriggerEditor.Templates.empty=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},'<div class="gt-panel-top-bar">\n  <h3 class="gt-panel-top-bar-left">List <span class="gt-trigger-count"></span></h3>\n  <a href="#" class="gt-panel-top-bar-button gt-close-drawer"></a>\n</div>\n\n<div class="gt-panel-no-triggers">\n  <h5>This application doesn\'t have any Geotrigger rules yet.</h5>\n</div>\n\n<ul class="gt-tool-descriptions">\n  <li class="gt-tool-description">\n    <span class="gt-icon gt-icon-create"></span>\n    <h5>Create a New Trigger</h5>\n    <p>Create a new Geotrigger rule by first using one of the drawing tools, then defining its properties in the form that appears.</p>\n  </li>\n\n  <li class="gt-tool-description">\n    <span class="gt-icon gt-icon-polygon"></span>\n    <h5>Using the Polygon Tool</h5>\n    <p>Click on the map to create each point of a polygon. Click on the first point you created to close the shape.</p>\n  </li>\n\n  <li class="gt-tool-description">\n    <span class="gt-icon gt-icon-radius"></span>\n    <h5>Using the Radius Tool</h5>\n    <p>Click a point on the map, then hold and drag to define a radius around that point.</p>\n  </li>\n</ul>\n'}),this.GeotriggerEditor.Templates["form/actions/callbackUrl"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-action=\"callbackUrl\" class='gt-property'>\n  <div class=\"gt-property-header\">\n    notify this URL\n    <a class=\"gt-remove-action gt-delete-icon\"></a>\n  </div>\n\n  <div class=\"gt-property-item\">\n    <input class='gt-input-fill' type='text' name='action[callbackUrl]' placeholder='http://' value='"+i((f=b&&b.action,f=null==f||f===!1?f:f.callbackUrl,typeof f===h?f.apply(b):f))+"'>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/data"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='data' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][data]'>\n    <span class='gt-label-left'>some data:</span>\n  </label>\n\n  <div class=\"gt-notification-center\">\n    <textarea class='gt-input' name='action[notification][data]' placeholder='{ \"your\": \"data\" }'>"+i((f=b&&b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.data,typeof f===h?f.apply(b):f))+"</textarea>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/icon"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='icon' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][icon]'>\n    <span class='gt-label-left'>an icon:</span>\n  </label>\n\n  <div class='gt-notification-center'>\n    <input class='gt-input' type='text' name='action[notification][icon]' placeholder='icon' value='"+i((f=b&&b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.icon,typeof f===h?f.apply(b):f))+"'>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/index"]=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},'<div data-action="notification" class="gt-property">\n  <div class="gt-property-header">\n    send a notification to the device with..\n    <a class="gt-remove-action gt-delete-icon"></a>\n  </div>\n\n  <div class="gt-notification-actions"></div>\n\n  <div class="gt-property-item gt-btn-group">\n    <button data-notification="text" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; a message</button>\n    <button data-notification="url" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; a URL</button>\n    <button data-notification="data" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; some data</button>\n    <button data-notification="icon" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; an icon</button>\n    <button data-notification="sound" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; a sound</button>\n  </div>\n</div>'}),this.GeotriggerEditor.Templates["form/actions/notification/sound"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='sound' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][sound]'>\n    <span class='gt-label-left'>a sound:</span>\n  </label>\n\n  <div class='gt-notification-center'>\n    <input class='gt-input' type='text' name='action[notification][sound]' placeholder='sound' value='"+i((f=b&&b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.sound,typeof f===h?f.apply(b):f))+"'>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/text"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='text' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][text]'>\n    <span class='gt-label-left'>a message:</span>\n  </label>\n\n  <div class='gt-notification-center'>\n    <textarea class='gt-action-message-box' name='action[notification][text]' placeholder='message'>"+i((f=b&&b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.text,typeof f===h?f.apply(b):f))+"</textarea>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/url"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='url' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][url]'>\n    <span class='gt-label-left'>a URL:</span>\n  </label>\n\n  <div class='gt-notification-center'>\n    <input class='gt-input' type='text' name='action[notification][url]' placeholder='http://' value='"+i((f=b&&b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.url,typeof f===h?f.apply(b):f))+"'>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/trackingProfile"]=Handlebars.template(function(a,b,c,d,e){function f(){return'\n      <option value="fine">[3] fine</option>\n      <option value="adaptive">[2] adaptive</option>\n      <option value="rough">[1] rough</option>\n      <option value="off">[0] off</option>\n      '}this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var g,h,i,j="",k=this,l=c.helperMissing;return j+='<div data-action="trackingProfile" class="gt-property">\n  <div class="gt-property-header">\n    change the device\'s tracking profile\n    <a class="gt-remove-action gt-delete-icon"></a>\n  </div>\n\n  <div class="gt-property-item">\n    <select class="gt-select-full" name="action[trackingProfile]">\n      ',i={hash:{},inverse:k.noop,fn:k.program(1,f,e),data:e},g=c.select||b&&b.select,h=g?g.call(b,(g=b&&b.action,null==g||g===!1?g:g.trackingProfile),i):l.call(b,"select",(g=b&&b.action,null==g||g===!1?g:g.trackingProfile),i),(h||0===h)&&(j+=h),j+="\n    </select>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/index"]=Handlebars.template(function(a,b,c,d,e){function f(){return"Edit"}function g(){return"Create"}function h(){return"\n              <option value='enter'>enters</option>\n              <option value='leave'>leaves</option>\n              "}function i(a,b){var d,e,f="";return f+='\n            <span class="gt-shape-indicator">a ',e={hash:{},data:b},f+=s((d=c.shape||a&&a.shape,d?d.call(a,a&&a.condition,e):r.call(a,"shape",a&&a.condition,e)))+"</span>\n            "}function j(){return'\n            <span class="gt-shape-indicator">a...</span>\n            '}function k(){return" gt-hide"}function l(){return"\n      <button class='gt-button gt-button-blue gt-submit'>Update</button>\n      <ul class='gt-edit-controls'>\n        <li>\n          <a class='gt-reset-delete' href='#'>&#x2716;</a>\n        </li>\n        <li>\n          <button class='gt-item-delete gt-button-delete'></button>\n        </li>\n      </ul>\n      "}function m(){return"\n      <button class='gt-button gt-button-blue gt-submit'>Save</button>\n      "}this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var n,o,p,q="",r=c.helperMissing,s=this.escapeExpression,t=this,u="function";return q+="<div class='gt-panel-top-bar'>\n  <a href='#list' class='gt-panel-top-bar-button gt-back-to-list'></a>\n  <h3>",n=c["if"].call(b,b&&b.triggerId,{hash:{},inverse:t.program(3,g,e),fn:t.program(1,f,e),data:e}),(n||0===n)&&(q+=n),q+="</h3>\n  <a href='#' class='gt-panel-top-bar-button gt-close-drawer'></a>\n</div>\n\n<div class='gt-panel-content'>\n  <form class='gt-form gt-form-edit'>\n\n    <section class='gt-form-section gt-conditions'>\n      <div class=\"gt-property\">\n        <div class=\"gt-property-header\">When a device tagged..</div>\n\n        <div class=\"gt-property-item\">\n          <textarea class='gt-input' name='tags' placeholder='enter tags'>",p={hash:{},data:e},q+=s((n=c.tagList||b&&b.tagList,n?n.call(b,b&&b.tags,p):r.call(b,"tagList",b&&b.tags,p)))+"</textarea>\n        </div>\n\n        <div class=\"gt-property-item\">\n            <select name='condition[direction]' class='gt-direction'>\n              ",p={hash:{},inverse:t.noop,fn:t.program(5,h,e),data:e},n=c.select||b&&b.select,o=n?n.call(b,(n=b&&b.condition,null==n||n===!1?n:n.direction),p):r.call(b,"select",(n=b&&b.condition,null==n||n===!1?n:n.direction),p),(o||0===o)&&(q+=o),q+="\n            </select>\n\n            ",o=c["if"].call(b,b&&b.condition,{hash:{},inverse:t.program(9,j,e),fn:t.program(7,i,e),data:e}),(o||0===o)&&(q+=o),q+='\n            <input name="geometry-type" type="hidden" value="',p={hash:{},data:e},q+=s((n=c.shape||b&&b.shape,n?n.call(b,b&&b.condition,p):r.call(b,"shape",b&&b.condition,p)))+'">\n        </div>\n      </div>\n    </section>\n\n    <section class="gt-form-section gt-actions"></section>\n\n    <section class="gt-form-section gt-action-toggles">\n      <button data-action="notification" class="gt-button gt-button-light-gray gt-button-small gt-add-action">&#043; send a notification</button>\n      <button data-action="callbackUrl" class="gt-button gt-button-light-gray gt-button-small gt-add-action">&#043; post to a callback URL</button>\n      <button data-action="trackingProfile" class="gt-button gt-button-light-gray gt-button-small gt-add-action">&#043; change the tracking profile</button>\n    </section>\n\n    <section class="gt-form-section gt-title-wrapper">\n      <button class="gt-button gt-button-light-gray gt-button-small gt-add-title',o=c["if"].call(b,(n=b&&b.properties,null==n||n===!1?n:n.title),{hash:{},inverse:t.noop,fn:t.program(11,k,e),data:e}),(o||0===o)&&(q+=o),q+="\">&#043; add a title</button>\n\n      <div class='gt-title gt-property",o=c.unless.call(b,(n=b&&b.properties,null==n||n===!1?n:n.title),{hash:{},inverse:t.noop,fn:t.program(11,k,e),data:e}),(o||0===o)&&(q+=o),q+="'>\n        <div class=\"gt-property-header\">\n          Title\n          <a class=\"gt-remove-title gt-delete-icon\"></a>\n        </div>\n\n        <div class=\"gt-property-item\">\n          <input class='gt-input-fill' type='text' name='properties[title]' placeholder='Geotrigger Title' value='"+s((n=b&&b.properties,n=null==n||n===!1?n:n.title,typeof n===u?n.apply(b):n))+"'>\n        </div>\n      </div>\n    </section>\n\n    <section class='gt-form-section gt-submit-wrapper'>\n      ",o=c["if"].call(b,b&&b.triggerId,{hash:{},inverse:t.program(15,m,e),fn:t.program(13,l,e),data:e}),(o||0===o)&&(q+=o),q+="\n    </section>\n  </form>\n</div>"}),this.GeotriggerEditor.Templates.item=Handlebars.template(function(a,b,c,d,e){function f(a){var b,c="";return c+="\n      <span>"+o((b=a&&a.properties,b=null==b||b===!1?b:b.title,typeof b===n?b.apply(a):b))+"</span>\n    "}function g(a,b){var d,e,f="";return f+="\n      <span>",e={hash:{},data:b},f+=o((d=c.defaultTitle||a&&a.defaultTitle,d?d.call(a,a&&a.condition,e):p.call(a,"defaultTitle",a&&a.condition,e)))+"</span>\n    "}function h(a){var b;return o((b=a&&a.properties,b=null==b||b===!1?b:b.title,typeof b===n?b.apply(a):b))}function i(a,b){var d,e;return e={hash:{},data:b},o((d=c.defaultTitle||a&&a.defaultTitle,d?d.call(a,a&&a.condition,e):p.call(a,"defaultTitle",a&&a.condition,e)))}this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var j,k,l,m="",n="function",o=this.escapeExpression,p=c.helperMissing,q=this;return m+="<span class='gt-item-edit gt-icon ",l={hash:{},data:e},m+=o((j=c.actionIcon||b&&b.actionIcon,j?j.call(b,(j=b&&b.condition,null==j||j===!1?j:j.direction),(j=b&&b.condition,null==j||j===!1?j:j.geo),l):p.call(b,"actionIcon",(j=b&&b.condition,null==j||j===!1?j:j.direction),(j=b&&b.condition,null==j||j===!1?j:j.geo),l)))+" gt-icon-polygon'></span>\n<h5>\n  <a class='gt-item-edit' href='#edit/",(k=c.triggerId)?k=k.call(b,{hash:{},data:e}):(k=b&&b.triggerId,k=typeof k===n?k.call(b,{hash:{},data:e}):k),m+=o(k)+"'>\n    ",k=c["if"].call(b,(j=b&&b.properties,null==j||j===!1?j:j.title),{hash:{},inverse:q.program(3,g,e),fn:q.program(1,f,e),data:e}),(k||0===k)&&(m+=k),m+="\n  </a>\n</h5>\n<div class='gt-item-toolbar'>\n  <a class='gt-edit-icon' href='#edit/",(k=c.triggerId)?k=k.call(b,{hash:{},data:e}):(k=b&&b.triggerId,k=typeof k===n?k.call(b,{hash:{},data:e}):k),m+=o(k)+"'></a>\n  <a class='gt-delete-icon' href='#'></a>\n</div>\n<div class='gt-tags'>\n  <strong>Tags</strong><span>:</span> ",l={hash:{},data:e},j=c.tagLinks||b&&b.tagLinks,k=j?j.call(b,b&&b.tags,l):p.call(b,"tagLinks",b&&b.tags,l),(k||0===k)&&(m+=k),m+="\n</div>\n<div class='gt-id'>\n  <strong>ID</strong><span>:</span> ",(k=c.triggerId)?k=k.call(b,{hash:{},data:e}):(k=b&&b.triggerId,k=typeof k===n?k.call(b,{hash:{},data:e}):k),m+=o(k)+"\n</div>\n<div class='gt-list-delete'>\n  <h5>Delete ",k=c["if"].call(b,(j=b&&b.properties,null==j||j===!1?j:j.title),{hash:{},inverse:q.program(7,i,e),fn:q.program(5,h,e),data:e}),(k||0===k)&&(m+=k),m+="?</h5>\n  <button class='gt-confirm-delete gt-button-small gt-button-delete'>Delete</button>\n  <button class='gt-cancel-delete gt-button-small gt-button gt-button-gray'>Cancel</button>\n</div>"}),this.GeotriggerEditor.Templates.list=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+='<div class="gt-list-header gt-hide">\n  <div class="gt-panel-top-bar">\n    <h3 class="gt-panel-top-bar-left">List <span class="gt-trigger-count">(',(f=c.count)?f=f.call(b,{hash:{},data:e}):(f=b&&b.count,f=typeof f===h?f.call(b,{hash:{},data:e}):f),g+=i(f)+')</span></h3>\n    <a href="#" class="gt-panel-top-bar-button gt-close-drawer"></a>\n  </div>\n  <div class="gt-search">\n    <input type="search" placeholder="Search"><a href="#list" class="gt-icon-clear"></a>\n  </div>\n</div>\n<ul class="gt-results"></ul>'}),this.GeotriggerEditor.Templates.main=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},"<div id='gt-controls-region'></div>\n<div id='gt-content'>\n  <div id='gt-drawer-region'></div>\n  <div id='gt-map-region'></div>\n  <div id='gt-notes-region'></div>\n</div>\n"}),this.GeotriggerEditor.Templates.notification=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<button class='gt-close'>&times;</button> ",(f=c.message)?f=f.call(b,{hash:{},data:e}):(f=b&&b.message,f=typeof f===h?f.call(b,{hash:{},data:e}):f),g+=i(f)}),function(a,b,c){b.registerHelper("select",function(a,b){var d=c("<select>");return d.html(b.fn(this)),d.find('option[value="'+a+'"]').attr("selected","selected"),d.html()}),b.registerHelper("selectShape",function(a,b){var d=c("<select>");d.html(b.fn(this));var e;return a&&a.geo&&(e=a.geo.geojson?"polygon":"radius"),d.find('option[value="'+e+'"]').attr("selected","selected"),d.html()}),b.registerHelper("shape",function(a){var b="";return a&&a.geo&&(b=a.geo.geojson?"polygon":"radius"),b}),b.registerHelper("actionIcon",function(a,b){var c="";return"enter"===a?c+="gt-icon-enter ":"leave"===a&&(c+="gt-icon-exit "),b.geojson&&(c+="gt-icon-polygon "),b.distance&&(c+="gt-icon-radius "),c}),b.registerHelper("defaultTitle",function(a){var b=""+a.direction;if(a.geo.distance)b+=" "+a.geo.distance+" meter radius";else if(a.geo.geojson&&a.geo.geojson.coordinates){var c=a.geo.geojson.coordinates[0].length-1;b+=" "+c+" sided polygon"}return b=b.charAt(0).toUpperCase()+b.slice(1)}),b.registerHelper("unlessDefaultTag",function(a,b){return 0!==a.indexOf("trigger:")?b.fn(this):b.inverse(this)}),b.registerHelper("tagList",function(a){if(a&&a.length){for(var b=[],c=0;c<a.length;c++)0!==a[c].indexOf("trigger:")&&b.push(a[c]);return b.join(", ")}return""}),b.registerHelper("tagLinks",function(a){if(a&&a.length){if(1===a.length&&0===a[0].indexOf("trigger:"))return"<strong>none</strong>";for(var b=[],c=0;c<a.length;c++)0!==a[c].indexOf("trigger:")&&b.push('<a href="#list/'+encodeURIComponent(a[c]).replace(/%20/g,"+")+'">'+a[c]+"</a>");return b.join(", ")}return"<strong>none</strong>"})}(GeotriggerEditor,Handlebars,$),function(a){return a.fn.serializeObject=function(){var b,c,d,e=this;return b={},d={},c={validate:/^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,key:/[a-zA-Z0-9_]+|(?=\[\])/g,push:/^$/,fixed:/^\d+$/,named:/^[a-zA-Z0-9_]+$/},this.build=function(a,b,c){return a[b]=c,a},this.push_counter=function(a){return void 0===d[a]&&(d[a]=0),d[a]++},a.each(a(this).serializeArray(),function(d,f){var g,h,i,j,k;if(c.validate.test(f.name)){for(h=f.name.match(c.key),i=f.value,k=f.name;void 0!==(g=h.pop());)c.push.test(g)?(j=new RegExp("\\["+g+"\\]$"),k=k.replace(j,""),i=e.build([],e.push_counter(k),i)):c.fixed.test(g)?i=e.build([],g,i):c.named.test(g)&&(i=e.build({},g,i));return b=a.extend(!0,b,i)}}),b}}(jQuery),L.Tooltip.prototype.updatePosition=function(a){var b=this._map.latLngToLayerPoint(a);return L.DomUtil.setPosition(this._container,b),this._container.style.display="inline-block",this},L.Polygon.prototype.getCenter=function(){for(var a,b,c,d=this._latlngs,e=d[0],f=0,g=0,h=0,i=d.length,j=0,k=i-1;i>j;k=j++)a=d[j],b=d[k],c=(a.lat-e.lat)*(b.lng-e.lng)-(b.lat-e.lat)*(a.lng-e.lng),f+=c,g+=(a.lat+b.lat-2*e.lat)*c,h+=(a.lng+b.lng-2*e.lng)*c;return c=3*f,new L.LatLng(g/c+e.lat,h/c+e.lng)},function(a){"use strict";for(var b,c,d={},e=function(){},f="memory".split(","),g="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,time,timeEnd,trace,warn".split(",");b=f.pop();)a[b]=a[b]||d;for(;c=g.pop();)a[c]=a[c]||e}(window.console=window.console||{}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),("undefined"!=typeof module&&function(a){module.exports=a()}||"function"==typeof define&&function(a){define("underscoreDeepExtend",a)}||function(a){window.underscoreDeepExtend=a()})(function(){return function(a){return function(b){var c=/#{\s*?_\s*?}/,d=Array.prototype.slice,e=Object.prototype.hasOwnProperty;return a.each(d.call(arguments,1),function(d){for(var f in d)if(e.call(d,f))if(a.isUndefined(b[f]))b[f]=d[f];else if(a.isString(d[f])&&c.test(d[f]))a.isString(b[f])&&(b[f]=d[f].replace(c,b[f]));else if(a.isArray(b[f])||a.isArray(d[f])){if(!a.isArray(b[f])||!a.isArray(d[f]))throw"Error: Trying to combine an array with a non-array ("+f+")";b[f]=a.reject(a.deepExtend(b[f],d[f]),function(b){return a.isNull(b)})}else if(a.isObject(b[f])||a.isObject(d[f])){if(!a.isObject(b[f])||!a.isObject(d[f]))throw"Error: Trying to combine an object with a non-object ("+f+")";b[f]=a.deepExtend(b[f],d[f])}else b[f]=d[f]}),b}}}),function(){_.mixin({deepExtend:underscoreDeepExtend(_)})}(),GeotriggerEditor.module("API",function(a,b){function c(){if(!b.config.session||!b.config.session.clientId||!b.config.session.clientSecret)throw new Error("GeotriggerEditor requires a `session` object with `clientId` and `clientSecret` properties");this.session=new Geotriggers.Session(b.config.session)}this.startWithParent=!1,a.addInitializer(c)}),GeotriggerEditor.module("Config",function(a,b,c,d,e,f){function g(a){b.config=f.deepExtend(k,a)}this.startWithParent=!1;var h={showArea:!1,shapeOptions:{stroke:!0,color:"#00b1dc",weight:2,opacity:.8,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},i={showArea:!1,shapeOptions:{color:"#00dcb1",opacity:.8,dashArray:"10, 10",weight:2,fill:!0,fillOpacity:.2}},j={showArea:!1,shapeOptions:{color:"#00dcb1",opacity:.8,stroke:!0,weight:2,fill:!0,fillOpacity:.2}},k={el:"#gt-editor",session:{},map:{basemap:"Streets",center:[0,0],zoom:2,options:{}},fitOnLoad:!0,imagePath:"/images",sharedOptions:h,editOptions:i,highlightOptions:j};a.addInitializer(g)}),GeotriggerEditor.module("util",function(a){a.removeEmptyStrings=function(b){for(var c in b){if(""===b[c]&&delete b[c],b[c]instanceof Array){for(var d=!0,e=0;e<b[c].length;e++)if(""!==b[c][e]){d=!1;break}d&&delete b[c]}if("object"==typeof b[c]){b[c]=a.removeEmptyStrings(b[c]);var f=!1;for(var g in b[c]){f=!0;break}f||delete b[c]}}return b},a.isObject=function(a){return"[object Object]"===Object.prototype.toString.call(a)},a.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}}),GeotriggerEditor.module("Map.Draw",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_tools:{polygon:null,radius:null},_setup:function(){this._tools.polygon=new L.Draw.Polygon(b.map,b.config.editOptions),this._tools.radius=new L.Draw.Circle(b.map,b.config.editOptions),this._eventBindings()},_eventBindings:function(){b.vent.on("draw:new",this.editLayer,this),b.vent.on("index trigger:list trigger:edit",this.clear,this),b.vent.on("trigger:new:ready",this.panToNewTrigger,this),b.vent.on("trigger:edit",this.panToTrigger,this),b.vent.on("draw:enable",this.enableTool,this),b.vent.on("draw:disable",this.disableTool,this),b.map.on("draw:created",this.broadcastLayer),b.reqres.setHandler("draw:layer",this.getEditLayer,this),b.commands.setHandler("draw:clear",this.clear,this)},panToNewTrigger:function(){var a=b.request("draw:layer");a&&b.Map.panToLayer(a)},panToTrigger:function(a){var c=this.newShape(a);this.editLayer(c),b.Map.panToLayer(c)},broadcastLayer:function(a){var c=(a.layerType,a.layer);b.vent.trigger("draw:new",c)},getEditLayer:function(){return b.Map.Layers.edit.getLayers()[0]},newShape:function(a){var c,d=b.collections.triggers.get(a),e=(d.get("triggerId"),d.get("condition").geo);return c=e.geojson?b.Map.polygon(e.geojson,b.config.editOptions.shapeOptions,!1).getLayers()[0]:b.Map.circle(e,b.config.editOptions.shapeOptions,!1)},editLayer:function(a){this.clear(),a.editing.enable(),b.Map.Layers.edit.addLayer(a)},clear:function(){b.Map.Layers.edit.clearLayers()},enableTool:function(a){this.disableTool(),this._tools[a].enable()},disableTool:function(a){for(var b in this._tools)("undefined"==typeof a||b===a)&&this._tools[b].disable()}}),a.addInitializer(function(){this._setup()})}),GeotriggerEditor.module("Editor",function(a,b,c,d,e,f){var g=d.AppRouter.extend({appRoutes:{"":"index",list:"list","list/:term":"list","new":"create","edit/:id":"edit","*notfound":"notFound"}}),h=function(){};f.extend(h.prototype,{start:function(){this.setup(),b.vent.trigger("notify","Getting triggers"),b.collections.triggers.fetch({fetch:!0,reset:!0,success:function(a,d){b.vent.trigger("notify:clear"),c.history.start(),d&&0===d.length?b.router.navigate("list",{trigger:!0}):b.config.fitOnLoad&&!c.history.fragment.match("edit")&&b.execute("map:fit")}}),b.vent.on("draw:new",function(){"new"===c.history.fragment||c.history.fragment.match("edit")||b.router.navigate("new",{trigger:!0})},this),b.vent.on("trigger:create",this.createTrigger,this),b.vent.on("trigger:update",this.updateTrigger,this),b.vent.on("trigger:destroy",this.deleteTrigger,this)},setup:function(){this.setupMap(),this.setupDrawer(),this.setupControls(),this.setupNotifications()},setupMap:function(){var a=new b.Views.Map({collection:b.collections.triggers});b.regions.map.show(a)},setupDrawer:function(){var a=b.regions.drawer,c=b.mainRegion.$el.find("#gt-content");a.on("show",function(){c.addClass("gt-active")}),a.on("close",function(){c.removeClass("gt-active")})},setupControls:function(){var a=new b.Views.Controls;b.regions.controls.show(a)},setupNotifications:function(){var a=new b.Views.NotificationList({collection:b.collections.notifications});b.regions.notes.show(a),b.vent.on("notify",function(a){"string"==typeof a&&(a={type:"info",message:a});var c=new b.Models.Notification(a);b.collections.notifications.add(c)},this)},index:function(){b.vent.trigger("index"),b.regions.drawer.close()},list:function(a){if(b.regions.drawer.$el&&b.regions.drawer.$el.has(".gt-list").length)a||b.vent.trigger("trigger:list:reset");else{b.vent.trigger("trigger:list");var d=new c.Model({count:b.collections.triggers.length}),e=new b.Views.List({model:d,collection:b.collections.triggers});b.regions.drawer.show(e)}a&&(a=decodeURIComponent(a.replace(/\+/g,"%20")),b.vent.trigger("trigger:list:search",a))},create:function(){b.vent.trigger("trigger:new");var a=new b.Views.Form;b.regions.drawer.show(a),b.vent.trigger("trigger:new:ready")},edit:function(a){var c=this.getTrigger(a);if(c){var d=new b.Views.Form({model:c});b.regions.drawer.show(d),b.vent.trigger("trigger:edit",a),d.parseShape()}else b.vent.trigger("notify",{type:"error",message:"That trigger doesn't exist!"})},notFound:function(){b.vent.trigger("notify",{type:"error",message:"Couldn't find page: \""+c.history.fragment+'"'})},createTrigger:function(a){b.execute("draw:clear"),b.collections.triggers.create(a,{success:function(){b.router.navigate("list",{trigger:!0})}})},getTrigger:function(a){var c=b.collections.triggers.get(a);return c},updateTrigger:function(a){b.collections.triggers.once("change",function(){b.router.navigate("list",{trigger:!0})});var c=b.collections.triggers.get(a.triggerId);c.set(a),c.save()},deleteTrigger:function(a){b.collections.triggers.once("remove",function(){c.history.fragment.match("edit")&&b.router.navigate("list",{trigger:!0})}),a.destroy()}}),a.addInitializer(function(){b.collections=b.collections||{},b.collections.triggers=new b.Models.Triggers,b.collections.notifications=new b.Models.Notifications;var a=new h;b.router=new g({controller:a}),a.start()})}),GeotriggerEditor.module("Map.Layers",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_setup:function(){this.main=new L.FeatureGroup,b.map.addLayer(this.main),this.edit=new L.FeatureGroup,b.map.addLayer(this.edit)}}),a.addInitializer(function(){this._setup()})}),GeotriggerEditor.module("Map",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_setup:function(a){if(b.config.session.proxy&&(L.esri.get=L.esri.RequestHandlers.JSONP),b.map=this.map=L.map(a.el).setView(b.config.map.center,b.config.map.zoom),this.map.zoomControl.setPosition("topright"),b.util.isArray(b.config.map.basemaps))for(var c=0;c<b.config.map.basemaps.length;c++)L.esri.basemapLayer(b.config.map.basemaps[c],b.config.map.options).addTo(b.map);else L.esri.basemapLayer(b.config.map.basemap,b.config.map.options).addTo(b.map);this.Layers.start(),this._eventBindings()},_eventBindings:function(){b.commands.setHandler("map:fit",f.bind(function(){if(0!==this.Layers.main.getLayers().length){var a=this.Layers.main.getBounds(),b=this.getDrawerWidth();this.map.fitBounds(a,{animate:!1,paddingTopLeft:[b,0]})}},this))},getDrawerWidth:function(){var a=b.mainRegion.$el.find("#gt-content"),c=a.find("#gt-drawer-region");return a.hasClass("gt-active")?c.width():0},panToLayer:function(a){var b;a.getLatLng?b=a.getLatLng():a.getCenter&&(b=a.getCenter());var c=this.getDrawerWidth();if(c){var d=this.map.project(b);d.x=d.x-c/2,b=this.map.unproject(d)}b&&this.map.panTo(b,{animate:!0})},removeShape:function(a){this.map.removeLayer(a)},focusShape:function(a){a.setStyle(b.config.highlightOptions.shapeOptions)},unfocusShape:function(a){a.setStyle(b.config.sharedOptions.shapeOptions)},polygon:function(a,c,d){c=c||b.config.sharedOptions.shapeOptions;var e=new L.GeoJSON(a,{style:function(){return c}});return d!==!1&&this.Layers.main.addLayer(e),e},circle:function(a,c,d){c=c||b.config.sharedOptions.shapeOptions;var e=L.circle([a.latitude,a.longitude],a.distance,c);return d!==!1&&this.Layers.main.addLayer(e),e}}),a.addInitializer(function(a){this._setup(a),this.Draw.start()})}),GeotriggerEditor.module("Models",function(a,b,c){a.Notification=c.Model.extend({defaults:{type:"info",message:"everything's fine"}}),a.Notifications=c.Collection.extend({model:a.Notification})}),GeotriggerEditor.module("Models",function(a,b,c,d,e,f){function g(a){var b="Error creating trigger",c=JSON.stringify(a);return null!==c.match("Coordinate values are out of range")&&(b="Coordinate values are out of range"),null!==c.match("no triggers found")&&(b="Deleted triggers can't be updated"),null!==c.match("Error performing intersection")&&(b="Polygons can't intersect themselves"),null!==c.match("message:Not a valid parameter for this request")&&(b="Notifications must have a valid message"),b}a.Trigger=c.Model.extend({idAttribute:"triggerId",sync:function(a,c,d){var e,h=this.get("triggerId"),i=f.bind(function(c,e){c?(b.vent.trigger("notify",{type:"error",message:g(c)}),d&&d.error&&d.error("Record Not Found")):("read"!==a&&b.vent.trigger("notify",{message:"Trigger "+a+"d successfully",timeout:3500}),d&&d.success&&d.success(e))},this);switch(a){case"read":b.API.session.request("trigger/list",{triggerIds:[h]},i);break;case"create":e={properties:this.get("properties"),condition:this.get("condition"),action:this.get("action"),setTags:this.get("tags")},b.API.session.request("trigger/create",e,i);break;case"update":e={properties:this.get("properties"),triggerIds:h,condition:this.get("condition"),action:this.get("action"),setTags:this.get("tags")},b.API.session.request("trigger/update",e,i);
break;case"delete":b.API.session.request("trigger/delete",{triggerIds:h},i);break;default:throw new Error("Unsupported method: "+a)}},parse:function(a){return a.triggers?a.triggers:a}}),a.Triggers=c.Collection.extend({model:a.Trigger,fetch:function(a){var c=f.bind(function(b,c){a&&a.reset?this.reset(this.parse(c)):this.set(this.parse(c)),a&&a.success&&a.success(this,this.parse(c),a)},this);b.API.session.request("trigger/list",c)},parse:function(a){return a.triggers}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Controls=d.ItemView.extend({template:b.Templates.controls,className:"gt-control-group",events:{"click .gt-tool-list":"toggleList","click .gt-tool-create":"toggleNew","click .gt-tool-polygon":"togglePolygon","click .gt-tool-radius":"toggleRadius"},ui:{drawers:".gt-drawer-controls",tools:".gt-tool-controls",list:".gt-drawer-controls .gt-tool-list",create:".gt-drawer-controls .gt-tool-create",polygon:".gt-tool-controls .gt-tool-polygon",radius:".gt-tool-controls .gt-tool-radius",all:".gt-tool"},onRender:function(){this.listenTo(b.router,"route",this.handleStateChange),this.listenTo(b.vent,"draw:new",this.disableTool),this.listenTo(b.vent,"draw:enable",function(a){this.activate(a)}),this.listenTo(b.vent,"draw:disable",function(){this.ui.tools.find(".gt-tool").removeClass("gt-active")})},handleStateChange:function(a){switch(this.clear("drawers"),a){case"new":this.activate("list");break;case"edit":this.activate("list");break;case"list":this.activate("list")}},toggleList:function(a){this.ui.list.hasClass("gt-active")&&(a.preventDefault(),b.router.navigate("",{trigger:!0}))},toggleNew:function(a){this.ui.create.hasClass("gt-active")&&(a.preventDefault(),b.router.navigate("",{trigger:!0}))},togglePolygon:function(){this.ui.polygon.hasClass("gt-active")?this.disableTool("polygon"):this.enableTool("polygon")},toggleRadius:function(){this.ui.radius.hasClass("gt-active")?this.disableTool("radius"):this.enableTool("radius")},enableTool:function(a){this.disableTool(),b.vent.trigger("draw:enable",a)},disableTool:function(a){b.vent.trigger("draw:disable",a)},activate:function(a){this.ui[a].addClass("gt-active")},toggle:function(a){"list"===a?(this.ui.list.toggleClass("gt-active"),this.ui.create.removeClass("gt-active")):"create"===a&&(this.ui.create.toggleClass("gt-active"),this.ui.list.removeClass("gt-active"))},clear:function(a){"drawers"===a?this.ui.drawers.find(".gt-tool").removeClass("gt-active"):"tools"===a?this.ui.tools.find(".gt-tool").removeClass("gt-active"):this.ui.all.removeClass("gt-active")}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e){a.Form=d.ItemView.extend({template:b.Templates["form/index"],className:"gt-panel",events:{"click .gt-add-title":"addTitle","click .gt-remove-title":"removeTitle","click .gt-add-action":"addAction","click .gt-remove-action":"removeAction","click .gt-add-notification":"addNotification","click .gt-remove-notification":"removeNotification","click .gt-submit":"parseForm","click .gt-item-delete":"confirmDelete","click .gt-reset-delete":"resetDelete","click .gt-item-confirm-delete":"destroyModel"},ui:{actions:".gt-actions",addAction:".gt-add-action",form:"form",deleteItem:".gt-item-delete",confirm:".gt-item-confirm-delete",reset:".gt-reset-delete"},onShow:function(){this.model?this.buildEditForm():this.buildNewForm(),this.listenTo(b.vent,"draw:new",this.parseShape)},buildNewForm:function(){var a=this.serializeData(),c="",d="";this.parseShape(),c=b.Templates["form/actions/notification/index"](a),d=b.Templates["form/actions/notification/text"](a),this.ui.actions.html(c),this.ui.actions.find(".gt-notification-actions").html(d),this.ui.form.find('.gt-add-action[data-action="notification"]').hide(),this.ui.form.find('.gt-add-notification[data-notification="text"]').hide()},buildEditForm:function(){var a,c=this.model.get("action"),d=this.serializeData(),e="",f="";if("undefined"!=typeof c.notification){e+=b.Templates["form/actions/notification/index"](d),this.ui.form.find('.gt-add-action[data-action="notification"]').hide();for(a in c.notification)"undefined"!=typeof c.notification[a]&&(f+=b.Templates["form/actions/notification/"+a](d))}if("undefined"!=typeof c.callbackUrl&&(e+=b.Templates["form/actions/callbackUrl"](d),this.ui.form.find('.gt-add-action[data-action="callbackUrl"]').hide()),"undefined"!=typeof c.trackingProfile&&(e+=b.Templates["form/actions/trackingProfile"](d),this.ui.form.find('.gt-add-action[data-action="trackingProfile"]').hide()),this.ui.actions.html(e),""!==f){this.ui.actions.find(".gt-notification-actions").html(f);for(a in c.notification)if("undefined"!=typeof c.notification[a]){var g=this.ui.form.find('.gt-add-notification[data-notification="'+a+'"]');g.hide()}}},addTitle:function(a){a&&a.preventDefault&&a.preventDefault(),e(a.target).addClass("gt-hide"),this.$el.find(".gt-title").removeClass("gt-hide")},removeTitle:function(a){a&&a.preventDefault&&a.preventDefault(),e(a.target).closest(".gt-property").addClass("gt-hide"),this.ui.form.find('input[name="properties[title]"]').val(""),this.ui.form.find(".gt-add-title").removeClass("gt-hide")},addAction:function(a){var c,d,f,g;"object"==typeof a&&a.preventDefault?(a.preventDefault(),c=e(a.target),d=c.data("action")):"string"==typeof a&&(d=a,c=this.ui.form.find(".gt-add-action[data-action='"+d+"']")),"notification"===d?(f=b.Templates["form/actions/notification/index"]({}),g=b.Templates["form/actions/notification/text"]({}),this.ui.actions.append(f),this.ui.actions.find(".gt-notification-actions").html(g),this.ui.form.find('.gt-add-notification[data-notification="text"]').hide()):(f=b.Templates["form/actions/"+d]({}),this.ui.actions.append(f)),c.hide()},removeAction:function(a){var b,c;"object"==typeof a&&a.preventDefault?(a.preventDefault(),b=e(a.target).closest(".gt-property"),c=b.data("action")):"string"==typeof a&&(c=a,b=this.ui.form.find(".gt-property[data-action='"+c+"']")),b.remove(),this.ui.form.find('.gt-add-action[data-action="'+c+'"]').show()},addNotification:function(a){a&&a.preventDefault&&a.preventDefault();var c=e(a.target),d=c.data("notification"),f=b.Templates["form/actions/notification/"+d]({});this.ui.actions.find(".gt-notification-actions").append(f),c.hide()},removeNotification:function(a){a&&a.preventDefault&&a.preventDefault();var b=e(a.target).closest(".gt-notification-action"),c=b.data("notification");b.remove(),this.ui.form.find('.gt-add-notification[data-notification="'+c+'"]').show()},parseShape:function(){var a,c,d,e=b.request("draw:layer"),f=this.ui.form.find('[name="condition[direction]"]'),g=this.ui.form.find('[name="geometry-type"]'),h=this.ui.form.find(".gt-shape-indicator"),i=this.ui.form.find(".gt-form-section");null===f.val()&&f.val("enter"),e instanceof L.Polygon?(a=Math.round(1e4*e.getCenter().lat)/1e4,c=Math.round(1e4*e.getCenter().lng)/1e4,g.val("polygon"),h.text("a polygon around "+a+", "+c),i.show()):e instanceof L.Circle?(a=Math.round(1e4*e.getLatLng().lat)/1e4,c=Math.round(1e4*e.getLatLng().lng)/1e4,d=Math.round(e.getRadius()),g.val("radius"),h.text("a "+d+"m radius around "+a+", "+c),i.show()):i.filter(":not(:first-child)").hide()},parseForm:function(a){a&&a.preventDefault&&a.preventDefault();var c=this.ui.form.serializeObject();if(c=b.util.removeEmptyStrings(c),c.tags){var d=c.tags;d=d.split(",");for(var e=d.length-1;e>0;e--)d[e]=d[e].trim();c.tags=d}!c.condition||!c.condition.geo,c.action&&(c.action.trackingProfile||(c.action.trackingProfile=null),c.action.callbackUrl||(c.action.callbackUrl=null)),c&&c.tags&&c.condition&&c.action&&this.createOrUpdateTrigger(c)},createOrUpdateTrigger:function(a){var c=b.request("draw:layer");if(c instanceof L.Polygon)a.condition.geo={geojson:c.toGeoJSON()};else{if(!(c instanceof L.Circle))throw new Error("Invalid layer data");var d=c.getLatLng();a.condition.geo={latitude:d.lat,longitude:d.lng,distance:Math.round(c.getRadius())}}this.model?(a.triggerId=this.model.get("triggerId"),b.vent.trigger("trigger:update",a)):b.vent.trigger("trigger:create",a)},confirmDelete:function(a){a&&a.preventDefault&&a.preventDefault(),this.ui.deleteItem.addClass("gt-item-confirm-delete"),this.ui.reset.addClass("gt-reset-flyout-right")},resetDelete:function(a){a&&a.preventDefault&&a.preventDefault(),this.ui.deleteItem.removeClass("gt-item-confirm-delete"),this.ui.reset.removeClass("gt-reset-flyout-right")},destroyModel:function(a){a&&a.preventDefault&&a.preventDefault(),b.vent.trigger("trigger:destroy",this.model)}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e){a.ListItem=d.ItemView.extend({template:b.Templates.item,tagName:"li",className:"gt-result",events:{"click .gt-item-edit":"editItem","click .gt-tags":"tagsClick","click .gt-delete-icon":"confirmDelete","click .gt-cancel-delete":"resetDelete","click .gt-confirm-delete":"destroyModel",mouseover:"focusShape",mouseout:"unfocusShape"},ui:{deleteItem:".gt-list-delete",confirm:".gt-item-confirm-delete",reset:".gt-reset-delete"},modelEvents:{change:"modelChanged"},modelChanged:function(){this.render()},editItem:function(){var a=this.model.get("triggerId");b.router.navigate("edit/"+a,{trigger:!0})},tagsClick:function(a){a.stopPropagation()},confirmDelete:function(a){a.preventDefault(),a.stopPropagation(),this.ui.deleteItem.addClass("gt-visible")},resetDelete:function(a){a.preventDefault(),a.stopPropagation(),this.ui.deleteItem.removeClass("gt-visible")},destroyModel:function(a){a.preventDefault(),a.stopPropagation(),b.vent.trigger("trigger:destroy",this.model)},focusShape:function(){var a=this.model.get("triggerId");b.vent.trigger("trigger:focus",a)},unfocusShape:function(){var a=this.model.get("triggerId");b.vent.trigger("trigger:unfocus",a)}}),a.Empty=d.ItemView.extend({template:b.Templates.empty,className:"gt-list-empty"}),a.List=d.CompositeView.extend({template:b.Templates.list,className:"gt-list gt-panel",itemView:a.ListItem,itemViewContainer:".gt-results",emptyView:a.Empty,events:{"keyup .gt-search":"filter","click .gt-icon-clear":"clearFilter"},ui:{header:".gt-list-header",search:".gt-search input",results:".gt-results"},onShow:function(){this.refresh(),this.listenTo(this.collection,"change reset add remove",this.refresh),this.listenTo(b.vent,"trigger:list:search",this.search),this.listenTo(b.vent,"trigger:list:reset",this.clearFilter)},refresh:function(){var a=this.collection.length;this.model.set("count",a),this.render(),a?this.ui.header.removeClass("gt-hide"):this.ui.header.addClass("gt-hide")},search:function(a){this.ui.search.val(a),this.filter()},clearFilter:function(){this.ui.search.val(""),this.$el.removeClass("gt-filtering")},filter:function(a){var d=this.ui.search.val();if(d.length)if("undefined"!=typeof a&&13===a.keyCode){var f="list/"+encodeURIComponent(d).replace(/%20/g,"+");b.router.navigate(f,{trigger:!0})}else{this.$el.addClass("gt-filtering");var g=this.ui.results.find(".gt-result"),h=this.ui.search.val().split(/\s+/),i="(?=.*"+h.join(")(?=.*")+")",j=new RegExp(i,"i");g.each(function(){var a=e(this),b=a.find(".gt-tags a"),c="";c+=a.find(".gt-item-edit span").text(),c+=a.find(".gt-id").text(),c+=a.find(".gt-item-details span").text(),b.each(function(){c+=e(this).text()}),j.exec(c)?a.addClass("gt-list-visible"):a.removeClass("gt-list-visible")})}else this.$el.removeClass("gt-filtering"),"list"!==c.history.fragment&&b.router.navigate("list",{trigger:!1})}})}),GeotriggerEditor.module("Layouts",function(a,b,c){a.Main=c.Marionette.Layout.extend({template:b.Templates.main,id:"gt-regions",regions:{controls:"#gt-controls-region",drawer:"#gt-drawer-region",map:"#gt-map-region",notes:"#gt-notes-region"}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e,f){a.Shape=d.View.extend({modelEvents:{change:"render"},render:function(){return this.isClosed=!1,this.triggerMethod("before:render",this),this.triggerMethod("item:before:render",this),this.renderShape(),this.triggerMethod("render",this),this.triggerMethod("item:rendered",this),this},renderShape:function(){var a=(this.model.get("triggerId"),this.model.get("condition").geo);this.removeShape(),this._shape=a.geojson?b.Map.polygon(a.geojson):b.Map.circle(a),this._shape.on("click",f.bind(function(){b.router.navigate("edit/"+this.model.id,{trigger:!0})},this)),this._shape.on("mouseover",f.bind(function(){b.Map.focusShape(this._shape)},this)),this._shape.on("mouseout",f.bind(function(){b.Map.unfocusShape(this._shape)},this))},removeShape:function(){this._shape&&(b.Map.removeShape(this._shape),delete this._shape)},focusShape:function(){this._shape&&b.Map.focusShape(this._shape)},unfocusShape:function(){this._shape&&b.Map.unfocusShape(this._shape)},onClose:function(){this.removeShape()}}),a.Map=d.CollectionView.extend({id:"gt-map",itemView:a.Shape,onShow:function(){b.Map.start({el:this.el}),this.listenTo(b.vent,"trigger:edit",this.hideShape),this.listenTo(b.vent,"index trigger:new trigger:list trigger:edit",this.restore),this.listenTo(b.vent,"trigger:focus",this.focusShape),this.listenTo(b.vent,"trigger:unfocus",this.unfocusShape)},hideShape:function(a){var c=b.collections.triggers.get(a),d=this.children.findByModel(c);d.removeShape()},focusShape:function(a){var c=b.collections.triggers.get(a),d=this.children.findByModel(c);d.focusShape()},unfocusShape:function(a){var c=b.collections.triggers.get(a),d=this.children.findByModel(c);d.unfocusShape()},restore:function(a){this.children.each(function(b){if(!b._shape){var c=b.model.get("triggerId");a&&c===a||b.render()}})}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e,f){a.Notification=d.ItemView.extend({template:b.Templates.notification,className:"gt-notification",tagName:"li",events:{"click .gt-close":"destroyNotification"},render:function(){d.ItemView.prototype.render.apply(this,arguments);var a=this.model.get("type")||"info";this.$el.addClass(a),this.listenTo(b.vent,"notify:clear",this.destroyNotification)},onShow:function(){this.$el.fadeIn();var a=this.model.get("timeout");"number"==typeof a&&setTimeout(f.bind(function(){this.destroyNotification()},this),a)},destroyNotification:function(){this.$el.fadeOut(f.bind(function(){this.model.destroy()},this))}}),a.NotificationList=d.CollectionView.extend({itemView:a.Notification,className:"gt-notification-list",tagName:"ul"})});