/*! geotrigger-editor 0.0.0 2013-11-01 */
var GeotriggerEditor=new Backbone.Marionette.Application;GeotriggerEditor.addInitializer(function(a){var b=a&&a.el?a.el:"#gt-editor",c=this.regions=new this.Layouts.Main;this.addRegions({mainRegion:b}),this.mainRegion.show(c)}),this.GeotriggerEditor=this.GeotriggerEditor||{},this.GeotriggerEditor.Templates=this.GeotriggerEditor.Templates||{},this.GeotriggerEditor.Templates.controls=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},'<div class="gt-drawer-controls">\n  <a href="#list" class="gt-tool gt-tool-list active gt-tooltip"><span>List</span></a>\n</div>\n<div class="gt-tool-controls">\n  <button class="gt-tool gt-tool-polygon gt-tooltip"><span>Polygon</span></button>\n  <button class="gt-tool gt-tool-radius gt-tooltip"><span>Radius</span></button>\n</div>'}),this.GeotriggerEditor.Templates.empty=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},'<div class="gt-panel-top-bar">\n  <a href="#" class="gt-panel-top-bar-button gt-new-trigger"></a>\n  <h3>No Geotriggers</h3>\n  <a href="#" class="gt-panel-top-bar-button gt-close-drawer"></a>\n</div>\n\n<div class="gt-panel-no-triggers">\n  <h5>This application doesn\'t have any Geotriggers yet.</h5>\n   <a href="#new" class="gt-tool gt-tool-create gt-button gt-button-green">Create A New Geotrigger</a>\n</div>\n\n<ul class="gt-tool-descriptions">\n  <li class="gt-tool-description">\n    <span class="gt-icon gt-icon-create"></span>\n    <h5><a class="gt-tool gt-tool-create"href="#">New Geotrigger Tool</a></h5>\n    <p>Create a new Geotrigger by first entering it\'s information, than defining an area on the map.</p>\n  </li>\n\n  <li class="gt-tool-description">\n    <span class="gt-icon gt-icon-polygon"></span>\n    <h5><a class="gt-tool gt-tool-polygon"href="#">Polygon Tool</a></h5>\n    <p>Click to start drawing on the map, creating each point of a polygon. Click on the first point to close the shape and enter the Geotrigger information.</p>\n  </li>\n\n  <li class="gt-tool-description">\n    <span class="gt-icon gt-icon-radius"></span>\n    <h5><a class="gt-tool gt-tool-radius"href="#">Radius Tool</a></h5>\n    <p>Select a point on the map, than hold and drag to define a radius around that point. You can edit this radius later, if you want.</p>\n  </li>\n\n  <!-- <li class="gt-tool-description">\n    <span class="gt-icon gt-icon-drivetime"></span>\n    <h5><a class="gt-tool gt-tool-drivetime"href="#">Drivetime Tool</a></h5>\n    <p>Drop a marker on the map, and then enter your desired drive time from that marker. We\'ll compute that polygon for you.</p>\n  </li> -->\n</ul>\n\n'}),this.GeotriggerEditor.Templates["form/actions/callbackUrl"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-action=\"callbackUrl\" class='gt-property'>\n  <div class=\"gt-property-header\">\n    notify this URL\n    <a class=\"gt-remove-action gt-delete-icon\"></a>\n  </div>\n\n  <div class=\"gt-property-item\">\n    <input class='gt-input-fill' type='text' name='action[callbackUrl]' placeholder='http://' value='"+i((f=b.action,f=null==f||f===!1?f:f.callbackUrl,typeof f===h?f.apply(b):f))+"'>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/data"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='data' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][data]'>\n    <span class='gt-label-left'>some data:</span>\n  </label>\n\n  <div class=\"gt-notification-center\">\n    <textarea class='gt-input' name='action[notification][data]' placeholder='{ \"your\": \"data\" }'>"+i((f=b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.data,typeof f===h?f.apply(b):f))+"</textarea>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/icon"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='icon' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][icon]'>\n    <span class='gt-label-left'>an icon:</span>\n  </label>\n\n  <div class='gt-notification-center'>\n    <input class='gt-input' type='text' name='action[notification][icon]' placeholder='icon' value='"+i((f=b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.icon,typeof f===h?f.apply(b):f))+"'>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/index"]=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},'<div data-action="notification" class="gt-property">\n  <div class="gt-property-header">\n    send a notification to the device with..\n    <a class="gt-remove-action gt-delete-icon"></a>\n  </div>\n\n  <div class="gt-notification-actions"></div>\n\n  <div class="gt-property-item gt-btn-group">\n    <button data-notification="text" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; a message</button>\n    <button data-notification="url" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; a URL</button>\n    <button data-notification="data" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; some data</button>\n    <button data-notification="icon" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; an icon</button>\n    <button data-notification="sound" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; a sound</button>\n  </div>\n</div>'}),this.GeotriggerEditor.Templates["form/actions/notification/sound"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='sound' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][sound]'>\n    <span class='gt-label-left'>a sound:</span>\n  </label>\n\n  <div class='gt-notification-center'>\n    <input class='gt-input' type='text' name='action[notification][sound]' placeholder='sound' value='"+i((f=b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.sound,typeof f===h?f.apply(b):f))+"'>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/text"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='text' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][text]'>\n    <span class='gt-label-left'>a message:</span>\n  </label>\n\n  <div class='gt-notification-center'>\n    <textarea class='gt-action-message-box' name='action[notification][text]' placeholder='message'>"+i((f=b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.text,typeof f===h?f.apply(b):f))+"</textarea>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/notification/url"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='url' class='gt-property-item gt-notification-action'>\n  <label class=\"gt-notification-left\" for='action[notification][url]'>\n    <span class='gt-label-left'>a URL:</span>\n  </label>\n\n  <div class='gt-notification-center'>\n    <input class='gt-input' type='text' name='action[notification][url]' placeholder='http://' value='"+i((f=b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.url,typeof f===h?f.apply(b):f))+"'>\n  </div>\n\n  <div class='gt-notification-right'>\n    <a class=\"gt-remove-notification gt-delete-icon\"></a>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/actions/trackingProfile"]=Handlebars.template(function(a,b,c,d,e){function f(){return'\n      <option value="fine">[3] fine</option>\n      <option value="adaptive">[2] adaptive</option>\n      <option value="rough">[1] rough</option>\n      <option value="off">[0] off</option>\n      '}this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var g,h,i,j="",k=this,l=c.helperMissing;return j+='<div data-action="trackingProfile" class="gt-property">\n  <div class="gt-property-header">\n    change the device\'s tracking profile\n    <a class="gt-remove-action gt-delete-icon"></a>\n  </div>\n\n  <div class="gt-property-item">\n    <select class="gt-select-full" name="action[trackingProfile]">\n      ',i={hash:{},inverse:k.noop,fn:k.program(1,f,e),data:e},g=c.select||b.select,h=g?g.call(b,(g=b.action,null==g||g===!1?g:g.trackingProfile),i):l.call(b,"select",(g=b.action,null==g||g===!1?g:g.trackingProfile),i),(h||0===h)&&(j+=h),j+="\n    </select>\n  </div>\n</div>"}),this.GeotriggerEditor.Templates["form/index"]=Handlebars.template(function(a,b,c,d,e){function f(){return"Edit"}function g(){return"Create"}function h(){return"\n              <option value='enter'>enters</option>\n              <option value='leave'>leaves</option>\n              "}function i(a,b){var d,e,f="";return f+='\n            <span class="gt-shape-indicator">a ',e={hash:{},data:b},f+=s((d=c.shape||a.shape,d?d.call(a,a.condition,e):r.call(a,"shape",a.condition,e)))+"</span>\n            "}function j(){return'\n            <span class="gt-shape-indicator">a...</span>\n            '}function k(){return" gt-hide"}function l(){return"\n      <button class='gt-button gt-button-blue gt-submit'>Update</button>\n      <ul class='gt-edit-controls'>\n        <li>\n          <a class='gt-reset-delete' href='#'>&#x2716;</a>\n        </li>\n        <li>\n          <button class='gt-item-delete gt-button-delete'></button>\n        </li>\n      </ul>\n      "}function m(){return"\n      <button class='gt-button gt-button-blue gt-submit'>Save</button>\n      "}this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var n,o,p,q="",r=c.helperMissing,s=this.escapeExpression,t=this,u="function";return q+="<div class='gt-panel-top-bar'>\n  <a href='#list' class='gt-panel-top-bar-button gt-back-to-list'></a>\n  <h3>",n=c["if"].call(b,b.triggerId,{hash:{},inverse:t.program(3,g,e),fn:t.program(1,f,e),data:e}),(n||0===n)&&(q+=n),q+="</h3>\n  <a href='#' class='gt-panel-top-bar-button gt-close-drawer'></a>\n</div>\n\n<div class='gt-panel-content'>\n  <form class='gt-form gt-form-edit'>\n\n    <section class='gt-form-section gt-conditions'>\n      <div class=\"gt-property\">\n        <div class=\"gt-property-header\">When a device tagged..</div>\n\n        <div class=\"gt-property-item\">\n          <textarea class='gt-input' name='tags' placeholder='enter tags'>",p={hash:{},data:e},q+=s((n=c.tagList||b.tagList,n?n.call(b,b.tags,p):r.call(b,"tagList",b.tags,p)))+"</textarea>\n        </div>\n\n        <div class=\"gt-property-item\">\n            <select name='condition[direction]' class='gt-direction'>\n              ",p={hash:{},inverse:t.noop,fn:t.program(5,h,e),data:e},n=c.select||b.select,o=n?n.call(b,(n=b.condition,null==n||n===!1?n:n.direction),p):r.call(b,"select",(n=b.condition,null==n||n===!1?n:n.direction),p),(o||0===o)&&(q+=o),q+="\n            </select>\n\n            ",o=c["if"].call(b,b.condition,{hash:{},inverse:t.program(9,j,e),fn:t.program(7,i,e),data:e}),(o||0===o)&&(q+=o),q+='\n            <input name="geometry-type" type="hidden" value="',p={hash:{},data:e},q+=s((n=c.shape||b.shape,n?n.call(b,b.condition,p):r.call(b,"shape",b.condition,p)))+'">\n        </div>\n      </div>\n    </section>\n\n    <section class="gt-form-section gt-actions"></section>\n\n    <section class="gt-form-section gt-action-toggles">\n      <button data-action="notification" class="gt-button gt-button-light-gray gt-button-small gt-add-action">&#043; send a notification</button>\n      <button data-action="callbackUrl" class="gt-button gt-button-light-gray gt-button-small gt-add-action">&#043; post to a callback URL</button>\n      <button data-action="trackingProfile" class="gt-button gt-button-light-gray gt-button-small gt-add-action">&#043; change the tracking profile</button>\n    </section>\n\n    <section class="gt-form-section gt-title-wrapper">\n      <button class="gt-button gt-button-light-gray gt-button-small gt-add-title',o=c["if"].call(b,(n=b.properties,null==n||n===!1?n:n.title),{hash:{},inverse:t.noop,fn:t.program(11,k,e),data:e}),(o||0===o)&&(q+=o),q+="\">&#043; add a title</button>\n\n      <div class='gt-title gt-property",o=c.unless.call(b,(n=b.properties,null==n||n===!1?n:n.title),{hash:{},inverse:t.noop,fn:t.program(11,k,e),data:e}),(o||0===o)&&(q+=o),q+="'>\n        <div class=\"gt-property-header\">\n          Title\n          <a class=\"gt-remove-title gt-delete-icon\"></a>\n        </div>\n\n        <div class=\"gt-property-item\">\n          <input class='gt-input-fill' type='text' name='properties[title]' placeholder='Geotrigger Title' value='"+s((n=b.properties,n=null==n||n===!1?n:n.title,typeof n===u?n.apply(b):n))+"'>\n        </div>\n      </div>\n    </section>\n\n    <section class='gt-form-section gt-submit-wrapper'>\n      ",o=c["if"].call(b,b.triggerId,{hash:{},inverse:t.program(15,m,e),fn:t.program(13,l,e),data:e}),(o||0===o)&&(q+=o),q+="\n    </section>\n  </form>\n</div>"}),this.GeotriggerEditor.Templates.item=Handlebars.template(function(a,b,c,d,e){function f(a){var b,c="";return c+="\n      <span>"+o((b=a.properties,b=null==b||b===!1?b:b.title,typeof b===n?b.apply(a):b))+"</span>\n    "}function g(a,b){var d,e,f="";return f+="\n      <span>",e={hash:{},data:b},f+=o((d=c.defaultTitle||a.defaultTitle,d?d.call(a,a.condition,e):p.call(a,"defaultTitle",a.condition,e)))+"</span>\n    "}function h(a){var b;return o((b=a.properties,b=null==b||b===!1?b:b.title,typeof b===n?b.apply(a):b))}function i(a,b){var d,e;return e={hash:{},data:b},o((d=c.defaultTitle||a.defaultTitle,d?d.call(a,a.condition,e):p.call(a,"defaultTitle",a.condition,e)))}this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var j,k,l,m="",n="function",o=this.escapeExpression,p=c.helperMissing,q=this;return m+="<span class='gt-item-edit gt-icon ",l={hash:{},data:e},m+=o((j=c.actionIcon||b.actionIcon,j?j.call(b,(j=b.condition,null==j||j===!1?j:j.direction),(j=b.condition,null==j||j===!1?j:j.geo),l):p.call(b,"actionIcon",(j=b.condition,null==j||j===!1?j:j.direction),(j=b.condition,null==j||j===!1?j:j.geo),l)))+" gt-icon-polygon'></span>\n<h5>\n  <a class='gt-item-edit' href='#",(k=c.triggerId)?k=k.call(b,{hash:{},data:e}):(k=b.triggerId,k=typeof k===n?k.apply(b):k),m+=o(k)+"/edit'>\n    ",k=c["if"].call(b,(j=b.properties,null==j||j===!1?j:j.title),{hash:{},inverse:q.program(3,g,e),fn:q.program(1,f,e),data:e}),(k||0===k)&&(m+=k),m+="\n  </a>\n</h5>\n<div class='gt-item-toolbar'>\n  <a class='gt-edit-icon' href='#",(k=c.triggerId)?k=k.call(b,{hash:{},data:e}):(k=b.triggerId,k=typeof k===n?k.apply(b):k),m+=o(k)+"/edit'></a>\n  <a class='gt-delete-icon' href='#'></a>\n</div>\n<div class='gt-tags'>\n  <strong>Tags</strong><span>:</span> ",l={hash:{},data:e},j=c.tagLinks||b.tagLinks,k=j?j.call(b,b.tags,l):p.call(b,"tagLinks",b.tags,l),(k||0===k)&&(m+=k),m+="\n</div>\n<div class='gt-id'>\n  <strong>ID</strong><span>:</span> ",(k=c.triggerId)?k=k.call(b,{hash:{},data:e}):(k=b.triggerId,k=typeof k===n?k.apply(b):k),m+=o(k)+"\n</div>\n<div class='gt-list-delete'>\n  <h5>Delete ",k=c["if"].call(b,(j=b.properties,null==j||j===!1?j:j.title),{hash:{},inverse:q.program(7,i,e),fn:q.program(5,h,e),data:e}),(k||0===k)&&(m+=k),m+="?</h5>\n  <button class='gt-confirm-delete gt-button-small gt-button-delete'>Delete</button>\n  <button class='gt-cancel-delete gt-button-small gt-button gt-button-gray'>Cancel</button>\n</div>"}),this.GeotriggerEditor.Templates.list=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div class='gt-list-header gt-hide'>\n  <div class='gt-panel-top-bar'>\n    <a href='#new' class='gt-button gt-button-blue gt-tool-create'>Create</a>\n    <h3 class='gt-panel-top-bar-left'>List <span class=\"gt-trigger-count\">(",(f=c.count)?f=f.call(b,{hash:{},data:e}):(f=b.count,f=typeof f===h?f.apply(b):f),g+=i(f)+")</span></h3>\n    <a href='#' class='gt-panel-top-bar-button gt-close-drawer'></a>\n  </div>\n  </div>\n  <div class='gt-search'>\n    <input type='search' placeholder='Search'><a href=\"#list\" class=\"gt-icon-clear\"></a>\n  </div>\n<ul class='gt-results'></ul>"}),this.GeotriggerEditor.Templates.main=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},"<div id='gt-controls-region'></div>\n<div id='gt-content'>\n  <div id='gt-drawer-region'></div>\n  <div id='gt-map-region'></div>\n  <div id='gt-notes-region'></div>\n</div>\n"}),this.GeotriggerEditor.Templates.notification=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<button class='gt-close'>&times;</button> ",(f=c.message)?f=f.call(b,{hash:{},data:e}):(f=b.message,f=typeof f===h?f.apply(b):f),g+=i(f)}),function(a,b,c){b.registerHelper("select",function(a,b){var d=c("<select>");return d.html(b.fn(this)),d.find('option[value="'+a+'"]').attr("selected","selected"),d.html()}),b.registerHelper("selectShape",function(a,b){var d=c("<select>");d.html(b.fn(this));var e;return a&&a.geo&&(e=a.geo.geojson?"polygon":"radius"),d.find('option[value="'+e+'"]').attr("selected","selected"),d.html()}),b.registerHelper("shape",function(a){var b="";return a&&a.geo&&(b=a.geo.geojson?"polygon":"radius"),b}),b.registerHelper("actionIcon",function(a,b){var c="";return"enter"===a?c+="gt-icon-enter ":"leave"===a&&(c+="gt-icon-exit "),b.geojson&&(c+="gt-icon-polygon "),b.distance&&(c+="gt-icon-radius "),c}),b.registerHelper("defaultTitle",function(a){var b=""+a.direction;if(a.geo.distance)b+=" "+a.geo.distance+" meter radius";else if(a.geo.geojson&&a.geo.geojson.coordinates){var c=a.geo.geojson.coordinates[0].length-1;b+=" "+c+" sided polygon"}return b=b.charAt(0).toUpperCase()+b.slice(1)}),b.registerHelper("unlessDefaultTag",function(a,b){return 0!==a.indexOf("trigger:")?b.fn(this):b.inverse(this)}),b.registerHelper("tagList",function(a){if(a&&a.length){for(var b=[],c=0;c<a.length;c++)0!==a[c].indexOf("trigger:")&&b.push(a[c]);return b.join(", ")}return""}),b.registerHelper("tagLinks",function(a){if(a&&a.length){if(1===a.length&&0===a[0].indexOf("trigger:"))return"<strong>none</strong>";for(var b=[],c=0;c<a.length;c++)0!==a[c].indexOf("trigger:")&&b.push('<a href="#list?q='+encodeURIComponent(a[c]).replace(/%20/g,"+")+'">'+a[c]+"</a>");return b.join(", ")}return"<strong>none</strong>"})}(GeotriggerEditor,Handlebars,$),function(a){return a.fn.serializeObject=function(){var b,c,d,e=this;return b={},d={},c={validate:/^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,key:/[a-zA-Z0-9_]+|(?=\[\])/g,push:/^$/,fixed:/^\d+$/,named:/^[a-zA-Z0-9_]+$/},this.build=function(a,b,c){return a[b]=c,a},this.push_counter=function(a){return void 0===d[a]&&(d[a]=0),d[a]++},a.each(a(this).serializeArray(),function(d,f){var g,h,i,j,k;if(c.validate.test(f.name)){for(h=f.name.match(c.key),i=f.value,k=f.name;void 0!==(g=h.pop());)c.push.test(g)?(j=new RegExp("\\["+g+"\\]$"),k=k.replace(j,""),i=e.build([],e.push_counter(k),i)):c.fixed.test(g)?i=e.build([],g,i):c.named.test(g)&&(i=e.build({},g,i));return b=a.extend(!0,b,i)}}),b}}(jQuery),function(a,b){L.drawVersion="0.2.1-dev",L.drawLocal={draw:{toolbar:{actions:{title:"Cancel drawing",text:"Cancel"},buttons:{polyline:"Draw a polyline",polygon:"Draw a polygon",rectangle:"Draw a rectangle",circle:"Draw a circle",marker:"Draw a marker"}},handlers:{circle:{tooltip:{start:"Click and drag to draw circle."}},marker:{tooltip:{start:"Click map to place marker."}},polygon:{tooltip:{start:"Click to start drawing shape.",cont:"Click to continue drawing shape.",end:"Click first point to close this shape."}},polyline:{error:"<strong>Error:</strong> shape edges cannot cross!",tooltip:{start:"Click to start drawing line.",cont:"Click to continue drawing line.",end:"Click last point to finish line."}},rectangle:{tooltip:{start:"Click and drag to draw rectangle."}},simpleshape:{tooltip:{end:"Release mouse to finish drawing."}}}},edit:{toolbar:{actions:{save:{title:"Save changes.",text:"Save"},cancel:{title:"Cancel editing, discards all changes.",text:"Cancel"}},buttons:{edit:"Edit layers",remove:"Delete layers"}},handlers:{edit:{tooltip:{text:"Drag handles, or marker to edit feature.",subtext:"Click cancel to undo changes."}},remove:{tooltip:{text:"Click on a feature to remove"}}}}},L.Draw={},L.Draw.Feature=L.Handler.extend({includes:L.Mixin.Events,initialize:function(a,b){this._map=a,this._container=a._container,this._overlayPane=a._panes.overlayPane,this._popupPane=a._panes.popupPane,b&&b.shapeOptions&&(b.shapeOptions=L.Util.extend({},this.options.shapeOptions,b.shapeOptions)),L.Util.extend(this.options,b)},enable:function(){this._enabled||(L.Handler.prototype.enable.call(this),this.fire("enabled",{handler:this.type}),this._map.fire("draw:drawstart",{layerType:this.type}))},disable:function(){this._enabled&&(L.Handler.prototype.disable.call(this),this.fire("disabled",{handler:this.type}),this._map.fire("draw:drawstop",{layerType:this.type}))},addHooks:function(){this._map&&(L.DomUtil.disableTextSelection(),this._tooltip=new L.Tooltip(this._map),L.DomEvent.addListener(this._container,"keyup",this._cancelDrawing,this))},removeHooks:function(){this._map&&(L.DomUtil.enableTextSelection(),this._tooltip.dispose(),this._tooltip=null,L.DomEvent.removeListener(this._container,"keyup",this._cancelDrawing))},setOptions:function(a){L.setOptions(this,a)},_fireCreatedEvent:function(a){this._map.fire("draw:created",{layer:a,layerType:this.type})},_cancelDrawing:function(a){27===a.keyCode&&this.disable()}}),L.Draw.Polyline=L.Draw.Feature.extend({statics:{TYPE:"polyline"},Poly:L.Polyline,options:{allowIntersection:!0,drawError:{color:"#b00b00",message:L.drawLocal.draw.handlers.polyline.error,timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),guidelineDistance:20,shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!1,clickable:!0},zIndexOffset:2e3},initialize:function(a,b){b&&b.drawError&&(b.drawError=L.Util.extend({},this.options.drawError,b.drawError)),this.type=L.Draw.Polyline.TYPE,L.Draw.Feature.prototype.initialize.call(this,a,b)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._markers=[],this._markerGroup=new L.LayerGroup,this._map.addLayer(this._markerGroup),this._poly=new L.Polyline([],this.options.shapeOptions),this._tooltip.updateContent(this._getTooltipText()),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("click",this._onClick,this).addTo(this._map),this._map.on("mousemove",this._onMouseMove,this).on("zoomend",this._onZoomEnd,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("click",this._onClick,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mousemove",this._onMouseMove,this).off("zoomend",this._onZoomEnd,this)},_finishShape:function(){var a=this._poly.newLatLngIntersects(this._poly.getLatLngs()[0],!0);return!this.options.allowIntersection&&a||!this._shapeIsValid()?(this._showErrorTooltip(),void 0):(this._fireCreatedEvent(),this.disable(),void 0)},_shapeIsValid:function(){return!0},_onZoomEnd:function(){this._updateGuide()},_onMouseMove:function(a){var b=a.layerPoint,c=a.latlng;this._currentLatLng=c,this._updateTooltip(c),this._updateGuide(b),this._mouseMarker.setLatLng(c),L.DomEvent.preventDefault(a.originalEvent)},_onClick:function(a){var b=a.target.getLatLng(),c=this._markers.length;return c>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(b)?(this._showErrorTooltip(),void 0):(this._errorShown&&this._hideErrorTooltip(),this._markers.push(this._createMarker(b)),this._poly.addLatLng(b),2===this._poly.getLatLngs().length&&this._map.addLayer(this._poly),this._updateFinishHandler(),this._vertexAdded(b),this._clearGuides(),this._updateTooltip(),void 0)},_updateFinishHandler:function(){var a=this._markers.length;a>1&&this._markers[a-1].on("click",this._finishShape,this),a>2&&this._markers[a-2].off("click",this._finishShape,this)},_createMarker:function(a){var b=new L.Marker(a,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset});return this._markerGroup.addLayer(b),b},_updateGuide:function(a){a=a||this._map.latLngToLayerPoint(this._currentLatLng);var b=this._markers.length;b>0&&(this._clearGuides(),this._drawGuide(this._map.latLngToLayerPoint(this._markers[b-1].getLatLng()),a))},_updateTooltip:function(a){var b=this._getTooltipText();a&&this._tooltip.updatePosition(a),this._errorShown||this._tooltip.updateContent(b)},_drawGuide:function(a,b){var c,d,e,f,g=Math.floor(Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2)));for(this._guidesContainer||(this._guidesContainer=L.DomUtil.create("div","leaflet-draw-guides",this._overlayPane)),c=this.options.guidelineDistance;g>c;c+=this.options.guidelineDistance)d=c/g,e={x:Math.floor(a.x*(1-d)+d*b.x),y:Math.floor(a.y*(1-d)+d*b.y)},f=L.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer),f.style.backgroundColor=this._errorShown?this.options.drawError.color:this.options.shapeOptions.color,L.DomUtil.setPosition(f,e)},_updateGuideColor:function(a){if(this._guidesContainer)for(var b=0,c=this._guidesContainer.childNodes.length;c>b;b++)this._guidesContainer.childNodes[b].style.backgroundColor=a},_clearGuides:function(){if(this._guidesContainer)for(;this._guidesContainer.firstChild;)this._guidesContainer.removeChild(this._guidesContainer.firstChild)},_getTooltipText:function(){var a,b,c;return 0===this._markers.length?a={text:L.drawLocal.draw.handlers.polyline.tooltip.start}:(b=this._measurementRunningTotal+this._currentLatLng.distanceTo(this._markers[this._markers.length-1].getLatLng()),c=b>1e3?(b/1e3).toFixed(2)+" km":Math.ceil(b)+" m",a=1===this._markers.length?{text:L.drawLocal.draw.handlers.polyline.tooltip.cont,subtext:c}:{text:L.drawLocal.draw.handlers.polyline.tooltip.end,subtext:c}),a},_showErrorTooltip:function(){this._errorShown=!0,this._tooltip.showAsError().updateContent({text:this.options.drawError.message}),this._updateGuideColor(this.options.drawError.color),this._poly.setStyle({color:this.options.drawError.color}),this._clearHideErrorTimeout(),this._hideErrorTimeout=setTimeout(L.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=!1,this._clearHideErrorTimeout(),this._tooltip.removeError().updateContent(this._getTooltipText()),this._updateGuideColor(this.options.shapeOptions.color),this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){this._hideErrorTimeout&&(clearTimeout(this._hideErrorTimeout),this._hideErrorTimeout=null)},_vertexAdded:function(a){1===this._markers.length?this._measurementRunningTotal=0:this._measurementRunningTotal+=a.distanceTo(this._markers[this._markers.length-2].getLatLng())},_cleanUpShape:function(){this._markers.length>1&&this._markers[this._markers.length-1].off("click",this._finishShape,this)},_fireCreatedEvent:function(){var a=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,a)}}),L.Draw.Polygon=L.Draw.Polyline.extend({statics:{TYPE:"polygon"},Poly:L.Polygon,options:{showArea:!1,shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},initialize:function(a,b){L.Draw.Polyline.prototype.initialize.call(this,a,b),this.type=L.Draw.Polygon.TYPE},_updateFinishHandler:function(){var a=this._markers.length;1===a&&this._markers[0].on("click",this._finishShape,this),a>2&&(this._markers[a-1].on("dblclick",this._finishShape,this),a>3&&this._markers[a-2].off("dblclick",this._finishShape,this))},_getTooltipText:function(){var a,b;return 0===this._markers.length?a=L.drawLocal.draw.handlers.polygon.tooltip.start:this._markers.length<3?a=L.drawLocal.draw.handlers.polygon.tooltip.cont:(a=L.drawLocal.draw.handlers.polygon.tooltip.end,b=this._area),{text:a,subtext:b}},_shapeIsValid:function(){return this._markers.length>=3},_vertexAdded:function(){if(!this.options.allowIntersection&&this.options.showArea){var a=this._poly.getLatLngs(),b=L.PolygonUtil.geodesicArea(a);b=b>1e4?(1e-4*b).toFixed(2)+" ha":b.toFixed(2)+" m&sup2;",this._area=b}},_cleanUpShape:function(){var a=this._markers.length;a>0&&(this._markers[0].off("click",this._finishShape,this),a>2&&this._markers[a-1].off("dblclick",this._finishShape,this))}}),L.SimpleShape={},L.Draw.SimpleShape=L.Draw.Feature.extend({addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._map.dragging.disable(),this._container.style.cursor="crosshair",this._tooltip.updateContent({text:this._initialLabelText}),this._map.on("mousedown",this._onMouseDown,this).on("mousemove",this._onMouseMove,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._map&&(this._map.dragging.enable(),this._container.style.cursor="",this._map.off("mousedown",this._onMouseDown,this).off("mousemove",this._onMouseMove,this),L.DomEvent.off(b,"mouseup",this._onMouseUp),this._shape&&(this._map.removeLayer(this._shape),delete this._shape)),this._isDrawing=!1},_onMouseDown:function(a){this._isDrawing=!0,this._startLatLng=a.latlng,L.DomEvent.on(b,"mouseup",this._onMouseUp,this).preventDefault(a.originalEvent)},_onMouseMove:function(a){var b=a.latlng;this._tooltip.updatePosition(b),this._isDrawing&&(this._tooltip.updateContent({text:L.drawLocal.draw.handlers.simpleshape.tooltip.end}),this._drawShape(b))},_onMouseUp:function(){this._shape&&this._fireCreatedEvent(),this.disable()}}),L.Draw.Rectangle=L.Draw.SimpleShape.extend({statics:{TYPE:"rectangle"},options:{shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},initialize:function(a,b){this.type=L.Draw.Rectangle.TYPE,L.Draw.SimpleShape.prototype.initialize.call(this,a,b)},_initialLabelText:L.drawLocal.draw.handlers.rectangle.tooltip.start,_drawShape:function(a){this._shape?this._shape.setBounds(new L.LatLngBounds(this._startLatLng,a)):(this._shape=new L.Rectangle(new L.LatLngBounds(this._startLatLng,a),this.options.shapeOptions),this._map.addLayer(this._shape))},_fireCreatedEvent:function(){var a=new L.Rectangle(this._shape.getBounds(),this.options.shapeOptions);
L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,a)}}),L.Draw.Circle=L.Draw.SimpleShape.extend({statics:{TYPE:"circle"},options:{shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},initialize:function(a,b){this.type=L.Draw.Circle.TYPE,L.Draw.SimpleShape.prototype.initialize.call(this,a,b)},_initialLabelText:L.drawLocal.draw.handlers.circle.tooltip.start,_drawShape:function(a){this._shape?this._shape.setRadius(this._startLatLng.distanceTo(a)):(this._shape=new L.Circle(this._startLatLng,this._startLatLng.distanceTo(a),this.options.shapeOptions),this._map.addLayer(this._shape))},_fireCreatedEvent:function(){var a=new L.Circle(this._startLatLng,this._shape.getRadius(),this.options.shapeOptions);L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,a)},_onMouseMove:function(a){var b,c=a.latlng;this._tooltip.updatePosition(c),this._isDrawing&&(this._drawShape(c),b=this._shape.getRadius().toFixed(1),this._tooltip.updateContent({text:"Release mouse to finish drawing.",subtext:"Radius: "+b+" m"}))}}),L.Draw.Marker=L.Draw.Feature.extend({statics:{TYPE:"marker"},options:{icon:new L.Icon.Default,zIndexOffset:2e3},initialize:function(a,b){this.type=L.Draw.Marker.TYPE,L.Draw.Feature.prototype.initialize.call(this,a,b)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._tooltip.updateContent({text:L.drawLocal.draw.handlers.marker.tooltip.start}),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("click",this._onClick,this).addTo(this._map),this._map.on("mousemove",this._onMouseMove,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._map&&(this._marker&&(this._marker.off("click",this._onClick,this),this._map.off("click",this._onClick,this).removeLayer(this._marker),delete this._marker),this._mouseMarker.off("click",this._onClick,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._map.off("mousemove",this._onMouseMove,this))},_onMouseMove:function(a){var b=a.latlng;this._tooltip.updatePosition(b),this._mouseMarker.setLatLng(b),this._marker?this._marker.setLatLng(b):(this._marker=new L.Marker(b,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset}),this._marker.on("click",this._onClick,this),this._map.on("click",this._onClick,this).addLayer(this._marker))},_onClick:function(){this._fireCreatedEvent(),this.disable()},_fireCreatedEvent:function(){var a=new L.Marker(this._marker.getLatLng(),{icon:this.options.icon});L.Draw.Feature.prototype._fireCreatedEvent.call(this,a)}}),L.Edit=L.Edit||{},L.Edit.Poly=L.Handler.extend({options:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"})},initialize:function(a,b){this._poly=a,L.setOptions(this,b)},addHooks:function(){this._poly._map&&(this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup))},removeHooks:function(){this._poly._map&&(this._poly._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers)},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var a,b,c,d,e=this._poly._latlngs;for(a=0,c=e.length;c>a;a++)d=this._createMarker(e[a],a),d.on("click",this._onMarkerClick,this),this._markers.push(d);var f,g;for(a=0,b=c-1;c>a;b=a++)(0!==a||L.Polygon&&this._poly instanceof L.Polygon)&&(f=this._markers[b],g=this._markers[a],this._createMiddleMarker(f,g),this._updatePrevNext(f,g))},_createMarker:function(a,b){var c=new L.Marker(a,{draggable:!0,icon:this.options.icon});return c._origLatLng=a,c._index=b,c.on("drag",this._onMarkerDrag,this),c.on("dragend",this._fireEdit,this),this._markerGroup.addLayer(c),c},_removeMarker:function(a){var b=a._index;this._markerGroup.removeLayer(a),this._markers.splice(b,1),this._poly.spliceLatLngs(b,1),this._updateIndexes(b,-1),a.off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("click",this._onMarkerClick,this)},_fireEdit:function(){this._poly.edited=!0,this._poly.fire("edit")},_onMarkerDrag:function(a){var b=a.target;L.extend(b._origLatLng,b._latlng),b._middleLeft&&b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,b)),b._middleRight&&b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next)),this._poly.redraw()},_onMarkerClick:function(a){if(!(this._poly._latlngs.length<3)){var b=a.target;this._removeMarker(b),this._updatePrevNext(b._prev,b._next),b._middleLeft&&this._markerGroup.removeLayer(b._middleLeft),b._middleRight&&this._markerGroup.removeLayer(b._middleRight),b._prev&&b._next?this._createMiddleMarker(b._prev,b._next):b._prev?b._next||(b._prev._middleRight=null):b._next._middleLeft=null,this._fireEdit()}},_updateIndexes:function(a,b){this._markerGroup.eachLayer(function(c){c._index>a&&(c._index+=b)})},_createMiddleMarker:function(a,b){var c,d,e,f=this._getMiddleLatLng(a,b),g=this._createMarker(f);g.setOpacity(.6),a._middleRight=b._middleLeft=g,d=function(){var d=b._index;g._index=d,g.off("click",c,this).on("click",this._onMarkerClick,this),f.lat=g.getLatLng().lat,f.lng=g.getLatLng().lng,this._poly.spliceLatLngs(d,0,f),this._markers.splice(d,0,g),g.setOpacity(1),this._updateIndexes(d,1),b._index++,this._updatePrevNext(a,g),this._updatePrevNext(g,b)},e=function(){g.off("dragstart",d,this),g.off("dragend",e,this),this._createMiddleMarker(a,g),this._createMiddleMarker(g,b)},c=function(){d.call(this),e.call(this),this._fireEdit()},g.on("click",c,this).on("dragstart",d,this).on("dragend",e,this),this._markerGroup.addLayer(g)},_updatePrevNext:function(a,b){a&&(a._next=b),b&&(b._prev=a)},_getMiddleLatLng:function(a,b){var c=this._poly._map,d=c.latLngToLayerPoint(a.getLatLng()),e=c.latLngToLayerPoint(b.getLatLng());return c.layerPointToLatLng(d._add(e)._divideBy(2))}}),L.Polyline.addInitHook(function(){this.editing||(L.Edit.Poly&&(this.editing=new L.Edit.Poly(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()}))}),L.Edit=L.Edit||{},L.Edit.SimpleShape=L.Handler.extend({options:{moveIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move"}),resizeIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize"})},initialize:function(a,b){this._shape=a,L.Util.setOptions(this,b)},addHooks:function(){this._shape._map&&(this._map=this._shape._map,this._markerGroup||this._initMarkers(),this._map.addLayer(this._markerGroup))},removeHooks:function(){if(this._shape._map){this._unbindMarker(this._moveMarker);for(var a=0,b=this._resizeMarkers.length;b>a;a++)this._unbindMarker(this._resizeMarkers[a]);this._resizeMarkers=null,this._map.removeLayer(this._markerGroup),delete this._markerGroup}this._map=null},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._createMoveMarker(),this._createResizeMarker()},_createMoveMarker:function(){},_createResizeMarker:function(){},_createMarker:function(a,b){var c=new L.Marker(a,{draggable:!0,icon:b,zIndexOffset:10});return this._bindMarker(c),this._markerGroup.addLayer(c),c},_bindMarker:function(a){a.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._onMarkerDragEnd,this)},_unbindMarker:function(a){a.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._onMarkerDragEnd,this)},_onMarkerDragStart:function(a){var b=a.target;b.setOpacity(0)},_fireEdit:function(){this._shape.edited=!0,this._shape.fire("edit")},_onMarkerDrag:function(a){var b=a.target,c=b.getLatLng();b===this._moveMarker?this._move(c):this._resize(c),this._shape.redraw()},_onMarkerDragEnd:function(a){var b=a.target;b.setOpacity(1),this._shape.fire("edit"),this._fireEdit()},_move:function(){},_resize:function(){}}),L.Edit=L.Edit||{},L.Edit.Rectangle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var a=this._shape.getBounds(),b=a.getCenter();this._moveMarker=this._createMarker(b,this.options.moveIcon)},_createResizeMarker:function(){var a=this._getCorners();this._resizeMarkers=[];for(var b=0,c=a.length;c>b;b++)this._resizeMarkers.push(this._createMarker(a[b],this.options.resizeIcon)),this._resizeMarkers[b]._cornerIndex=b},_onMarkerDragStart:function(a){L.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,a);var b=this._getCorners(),c=a.target,d=c._cornerIndex;this._oppositeCorner=b[(d+2)%4],this._toggleCornerMarkers(0,d)},_onMarkerDragEnd:function(a){var b,c,d=a.target;d===this._moveMarker&&(b=this._shape.getBounds(),c=b.getCenter(),d.setLatLng(c)),this._toggleCornerMarkers(1),this._repositionCornerMarkers(),L.Edit.SimpleShape.prototype._onMarkerDragEnd.call(this,a)},_move:function(a){for(var b,c=this._shape.getLatLngs(),d=this._shape.getBounds(),e=d.getCenter(),f=[],g=0,h=c.length;h>g;g++)b=[c[g].lat-e.lat,c[g].lng-e.lng],f.push([a.lat+b[0],a.lng+b[1]]);this._shape.setLatLngs(f),this._repositionCornerMarkers()},_resize:function(a){var b;this._shape.setBounds(L.latLngBounds(a,this._oppositeCorner)),b=this._shape.getBounds(),this._moveMarker.setLatLng(b.getCenter())},_getCorners:function(){var a=this._shape.getBounds(),b=a.getNorthWest(),c=a.getNorthEast(),d=a.getSouthEast(),e=a.getSouthWest();return[b,c,d,e]},_toggleCornerMarkers:function(a){for(var b=0,c=this._resizeMarkers.length;c>b;b++)this._resizeMarkers[b].setOpacity(a)},_repositionCornerMarkers:function(){for(var a=this._getCorners(),b=0,c=this._resizeMarkers.length;c>b;b++)this._resizeMarkers[b].setLatLng(a[b])}}),L.Rectangle.addInitHook(function(){L.Edit.Rectangle&&(this.editing=new L.Edit.Rectangle(this),this.options.editable&&this.editing.enable())}),L.Edit=L.Edit||{},L.Edit.Circle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var a=this._shape.getLatLng();this._moveMarker=this._createMarker(a,this.options.moveIcon)},_createResizeMarker:function(){var a=this._shape.getLatLng(),b=this._getResizeMarkerPoint(a);this._resizeMarkers=[],this._resizeMarkers.push(this._createMarker(b,this.options.resizeIcon))},_getResizeMarkerPoint:function(a){var b=this._shape._radius*Math.cos(Math.PI/4),c=this._map.project(a);return this._map.unproject([c.x+b,c.y-b])},_move:function(a){var b=this._getResizeMarkerPoint(a);this._resizeMarkers[0].setLatLng(b),this._shape.setLatLng(a)},_resize:function(a){var b=this._moveMarker.getLatLng(),c=b.distanceTo(a);this._shape.setRadius(c)}}),L.Circle.addInitHook(function(){L.Edit.Circle&&(this.editing=new L.Edit.Circle(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()})}),L.LatLngUtil={cloneLatLngs:function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(this.cloneLatLng(a[c]));return b},cloneLatLng:function(a){return L.latLng(a.lat,a.lng)}},L.PolygonUtil={geodesicArea:function(a){var b,c,d=a.length,e=0,f=L.LatLng.DEG_TO_RAD;if(d>2){for(var g=0;d>g;g++)b=a[g],c=a[(g+1)%d],e+=(c.lng-b.lng)*f*(2+Math.sin(b.lat*f)+Math.sin(c.lat*f));e=6378137*6378137*e/2}return Math.abs(e)}},L.Util.extend(L.LineUtil,{segmentsIntersect:function(a,b,c,d){return this._checkCounterclockwise(a,c,d)!==this._checkCounterclockwise(b,c,d)&&this._checkCounterclockwise(a,b,c)!==this._checkCounterclockwise(a,b,d)},_checkCounterclockwise:function(a,b,c){return(c.y-a.y)*(b.x-a.x)>(b.y-a.y)*(c.x-a.x)}}),L.Polyline.include({intersects:function(){var a,b,c,d=this._originalPoints,e=d?d.length:0;if(this._tooFewPointsForIntersection())return!1;for(a=e-1;a>=3;a--)if(b=d[a-1],c=d[a],this._lineSegmentsIntersectsRange(b,c,a-2))return!0;return!1},newLatLngIntersects:function(a,b){return this._map?this.newPointIntersects(this._map.latLngToLayerPoint(a),b):!1},newPointIntersects:function(a,b){var c=this._originalPoints,d=c?c.length:0,e=c?c[d-1]:null,f=d-2;return this._tooFewPointsForIntersection(1)?!1:this._lineSegmentsIntersectsRange(e,a,f,b?1:0)},_tooFewPointsForIntersection:function(a){var b=this._originalPoints,c=b?b.length:0;return c+=a||0,!this._originalPoints||3>=c},_lineSegmentsIntersectsRange:function(a,b,c,d){var e,f,g=this._originalPoints;d=d||0;for(var h=c;h>d;h--)if(e=g[h-1],f=g[h],L.LineUtil.segmentsIntersect(a,b,e,f))return!0;return!1}}),L.Polygon.include({intersects:function(){var a,b,c,d,e,f=this._originalPoints;return this._tooFewPointsForIntersection()?!1:(a=L.Polyline.prototype.intersects.call(this))?!0:(b=f.length,c=f[0],d=f[b-1],e=b-2,this._lineSegmentsIntersectsRange(d,c,e,1))}})}(this,document),L.Tooltip=L.Class.extend({initialize:function(a){this._map=a,this._popupPane=a._panes.popupPane,this._container=L.DomUtil.create("div","leaflet-draw-tooltip",this._popupPane),this._singleLineLabel=!1},dispose:function(){this._popupPane.removeChild(this._container),this._container=null},updateContent:function(a){return a.subtext=a.subtext||"",0!==a.subtext.length||this._singleLineLabel?a.subtext.length>0&&this._singleLineLabel&&(L.DomUtil.removeClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!1):(L.DomUtil.addClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!0),this._container.innerHTML=(a.subtext.length>0?'<span class="leaflet-draw-tooltip-subtext">'+a.subtext+"</span>"+"<br />":"")+"<span>"+a.text+"</span>",this},updatePosition:function(a){var b=this._map.latLngToLayerPoint(a);return L.DomUtil.setPosition(this._container,b),this},showAsError:function(){return L.DomUtil.addClass(this._container,"leaflet-error-draw-tooltip"),this},removeError:function(){return L.DomUtil.removeClass(this._container,"leaflet-error-draw-tooltip"),this}}),L.Tooltip.prototype.updatePosition=function(a){var b=this._map.latLngToLayerPoint(a);return L.DomUtil.setPosition(this._container,b),this._container.style.display="inline-block",this},L.Polygon.prototype.getCenter=function(){for(var a,b,c,d=this._latlngs,e=d[0],f=0,g=0,h=0,i=d.length,j=0,k=i-1;i>j;k=j++)a=d[j],b=d[k],c=(a.lat-e.lat)*(b.lng-e.lng)-(b.lat-e.lat)*(a.lng-e.lng),f+=c,g+=(a.lat+b.lat-2*e.lat)*c,h+=(a.lng+b.lng-2*e.lng)*c;return c=3*f,new L.LatLng(g/c+e.lat,h/c+e.lng)},function(a){"use strict";for(var b,c,d={},e=function(){},f="memory".split(","),g="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,time,timeEnd,trace,warn".split(",");b=f.pop();)a[b]=a[b]||d;for(;c=g.pop();)a[c]=a[c]||e}(window.console=window.console||{}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),("undefined"!=typeof module&&function(a){module.exports=a()}||"function"==typeof define&&function(a){define("underscoreDeepExtend",a)}||function(a){window.underscoreDeepExtend=a()})(function(){return function(a){return function(b){var c=/#{\s*?_\s*?}/,d=Array.prototype.slice,e=Object.prototype.hasOwnProperty;return a.each(d.call(arguments,1),function(d){for(var f in d)if(e.call(d,f))if(a.isUndefined(b[f]))b[f]=d[f];else if(a.isString(d[f])&&c.test(d[f]))a.isString(b[f])&&(b[f]=d[f].replace(c,b[f]));else if(a.isArray(b[f])||a.isArray(d[f])){if(!a.isArray(b[f])||!a.isArray(d[f]))throw"Error: Trying to combine an array with a non-array ("+f+")";b[f]=a.reject(a.deepExtend(b[f],d[f]),function(b){return a.isNull(b)})}else if(a.isObject(b[f])||a.isObject(d[f])){if(!a.isObject(b[f])||!a.isObject(d[f]))throw"Error: Trying to combine an object with a non-object ("+f+")";b[f]=a.deepExtend(b[f],d[f])}else b[f]=d[f]}),b}}}),function(){_.mixin({deepExtend:underscoreDeepExtend(_)})}(),GeotriggerEditor.module("API",function(a){a.addInitializer(function(a){if(!(a&&a.credentials&&a.credentials.clientId&&a.credentials.clientSecret))throw new Error("GeotriggerEditor requires a `credentials` object with `clientId` and `clientSecret` properties");var b={clientId:a.credentials.clientId,clientSecret:a.credentials.clientSecret,persistSession:!1};a.proxy&&(b.proxy=a.proxy),this.session=new Geotriggers.Session(b)})}),GeotriggerEditor.module("Config",function(a,b,c,d,e,f){var g={showArea:!1,shapeOptions:{stroke:!0,color:"#00b1dc",weight:2,opacity:.8,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},h={showArea:!1,shapeOptions:{color:"#00dcb1",opacity:.8,dashArray:"10, 10",weight:2,fill:!0,fillOpacity:.2}},i={showArea:!1,shapeOptions:{color:"#00dcb1",opacity:.8,stroke:!0,weight:2,fill:!0,fillOpacity:.2}},j={map:{basemap:"Streets",center:[45.516484,-122.676339],zoom:12,options:{}},fitOnLoad:!0,proxy:!1,imagePath:"/images",sharedOptions:g,editOptions:h,highlightOptions:i};a.addInitializer(function(a){b.config=f.deepExtend(j,a)})}),GeotriggerEditor.module("util",function(a){a.removeEmptyStrings=function(b){for(var c in b){if(""===b[c]&&delete b[c],b[c]instanceof Array){for(var d=!0,e=0;e<b[c].length;e++)if(""!==b[c][e]){d=!1;break}d&&delete b[c]}if("object"==typeof b[c]){b[c]=a.removeEmptyStrings(b[c]);var f=!1;for(var g in b[c]){f=!0;break}f||delete b[c]}}return b},a.isObject=function(a){return"[object Object]"===Object.prototype.toString.call(a)},a.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}}),GeotriggerEditor.module("Map.Draw",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_tools:{polygon:null,radius:null},_setup:function(){this._tools.polygon=new L.Draw.Polygon(b.map,b.config.editOptions),this._tools.radius=new L.Draw.Circle(b.map,b.config.editOptions),this._eventBindings()},_eventBindings:function(){b.vent.on("draw:new",function(a){this.editLayer(a)},this),b.vent.on("index trigger:list trigger:edit",function(){this.clear()},this),b.vent.on("trigger:new:ready",function(){var a=b.request("draw:layer");a&&b.Map.panToLayer(a)},this),b.vent.on("trigger:edit",function(a){var c=this.newShape(a);this.editLayer(c),b.Map.panToLayer(c)},this),b.map.on("draw:created",function(a){a.layerType;var c=a.layer;b.vent.trigger("draw:new",c)}),b.reqres.setHandler("draw:layer",f.bind(function(){return b.Map.Layers.edit.getLayers()[0]},this)),b.commands.setHandler("draw:clear",f.bind(function(){this.clear()},this)),b.vent.on("draw:enable",f.bind(function(a){this.enableTool(a)},this)),b.vent.on("draw:disable",f.bind(function(a){this.disableTool(a)},this))},newShape:function(a){var c=b.collections.triggers.get(a);c.get("triggerId");var d,e=c.get("condition").geo;return d=e.geojson?b.Map.polygon(e.geojson,b.config.editOptions.shapeOptions,!1).getLayers()[0]:b.Map.circle(e,b.config.editOptions.shapeOptions,!1)},editLayer:function(a){this.clear(),a.editing.enable(),b.Map.Layers.edit.addLayer(a)},clear:function(){b.Map.Layers.edit.clearLayers()},enableTool:function(a){this.disableTool(),this._tools[a].enable()},disableTool:function(a){for(var b in this._tools)("undefined"==typeof a||b===a)&&this._tools[b].disable()}}),a.addInitializer(function(){this._setup()})}),GeotriggerEditor.module("Editor",function(a,b,c,d,e,f){var g=d.AppRouter.extend({appRoutes:{"":"index",list:"list","list?q=:term":"list","new":"new",":id/edit":"edit","*notfound":"notFound"}}),h=function(){b.collections=b.collections||{},b.collections.triggers=new b.Collections.Triggers,b.collections.notifications=new b.Collections.Notifications};f.extend(h.prototype,{start:function(){this.setup(),b.vent.trigger("notify","Loading Geotriggers"),b.collections.triggers.fetch({reset:!0,success:function(){b.vent.trigger("notify:clear"),c.history.start(),b.config.fitOnLoad&&!c.history.fragment.match("edit")&&b.execute("map:fit")}}),b.vent.on("draw:new",function(){"new"===c.history.fragment||c.history.fragment.match("edit")||b.router.navigate("new",{trigger:!0})},this),b.vent.on("trigger:create",this.createTrigger,this),b.vent.on("trigger:update",this.updateTrigger,this),b.vent.on("trigger:destroy",this.deleteTrigger,this)},setup:function(){this.setupMap(),this.setupDrawer(),this.setupControls(),this.setupNotifications()},setupMap:function(){var a=new b.Views.Map({collection:b.collections.triggers});b.regions.map.show(a)},setupDrawer:function(){var a=b.regions.drawer,c=b.mainRegion.$el.find("#gt-content");a.on("show",function(){c.addClass("gt-active")}),a.on("close",function(){c.removeClass("gt-active")})},setupControls:function(){var a=new b.Views.Controls;b.regions.controls.show(a)},setupNotifications:function(){var a=new b.Views.NotificationList({collection:b.collections.notifications});b.regions.notes.show(a),b.vent.on("notify",function(a){"string"==typeof a&&(a={type:"info",message:a});var c=new b.Models.Notification(a);b.collections.notifications.add(c)},this)},index:function(){b.vent.trigger("index"),b.regions.drawer.close()},list:function(a){if(b.regions.drawer.$el&&b.regions.drawer.$el.has(".gt-list").length)a||b.vent.trigger("trigger:list:reset");else{b.vent.trigger("trigger:list");var d=new c.Model({count:b.collections.triggers.length}),e=new b.Views.List({model:d,collection:b.collections.triggers});b.regions.drawer.show(e)}a&&(a=decodeURIComponent(a.replace(/\+/g,"%20")),b.vent.trigger("trigger:list:search",a))},"new":function(){b.vent.trigger("trigger:new");var a=new b.Views.Form;b.regions.drawer.show(a),b.vent.trigger("trigger:new:ready")},edit:function(a){var c=this.getTrigger(a);if(c){var d=new b.Views.Form({model:c});b.regions.drawer.show(d),b.vent.trigger("trigger:edit",a)}else this.notFound()},notFound:function(){b.vent.trigger("notify",{type:"error",message:"404: Not Found"})},createTrigger:function(a){b.collections.triggers.once("add",function(){b.router.navigate("list",{trigger:!0})}),b.collections.triggers.create(a,{wait:!0})},getTrigger:function(a){var c=b.collections.triggers.get(a);return c},updateTrigger:function(a){b.collections.triggers.once("change",function(){b.router.navigate("list",{trigger:!0})});var c=b.collections.triggers.get(a.triggerId);c.set(a),c.save()},deleteTrigger:function(a){b.collections.triggers.once("remove",function(){c.history.fragment.match("edit")&&b.router.navigate("list",{trigger:!0})}),a.destroy()}}),a.addInitializer(function(){var a=new h;b.router=new g({controller:a}),a.start()})}),GeotriggerEditor.module("Map.Layers",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_setup:function(){this.main=new L.FeatureGroup,b.map.addLayer(this.main),this.edit=new L.FeatureGroup,b.map.addLayer(this.edit)}}),a.addInitializer(function(){this._setup()})}),GeotriggerEditor.module("Map",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_setup:function(a){if(a.proxy&&(L.esri.get=L.esri.RequestHandlers.JSONP),b.map=this.map=L.map(a.el).setView(b.config.map.center,b.config.map.zoom),this.map.zoomControl.setPosition("topright"),b.util.isArray(b.config.map.basemaps))for(var c=0;c<b.config.map.basemaps.length;c++)L.esri.basemapLayer(b.config.map.basemaps[c],b.config.map.options).addTo(b.map);else L.esri.basemapLayer(b.config.map.basemap,b.config.map.options).addTo(b.map);this.Layers.start(),this._eventBindings()},_eventBindings:function(){b.commands.setHandler("map:fit",f.bind(function(){var a=this.Layers.main.getBounds(),b=this.getDrawerWidth();this.map.fitBounds(a,{animate:!1,paddingTopLeft:[b,0]})},this))},getDrawerWidth:function(){var a=b.mainRegion.$el.find("#gt-content"),c=a.find("#gt-drawer-region");return a.hasClass("gt-active")?c.width():0},panToLayer:function(a){var b;a.getLatLng?b=a.getLatLng():a.getCenter&&(b=a.getCenter());var c=this.getDrawerWidth();if(c){var d=this.map.project(b);d.x=d.x-c/2,b=this.map.unproject(d)}b&&this.map.panTo(b,{animate:!0})},removeShape:function(a){this.map.removeLayer(a)},focusShape:function(a){a.setStyle(b.config.highlightOptions.shapeOptions)},unfocusShape:function(a){a.setStyle(b.config.sharedOptions.shapeOptions)},polygon:function(a,c,d){c=c||b.config.sharedOptions.shapeOptions;var e=new L.GeoJSON(a,{style:function(){return c}});return d!==!1&&this.Layers.main.addLayer(e),e},circle:function(a,c,d){c=c||b.config.sharedOptions.shapeOptions;var e=L.circle([a.latitude,a.longitude],a.distance,c);return d!==!1&&this.Layers.main.addLayer(e),e}}),a.addInitializer(function(a){this._setup(a),this.Draw.start()})}),GeotriggerEditor.module("Models",function(a,b,c){a.Notification=c.Model.extend({defaults:{type:"info",message:"everything's fine"}})}),GeotriggerEditor.module("Models",function(a,b,c,d,e,f){function g(a){var b="Error creating trigger",c=JSON.stringify(a);return null!==c.match("Coordinate values are out of range")&&(b="Coordinate values are out of range"),null!==c.match("no triggers found")&&(b="Deleted triggers can't be updated"),null!==c.match("Error performing intersection")&&(b="Polygons can't intersect themselves"),null!==c.match("message:Not a valid parameter for this request")&&(b="Notifications must have a valid message"),b}a.Trigger=c.Model.extend({idAttribute:"triggerId",sync:function(a,c,d){var e,h=this.get("triggerId"),i=f.bind(function(c,e){c?(b.vent.trigger("notify",{type:"error",message:g(c)}),d&&d.error&&d.error("Record Not Found")):("read"!==a&&b.vent.trigger("notify",{message:"Trigger "+a+"d successfully",timeout:3500}),d&&d.success&&d.success(e))},this);switch(a){case"read":b.API.session.request("trigger/list",{triggerIds:[h]},i);break;case"create":e={properties:this.get("properties"),condition:this.get("condition"),action:this.get("action"),setTags:this.get("tags")},b.API.session.request("trigger/create",e,i);break;case"update":e={properties:this.get("properties"),triggerIds:h,condition:this.get("condition"),action:this.get("action"),setTags:this.get("tags")},b.API.session.request("trigger/update",e,i);break;case"delete":b.API.session.request("trigger/delete",{triggerIds:h},i);break;default:throw new Error("Unsupported method: "+a)}},parse:function(a){return a.triggers?a.triggers:a}})}),GeotriggerEditor.module("Collections",function(a,b,c){a.Notifications=c.Collection.extend({model:b.Models.Notification})}),GeotriggerEditor.module("Collections",function(a,b,c,d,e,f){a.Triggers=c.Collection.extend({model:b.Models.Trigger,fetch:function(a){var c=f.bind(function(b,c){a.reset?this.reset(this.parse(c)):this.set(this.parse(c)),a.success&&a.success(this,this.parse(c),a)},this);b.API.session.request("trigger/list",c)},parse:function(a){return a.triggers}})}),GeotriggerEditor.module("Layouts",function(a,b,c){a.Main=c.Marionette.Layout.extend({template:b.Templates.main,id:"gt-regions",regions:{controls:"#gt-controls-region",drawer:"#gt-drawer-region",map:"#gt-map-region",notes:"#gt-notes-region"}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Controls=d.ItemView.extend({template:b.Templates.controls,className:"gt-control-group",events:{"click .gt-tool-list":"toggleList","click .gt-tool-create":"toggleNew","click .gt-tool-polygon":"togglePolygon","click .gt-tool-radius":"toggleRadius"},ui:{drawers:".gt-drawer-controls",tools:".gt-tool-controls",list:".gt-drawer-controls .gt-tool-list",create:".gt-drawer-controls .gt-tool-create",polygon:".gt-tool-controls .gt-tool-polygon",radius:".gt-tool-controls .gt-tool-radius",all:".gt-tool"},onRender:function(){this.listenTo(b.router,"route",this.handleStateChange),this.listenTo(b.vent,"draw:new",this.disableTool),this.listenTo(b.vent,"draw:enable",function(a){this.activate(a)}),this.listenTo(b.vent,"draw:disable",function(){this.ui.tools.find(".gt-tool").removeClass("gt-active")})},handleStateChange:function(a){switch(this.clear("drawers"),a){case"new":this.activate("list");break;case"edit":this.activate("list");break;case"list":this.activate("list")}},toggleList:function(a){this.ui.list.hasClass("gt-active")&&(a.preventDefault(),b.router.navigate("",{trigger:!0}))},toggleNew:function(a){this.ui.create.hasClass("gt-active")&&(a.preventDefault(),b.router.navigate("",{trigger:!0}))},togglePolygon:function(){this.ui.polygon.hasClass("gt-active")?this.disableTool("polygon"):this.enableTool("polygon")},toggleRadius:function(){this.ui.radius.hasClass("gt-active")?this.disableTool("radius"):this.enableTool("radius")},enableTool:function(a){this.disableTool(),b.vent.trigger("draw:enable",a)},disableTool:function(a){b.vent.trigger("draw:disable",a)},activate:function(a){this.ui[a].addClass("gt-active")},toggle:function(a){"list"===a?(this.ui.list.toggleClass("gt-active"),this.ui.create.removeClass("gt-active")):"create"===a&&(this.ui.create.toggleClass("gt-active"),this.ui.list.removeClass("gt-active"))},clear:function(a){"drawers"===a?this.ui.drawers.find(".gt-tool").removeClass("gt-active"):"tools"===a?this.ui.tools.find(".gt-tool").removeClass("gt-active"):this.ui.all.removeClass("gt-active")}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e){a.Form=d.ItemView.extend({template:b.Templates["form/index"],className:"gt-panel",events:{"click .gt-add-title":"addTitle","click .gt-remove-title":"removeTitle","click .gt-add-action":"addAction","click .gt-remove-action":"removeAction","click .gt-add-notification":"addNotification","click .gt-remove-notification":"removeNotification","click .gt-submit":"parseForm","click .gt-item-delete":"confirmDelete","click .gt-reset-delete":"resetDelete","click .gt-item-confirm-delete":"destroyModel"},ui:{actions:".gt-actions",addAction:".gt-add-action",form:"form",deleteItem:".gt-item-delete",confirm:".gt-item-confirm-delete",reset:".gt-reset-delete"},onShow:function(){this.model?this.buildEditForm():this.buildNewForm(),this.listenTo(b.vent,"draw:new",this.parseShape)},buildNewForm:function(){var a=this.serializeData(),c="",d="";this.parseShape(),c=b.Templates["form/actions/notification/index"](a),d=b.Templates["form/actions/notification/text"](a),this.ui.actions.html(c),this.ui.actions.find(".gt-notification-actions").html(d),this.ui.form.find('.gt-add-action[data-action="notification"]').hide(),this.ui.form.find('.gt-add-notification[data-notification="text"]').hide()},buildEditForm:function(){var a,c=this.model.get("action"),d=this.serializeData(),e="",f="";if(c.hasOwnProperty("notification")){e+=b.Templates["form/actions/notification/index"](d),this.ui.form.find('.gt-add-action[data-action="notification"]').hide();for(a in c.notification)c.notification.hasOwnProperty(a)&&(f+=b.Templates["form/actions/notification/"+a](d))}if(c.hasOwnProperty("callbackUrl")&&(e+=b.Templates["form/actions/callbackUrl"](d),this.ui.form.find('.gt-add-action[data-action="callbackUrl"]').hide()),c.hasOwnProperty("trackingProfile")&&(e+=b.Templates["form/actions/trackingProfile"](d),this.ui.form.find('.gt-add-action[data-action="trackingProfile"]').hide()),this.ui.actions.html(e),""!==f){this.ui.actions.find(".gt-notification-actions").html(f);for(a in c.notification)if(c.notification.hasOwnProperty(a)){var g=this.ui.form.find('.gt-add-notification[data-notification="'+a+'"]');g.hide()}}},addTitle:function(a){a&&a.preventDefault&&a.preventDefault(),e(a.target).addClass("gt-hide"),this.$el.find(".gt-title").removeClass("gt-hide")},removeTitle:function(a){a&&a.preventDefault&&a.preventDefault(),e(a.target).closest(".gt-property").addClass("gt-hide"),this.ui.form.find('input[name="properties[title]"]').val(""),this.ui.form.find(".gt-add-title").removeClass("gt-hide")},addAction:function(a){var c,d,f,g;"object"==typeof a&&a.preventDefault?(a.preventDefault(),c=e(a.target),d=c.data("action")):"string"==typeof a&&(d=a,c=this.ui.form.find(".gt-add-action[data-action='"+d+"']")),"notification"===d?(f=b.Templates["form/actions/notification/index"]({}),g=b.Templates["form/actions/notification/text"]({}),this.ui.actions.append(f),this.ui.actions.find(".gt-notification-actions").html(g),this.ui.form.find('.gt-add-notification[data-notification="text"]').hide()):(f=b.Templates["form/actions/"+d]({}),this.ui.actions.append(f)),c.hide()},removeAction:function(a){var b,c;
"object"==typeof a&&a.preventDefault?(a.preventDefault(),b=e(a.target).closest(".gt-property"),c=b.data("action")):"string"==typeof a&&(c=a,b=this.ui.form.find(".gt-property[data-action='"+c+"']")),b.remove(),this.ui.form.find('.gt-add-action[data-action="'+c+'"]').show()},addNotification:function(a){a&&a.preventDefault&&a.preventDefault();var c=e(a.target),d=c.data("notification"),f=b.Templates["form/actions/notification/"+d]({});this.ui.actions.find(".gt-notification-actions").append(f),c.hide()},removeNotification:function(a){a&&a.preventDefault&&a.preventDefault();var b=e(a.target).closest(".gt-notification-action"),c=b.data("notification");b.remove(),this.ui.form.find('.gt-add-notification[data-notification="'+c+'"]').show()},parseShape:function(){var a=b.request("draw:layer"),c=this.ui.form.find('[name="condition[direction]"]'),d=this.ui.form.find('[name="geometry-type"]'),e=this.ui.form.find(".gt-shape-indicator"),f=this.ui.form.find(".gt-form-section");null===c.val()&&c.val("enter"),a instanceof L.Polygon?(d.val("polygon"),e.text("a polygon"),f.show()):a instanceof L.Circle?(d.val("radius"),e.text("a radius"),f.show()):f.filter(":not(:first-child)").hide()},parseForm:function(a){a&&a.preventDefault&&a.preventDefault();var c=this.ui.form.serializeObject();if(c=b.util.removeEmptyStrings(c),c.tags){var d=c.tags;d=d.split(",");for(var e=d.length-1;e>0;e--)d[e]=d[e].trim();c.tags=d}!c.condition||!c.condition.geo,c.action&&(c.action.trackingProfile||(c.action.trackingProfile=null),c.action.callbackUrl||(c.action.callbackUrl=null)),c&&c.tags&&c.condition&&c.action&&this.createOrUpdateTrigger(c)},createOrUpdateTrigger:function(a){var c=b.request("draw:layer");if(c instanceof L.Polygon)a.condition.geo={geojson:c.toGeoJSON()};else{if(!(c instanceof L.Circle))throw new Error("Invalid layer data");var d=c.getLatLng();a.condition.geo={latitude:d.lat,longitude:d.lng,distance:c.getRadius()}}this.model?(a.triggerId=this.model.get("triggerId"),b.vent.trigger("trigger:update",a)):b.vent.trigger("trigger:create",a)},confirmDelete:function(a){a&&a.preventDefault&&a.preventDefault(),this.ui.deleteItem.addClass("gt-item-confirm-delete"),this.ui.reset.addClass("gt-reset-flyout-right")},resetDelete:function(a){a&&a.preventDefault&&a.preventDefault(),this.ui.deleteItem.removeClass("gt-item-confirm-delete"),this.ui.reset.removeClass("gt-reset-flyout-right")},destroyModel:function(a){a&&a.preventDefault&&a.preventDefault(),b.vent.trigger("trigger:destroy",this.model)}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e){a.ListItem=d.ItemView.extend({template:b.Templates.item,tagName:"li",className:"gt-result",events:{"click .gt-item-edit":"editItem","click .gt-tags":"tagsClick","click .gt-delete-icon":"confirmDelete","click .gt-cancel-delete":"resetDelete","click .gt-confirm-delete":"destroyModel",mouseover:"focusShape",mouseout:"unfocusShape"},ui:{deleteItem:".gt-list-delete",confirm:".gt-item-confirm-delete",reset:".gt-reset-delete"},modelEvents:{change:"modelChanged"},modelChanged:function(){this.render()},editItem:function(){var a=this.model.get("triggerId");b.router.navigate(a+"/edit",{trigger:!0})},tagsClick:function(a){a.stopPropagation()},confirmDelete:function(a){a.preventDefault(),a.stopPropagation(),this.ui.deleteItem.addClass("gt-visible")},resetDelete:function(a){a.preventDefault(),a.stopPropagation(),this.ui.deleteItem.removeClass("gt-visible")},destroyModel:function(a){a.preventDefault(),a.stopPropagation(),b.vent.trigger("trigger:destroy",this.model)},focusShape:function(){var a=this.model.get("triggerId");b.vent.trigger("trigger:focus",a)},unfocusShape:function(){var a=this.model.get("triggerId");b.vent.trigger("trigger:unfocus",a)}}),a.Empty=d.ItemView.extend({template:b.Templates.empty,className:"gt-list-empty"}),a.List=d.CompositeView.extend({template:b.Templates.list,className:"gt-list gt-panel",itemView:a.ListItem,itemViewContainer:".gt-results",emptyView:a.Empty,events:{"keyup .gt-search":"filter"},ui:{header:".gt-list-header",search:".gt-search input",results:".gt-results"},onShow:function(){this.refresh(),this.listenTo(this.collection,"change reset add remove",this.refresh),this.listenTo(b.vent,"trigger:list:search",this.search),this.listenTo(b.vent,"trigger:list:reset",this.clearFilter)},refresh:function(){var a=this.collection.length;this.model.set("count",a),this.render(),a?this.ui.header.removeClass("gt-hide"):this.ui.header.addClass("gt-hide")},search:function(a){this.ui.search.val(a),this.filter()},clearFilter:function(){this.ui.search.val(""),this.$el.removeClass("gt-filtering")},filter:function(a){var d=this.ui.search.val();if(d.length)if("undefined"!=typeof a&&13===a.keyCode)b.router.navigate("list?q="+encodeURIComponent(d).replace(/%20/g,"+"),{trigger:!0});else{this.$el.addClass("gt-filtering");var f=this.ui.results.find(".gt-result"),g=this.ui.search.val().split(/\s+/),h="(?=.*"+g.join(")(?=.*")+")",i=new RegExp(h,"i");f.each(function(){var a=e(this),b=a.find(".gt-tags a"),c="";c+=a.find(".gt-item-edit span").text(),c+=a.find(".gt-id").text(),c+=a.find(".gt-item-details span").text(),b.each(function(){c+=e(this).text()}),i.exec(c)?a.addClass("gt-list-visible"):a.removeClass("gt-list-visible")})}else this.$el.removeClass("gt-filtering"),"list"!==c.history.fragment&&b.router.navigate("list",{trigger:!1})}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e,f){a.Shape=d.View.extend({modelEvents:{change:"render"},render:function(){return this.isClosed=!1,this.triggerMethod("before:render",this),this.triggerMethod("item:before:render",this),this.renderShape(),this.triggerMethod("render",this),this.triggerMethod("item:rendered",this),this},renderShape:function(){this.model.get("triggerId");var a=this.model.get("condition").geo;this.removeShape(),this._shape=a.geojson?b.Map.polygon(a.geojson):b.Map.circle(a),this._shape.on("click",f.bind(function(){b.router.navigate(this.model.id+"/edit",{trigger:!0})},this)),this._shape.on("mouseover",f.bind(function(){b.Map.focusShape(this._shape)},this)),this._shape.on("mouseout",f.bind(function(){b.Map.unfocusShape(this._shape)},this))},removeShape:function(){this._shape&&(b.Map.removeShape(this._shape),delete this._shape)},focusShape:function(){this._shape&&b.Map.focusShape(this._shape)},unfocusShape:function(){this._shape&&b.Map.unfocusShape(this._shape)},onClose:function(){this.removeShape()}}),a.Map=d.CollectionView.extend({id:"gt-map",itemView:a.Shape,onShow:function(){b.Map.start({el:this.el}),this.listenTo(b.vent,"trigger:edit",this.hideShape),this.listenTo(b.vent,"index trigger:new trigger:list trigger:edit",this.restore),this.listenTo(b.vent,"trigger:focus",this.focusShape),this.listenTo(b.vent,"trigger:unfocus",this.unfocusShape)},hideShape:function(a){var c=b.collections.triggers.get(a),d=this.children.findByModel(c);d.removeShape()},focusShape:function(a){var c=b.collections.triggers.get(a),d=this.children.findByModel(c);d.focusShape()},unfocusShape:function(a){var c=b.collections.triggers.get(a),d=this.children.findByModel(c);d.unfocusShape()},restore:function(a){this.children.each(function(b){if(!b._shape){var c=b.model.get("triggerId");a&&c===a||b.render()}})}})}),GeotriggerEditor.module("Views",function(a,b,c,d,e,f){a.Notification=d.ItemView.extend({template:b.Templates.notification,className:"gt-notification",tagName:"li",events:{"click .gt-close":"destroyNotification"},render:function(){d.ItemView.prototype.render.apply(this,arguments);var a=this.model.get("type")||"info";this.$el.addClass(a),this.listenTo(b.vent,"notify:clear",this.destroyNotification)},onShow:function(){this.$el.fadeIn();var a=this.model.get("timeout");"number"==typeof a&&setTimeout(f.bind(function(){this.destroyNotification()},this),a)},destroyNotification:function(){this.$el.fadeOut(f.bind(function(){this.model.destroy()},this))}}),a.NotificationList=d.CollectionView.extend({itemView:a.Notification,className:"gt-notification-list",tagName:"ul"})});