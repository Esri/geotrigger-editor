/*! geotrigger-editor - v0.2.2 - 2016-02-03
*   https://github.com/Esri/geotrigger-editor
*   Copyright (c) 2016 Environmental Systems Research Institute, Inc.
*   Apache 2.0 License */

!function(){this.Geotrigger=this.Geotrigger||{},this.Geotrigger.Editor=new Backbone.Marionette.Application,Geotrigger.Editor.addInitializer(function(a){this.Config.start(a),this.API.start(),this.regions=new this.Layouts.Main,this.addRegions({mainRegion:this.config.el}),this.mainRegion.show(this.regions)}),this.Geotrigger=this.Geotrigger||{},this.Geotrigger.Editor=this.Geotrigger.Editor||{},this.Geotrigger.Editor.Templates=this.Geotrigger.Editor.Templates||{},this.Geotrigger.Editor.Templates.controls=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},'<div class="gt-drawer-controls">\n<a href="#list" class="gt-tool gt-tool-list active gt-tooltip">\n<span>List</span>\n</a>\n</div>\n<div class="gt-tool-controls">\n<button class="gt-tool gt-tool-polygon gt-tooltip">\n<span>New Polygon Tool</span>\n</button>\n<button class="gt-tool gt-tool-radius gt-tooltip">\n<span>New Radius Tool</span>\n</button>\n</div>\n'}),this.Geotrigger.Editor.Templates.empty=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},'<div class="gt-panel-top-bar">\n<h3 class="gt-panel-top-bar-left">List\n<span class="gt-trigger-count"></span>\n</h3>\n<a href="#" class="gt-panel-top-bar-button gt-close-drawer"></a>\n</div>\n\n<div class="gt-panel-no-triggers">\n<h5>This application doesn\'t have any Geotrigger rules yet.</h5>\n</div>\n\n<ul class="gt-tool-descriptions">\n<li class="gt-tool-description">\n<span class="gt-icon gt-icon-create"></span>\n<h5>Create a New Trigger</h5>\n<p>Create a new Geotrigger rule by first using one of the drawing tools, then defining its properties in the form that appears.</p>\n</li>\n\n<li class="gt-tool-description">\n<span class="gt-icon gt-icon-polygon"></span>\n<h5>Using the Polygon Tool</h5>\n<p>Click on the map to create each point of a polygon. Click on the first point you created to close the shape.</p>\n</li>\n\n<li class="gt-tool-description">\n<span class="gt-icon gt-icon-radius"></span>\n<h5>Using the Radius Tool</h5>\n<p>Click a point on the map, then hold and drag to define a radius around that point.</p>\n</li>\n</ul>\n'}),this.Geotrigger.Editor.Templates["form/actions/callbackUrl"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-action=\"callbackUrl\" class='gt-property'>\n<div class=\"gt-property-header\">\nnotify this URL\n<a class=\"gt-remove-action gt-delete-icon\"></a>\n</div>\n\n<div class=\"gt-property-item\">\n<input class='gt-input-fill' type='text' name='action[callbackUrl]' placeholder='http://' value='"+i((f=b&&b.action,f=null==f||f===!1?f:f.callbackUrl,typeof f===h?f.apply(b):f))+"'>\n</div>\n</div>\n"}),this.Geotrigger.Editor.Templates["form/actions/notification/data"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g,h="",i=c.helperMissing,j=this.escapeExpression;return h+="<div data-notification='data' class='gt-property-item gt-notification-action'>\n<label class=\"gt-notification-left\" for='action[notification][data]'>\n<span class='gt-label-left'>some data:</span>\n</label>\n\n<div class=\"gt-notification-center\">\n<textarea class='gt-input' name='action[notification][data]' placeholder='{ \"your\": \"data\" }'>",g={hash:{},data:e},h+=j((f=c.stringify||b&&b.stringify,f?f.call(b,(f=b&&b.action,f=null==f||f===!1?f:f.notification,null==f||f===!1?f:f.data),g):i.call(b,"stringify",(f=b&&b.action,f=null==f||f===!1?f:f.notification,null==f||f===!1?f:f.data),g)))+"</textarea>\n</div>\n\n<div class='gt-notification-right'>\n<a class=\"gt-remove-notification gt-delete-icon\"></a>\n</div>\n</div>\n"}),this.Geotrigger.Editor.Templates["form/actions/notification/icon"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='icon' class='gt-property-item gt-notification-action'>\n<label class=\"gt-notification-left\" for='action[notification][icon]'>\n<span class='gt-label-left'>an icon:</span>\n</label>\n\n<div class='gt-notification-center'>\n<input class='gt-input' type='text' name='action[notification][icon]' placeholder='icon' value='"+i((f=b&&b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.icon,typeof f===h?f.apply(b):f))+"'>\n</div>\n\n<div class='gt-notification-right'>\n<a class=\"gt-remove-notification gt-delete-icon\"></a>\n</div>\n</div>\n"}),this.Geotrigger.Editor.Templates["form/actions/notification/index"]=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},'<div data-action="notification" class="gt-property">\n<div class="gt-property-header">\nsend a notification to the device with..\n<a class="gt-remove-action gt-delete-icon"></a>\n</div>\n\n<div class="gt-notification-actions"></div>\n\n<div class="gt-property-item gt-btn-group">\n<button data-notification="text" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; a message</button>\n<button data-notification="url" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; a URL</button>\n<button data-notification="data" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; some data</button>\n<button data-notification="icon" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; an icon</button>\n<button data-notification="sound" class="gt-button gt-button-light-gray gt-button-small gt-add-notification">&#043; a sound</button>\n</div>\n</div>\n'}),this.Geotrigger.Editor.Templates["form/actions/notification/sound"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='sound' class='gt-property-item gt-notification-action'>\n<label class=\"gt-notification-left\" for='action[notification][sound]'>\n<span class='gt-label-left'>a sound:</span>\n</label>\n\n<div class='gt-notification-center'>\n<input class='gt-input' type='text' name='action[notification][sound]' placeholder='sound' value='"+i((f=b&&b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.sound,typeof f===h?f.apply(b):f))+"'>\n</div>\n\n<div class='gt-notification-right'>\n<a class=\"gt-remove-notification gt-delete-icon\"></a>\n</div>\n</div>\n"}),this.Geotrigger.Editor.Templates["form/actions/notification/text"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='text' class='gt-property-item gt-notification-action'>\n<label class=\"gt-notification-left\" for='action[notification][text]'>\n<span class='gt-label-left'>a message:</span>\n</label>\n\n<div class='gt-notification-center'>\n<textarea class='gt-action-message-box' name='action[notification][text]' placeholder='message'>"+i((f=b&&b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.text,typeof f===h?f.apply(b):f))+"</textarea>\n</div>\n\n<div class='gt-notification-right'>\n<a class=\"gt-remove-notification gt-delete-icon\"></a>\n</div>\n</div>\n"}),this.Geotrigger.Editor.Templates["form/actions/notification/url"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+="<div data-notification='url' class='gt-property-item gt-notification-action'>\n<label class=\"gt-notification-left\" for='action[notification][url]'>\n<span class='gt-label-left'>a URL:</span>\n</label>\n\n<div class='gt-notification-center'>\n<input class='gt-input' type='text' name='action[notification][url]' placeholder='http://' value='"+i((f=b&&b.action,f=null==f||f===!1?f:f.notification,f=null==f||f===!1?f:f.url,typeof f===h?f.apply(b):f))+"'>\n</div>\n\n<div class='gt-notification-right'>\n<a class=\"gt-remove-notification gt-delete-icon\"></a>\n</div>\n</div>\n"}),this.Geotrigger.Editor.Templates["form/actions/trackingProfile"]=Handlebars.template(function(a,b,c,d,e){function f(a,b){return'\n<option value="fine">[3] fine</option>\n<option value="adaptive">[2] adaptive</option>\n<option value="rough">[1] rough</option>\n<option value="off">[0] off</option>\n'}this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var g,h,i,j="",k=this,l=c.helperMissing;return j+='<div data-action="trackingProfile" class="gt-property">\n<div class="gt-property-header">\nchange the device\'s tracking profile\n<a class="gt-remove-action gt-delete-icon"></a>\n</div>\n\n<div class="gt-property-item">\n<select class="gt-select-full" name="action[trackingProfile]">\n',i={hash:{},inverse:k.noop,fn:k.program(1,f,e),data:e},g=c.select||b&&b.select,h=g?g.call(b,(g=b&&b.action,null==g||g===!1?g:g.trackingProfile),i):l.call(b,"select",(g=b&&b.action,null==g||g===!1?g:g.trackingProfile),i),(h||0===h)&&(j+=h),j+="\n</select>\n</div>\n</div>\n"}),this.Geotrigger.Editor.Templates["form/extras/properties"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g,h="",i=c.helperMissing,j=this.escapeExpression;return h+='<div data-extra="properties" class="gt-property">\n<div class="gt-property-header">\nproperties <small>arbitrary JSON object saved with the trigger</small>\n<a class="gt-remove-extra gt-delete-icon"></a>\n</div>\n\n<div class="gt-property-item">\n<textarea class="gt-input" name="properties" placeholder=\'{ "property": "value" }\'>',g={hash:{},data:e},h+=j((f=c.stringify||b&&b.stringify,f?f.call(b,b&&b.properties,g):i.call(b,"stringify",b&&b.properties,g)))+"</textarea>\n</div>\n</div>\n"}),this.Geotrigger.Editor.Templates["form/extras/rateLimit"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+='<div data-extra="rateLimit" class="gt-property">\n<div class="gt-property-header">\nrate limit <small>minimum number of seconds between executions, per device</small>\n<a class="gt-remove-extra gt-delete-icon"></a>\n</div>\n\n<div class="gt-property-item">\n<input class="gt-input-fill" type="text" name="rateLimit" placeholder="0" value="',(f=c.rateLimit)?f=f.call(b,{hash:{},data:e}):(f=b&&b.rateLimit,f=typeof f===h?f.call(b,{hash:{},data:e}):f),g+=i(f)+'">\n</div>\n</div>\n'}),this.Geotrigger.Editor.Templates["form/extras/times"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+='<div data-extra="times" class="gt-property">\n<div class="gt-property-header">\ntimes <small>maximum number of executions, per device</small>\n<a class="gt-remove-extra gt-delete-icon"></a>\n</div>\n\n<div class="gt-property-item">\n<input class="gt-input-fill" type="text" name="times" placeholder="0" value="',(f=c.times)?f=f.call(b,{hash:{},data:e}):(f=b&&b.times,f=typeof f===h?f.call(b,{hash:{},data:e}):f),g+=i(f)+'">\n</div>\n</div>\n'}),this.Geotrigger.Editor.Templates["form/extras/triggerId"]=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+='<div data-extra="triggerId" class="gt-property">\n<div class="gt-property-header">\nTrigger ID\n<a class="gt-remove-extra gt-delete-icon"></a>\n</div>\n\n<div class="gt-property-item">\n<input class="gt-input-fill" type="text" name="triggerId" placeholder="custom trigger ID" value="',(f=c.triggerId)?f=f.call(b,{hash:{},data:e}):(f=b&&b.triggerId,f=typeof f===h?f.call(b,{hash:{},data:e}):f),g+=i(f)+'">\n</div>\n</div>\n'}),this.Geotrigger.Editor.Templates["form/index"]=Handlebars.template(function(a,b,c,d,e){function f(a,b){var d;return(d=c.triggerId)?d=d.call(a,{hash:{},data:b}):(d=a&&a.triggerId,d=typeof d===r?d.call(a,{hash:{},data:b}):d),s(d)}function g(a,b){return"Create"}function h(a,b){return"\n<option value='enter'>enters</option>\n<option value='leave'>leaves</option>\n"}function i(a,b){var d,e,f="";return f+='\n<span class="gt-shape-indicator">a ',e={hash:{},data:b},f+=s((d=c.shape||a&&a.shape,d?d.call(a,a&&a.condition,e):t.call(a,"shape",a&&a.condition,e)))+"</span>\n"}function j(a,b){return'\n<span class="gt-shape-indicator">a...</span>\n'}function k(a,b){return'\n<button data-extra="triggerId" class="gt-button gt-button-light-gray gt-button-small gt-add-extra">&#043; custom trigger ID</button>\n'}function l(a,b){return"\n<button class='gt-button gt-button-blue gt-submit'>Update</button>\n<ul class='gt-edit-controls'>\n<li>\n<a class='gt-reset-delete' href='#'>&#x2716;</a>\n</li>\n<li>\n<button class='gt-item-delete gt-button-delete'></button>\n</li>\n</ul>\n"}function m(a,b){return"\n<button class='gt-button gt-button-blue gt-submit'>Save</button>\n"}this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var n,o,p,q="",r="function",s=this.escapeExpression,t=c.helperMissing,u=this;return q+="<div class='gt-panel-top-bar'>\n<a href='#list' class='gt-panel-top-bar-button gt-back-to-list'></a>\n<h3>",n=c["if"].call(b,b&&b.triggerId,{hash:{},inverse:u.program(3,g,e),fn:u.program(1,f,e),data:e}),(n||0===n)&&(q+=n),q+="</h3>\n<a href='#' class='gt-panel-top-bar-button gt-close-drawer'></a>\n</div>\n\n<div class='gt-panel-content'>\n<form class='gt-form gt-form-edit'>\n\n<section class='gt-form-section gt-conditions'>\n<div class=\"gt-property\">\n<div class=\"gt-property-header\">When a device with one of the following tags..</div>\n\n<div class=\"gt-property-item\">\n<textarea class='gt-input' name='tags' placeholder='enter any number of tags separated by commas'>",p={hash:{},data:e},q+=s((n=c.tagList||b&&b.tagList,n?n.call(b,b&&b.tags,p):t.call(b,"tagList",b&&b.tags,p)))+"</textarea>\n</div>\n\n<div class=\"gt-property-item\">\n<select name='condition[direction]' class='gt-direction'>\n",p={hash:{},inverse:u.noop,fn:u.program(5,h,e),data:e},n=c.select||b&&b.select,o=n?n.call(b,(n=b&&b.condition,null==n||n===!1?n:n.direction),p):t.call(b,"select",(n=b&&b.condition,null==n||n===!1?n:n.direction),p),(o||0===o)&&(q+=o),q+="\n</select>\n\n",o=c["if"].call(b,b&&b.condition,{hash:{},inverse:u.program(9,j,e),fn:u.program(7,i,e),data:e}),(o||0===o)&&(q+=o),q+='\n<input name="geometry-type" type="hidden" value="',p={hash:{},data:e},q+=s((n=c.shape||b&&b.shape,n?n.call(b,b&&b.condition,p):t.call(b,"shape",b&&b.condition,p)))+'">\n</div>\n</div>\n</section>\n\n<section class="gt-form-section gt-actions"></section>\n\n<section class="gt-form-section gt-action-toggles">\n<button data-action="notification" class="gt-button gt-button-light-gray gt-button-small gt-add-action">&#043; send a notification</button>\n<button data-action="callbackUrl" class="gt-button gt-button-light-gray gt-button-small gt-add-action">&#043; post to a callback URL</button>\n<button data-action="trackingProfile" class="gt-button gt-button-light-gray gt-button-small gt-add-action">&#043; change the tracking profile</button>\n</section>\n\n<section class="gt-form-section gt-extras"></section>\n\n<section class="gt-form-section gt-trigger-extra-toggles">\n<button data-extra="properties" class="gt-button gt-button-light-gray gt-button-small gt-add-extra">&#043; properties</button>\n<button data-extra="rateLimit" class="gt-button gt-button-light-gray gt-button-small gt-add-extra">&#043; rate limit</button>\n<button data-extra="times" class="gt-button gt-button-light-gray gt-button-small gt-add-extra">&#043; times</button>\n\n',o=c.unless.call(b,b&&b.triggerId,{hash:{},inverse:u.noop,fn:u.program(11,k,e),data:e}),(o||0===o)&&(q+=o),q+="\n</section>\n\n<section class='gt-form-section gt-submit-wrapper'>\n",o=c["if"].call(b,b&&b.triggerId,{hash:{},inverse:u.program(15,m,e),fn:u.program(13,l,e),data:e}),(o||0===o)&&(q+=o),q+="\n</section>\n</form>\n</div>\n"}),this.Geotrigger.Editor.Templates.item=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g,h,i="",j=c.helperMissing,k=this.escapeExpression,l="function";return i+="<span class='gt-item-edit gt-icon ",h={hash:{},data:e},i+=k((f=c.actionIcon||b&&b.actionIcon,f?f.call(b,(f=b&&b.condition,null==f||f===!1?f:f.direction),(f=b&&b.condition,null==f||f===!1?f:f.geo),h):j.call(b,"actionIcon",(f=b&&b.condition,null==f||f===!1?f:f.direction),(f=b&&b.condition,null==f||f===!1?f:f.geo),h)))+"'></span>\n<h5>\n<a class='gt-item-edit' href='#edit/",(g=c.triggerId)?g=g.call(b,{hash:{},data:e}):(g=b&&b.triggerId,g=typeof g===l?g.call(b,{hash:{},data:e}):g),i+=k(g)+"'>\n<span class='gt-id'>",(g=c.triggerId)?g=g.call(b,{hash:{},data:e}):(g=b&&b.triggerId,g=typeof g===l?g.call(b,{hash:{},data:e}):g),i+=k(g)+"</span>\n</a>\n</h5>\n<div class='gt-item-toolbar'>\n<a class='gt-edit-icon' href='#edit/",(g=c.triggerId)?g=g.call(b,{hash:{},data:e}):(g=b&&b.triggerId,g=typeof g===l?g.call(b,{hash:{},data:e}):g),i+=k(g)+"'></a>\n<a class='gt-delete-icon' href='#'></a>\n</div>\n<div class='gt-tags'>\n<strong>Tags:</strong> ",h={hash:{},data:e},f=c.tagLinks||b&&b.tagLinks,g=f?f.call(b,b&&b.tags,h):j.call(b,"tagLinks",b&&b.tags,h),(g||0===g)&&(i+=g),i+="\n</div>\n<div class='gt-list-delete'>\n<h5>Delete ",(g=c.triggerId)?g=g.call(b,{hash:{},data:e}):(g=b&&b.triggerId,g=typeof g===l?g.call(b,{hash:{},data:e}):g),i+=k(g)+"?</h5>\n<button class='gt-confirm-delete gt-button-small gt-button-delete'>Delete</button>\n<button class='gt-cancel-delete gt-button-small gt-button gt-button-gray'>Cancel</button>\n</div>\n"}),this.Geotrigger.Editor.Templates.list=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+='<div class="gt-list-header gt-hide">\n<div class="gt-panel-top-bar">\n<h3 class="gt-panel-top-bar-left">\nList <span class="gt-trigger-count">(',(f=c.count)?f=f.call(b,{hash:{},data:e}):(f=b&&b.count,f=typeof f===h?f.call(b,{hash:{},data:e}):f),g+=i(f)+')</span>\n</h3>\n<a href="#" class="gt-panel-top-bar-button gt-close-drawer"></a>\n</div>\n<div class="gt-search">\n<input type="search" placeholder="Search">\n<a href="#list" class="gt-icon-clear"></a>\n</div>\n</div>\n<ul class="gt-results"></ul>\n'}),this.Geotrigger.Editor.Templates.main=Handlebars.template(function(a,b,c,d,e){return this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{},"<div id='gt-controls-region' class='gt-region'></div>\n<div id='gt-content'>\n<div id='gt-drawer-region' class='gt-region'></div>\n<div id='gt-map-region'></div>\n<div id='gt-notes-region' class='gt-region'></div>\n</div>\n"}),this.Geotrigger.Editor.Templates.notification=Handlebars.template(function(a,b,c,d,e){this.compilerInfo=[4,">= 1.0.0"],c=this.merge(c,a.helpers),e=e||{};var f,g="",h="function",i=this.escapeExpression;return g+='<span class="gt-notification-message">',(f=c.message)?f=f.call(b,{hash:{},data:e}):(f=b&&b.message,f=typeof f===h?f.call(b,{hash:{},data:e}):f),g+=i(f)+"</span>\n<button class='gt-close'>&times;</button>\n"}),function(a,b,c){b.registerHelper("select",function(a,b){var d=c("<select>");return d.html(b.fn(this)),d.find('option[value="'+a+'"]').attr("selected","selected"),d.html()}),b.registerHelper("selectShape",function(a,b){var d=c("<select>");d.html(b.fn(this));var e;return a&&a.geo&&(a.geo.distance?e="radius":a.geo.geojson&&(e="polygon")),d.find('option[value="'+e+'"]').attr("selected","selected"),d.html()}),b.registerHelper("shape",function(a,b){var c="";return a&&a.geo&&(a.geo.distance?c="radius":a.geo.geojson&&(c="polygon")),c}),b.registerHelper("stringify",function(a){return JSON.stringify(a)}),b.registerHelper("actionIcon",function(a,b){var c="";return"enter"===a?c+="gt-icon-enter ":"leave"===a&&(c+="gt-icon-exit "),b.geojson&&(c+="gt-icon-polygon "),b.distance&&(c+="gt-icon-radius "),c}),b.registerHelper("defaultTitle",function(a){var b=""+a.direction;if(a.geo.distance)b+=" "+a.geo.distance+" meter radius";else if(a.geo.geojson&&a.geo.geojson.coordinates){var c=a.geo.geojson.coordinates[0].length-1;b+=" "+c+" sided polygon"}return b=b.charAt(0).toUpperCase()+b.slice(1)}),b.registerHelper("unlessDefaultTag",function(a,b){return 0!==a.indexOf("trigger:")?b.fn(this):b.inverse(this)}),b.registerHelper("tagList",function(a,b){if(a&&a.length){for(var c=[],d=0;d<a.length;d++)0!==a[d].indexOf("trigger:")&&c.push(a[d]);return c.join(", ")}return""}),b.registerHelper("tagLinks",function(a,b){if(a&&a.length){if(1===a.length&&0===a[0].indexOf("trigger:"))return"<strong>none</strong>";for(var c=[],d=0;d<a.length;d++)0!==a[d].indexOf("trigger:")&&c.push('<a href="#list/'+encodeURIComponent(a[d]).replace(/%20/g,"+")+'">'+a[d]+"</a>");return c.join(", ")}return"<strong>none</strong>"})}(Geotrigger.Editor,Handlebars,$),function(a){return a.fn.serializeObject=function(){var b,c,d,e=this;return b={},d={},c={validate:/^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,key:/[a-zA-Z0-9_]+|(?=\[\])/g,push:/^$/,fixed:/^\d+$/,named:/^[a-zA-Z0-9_]+$/},this.build=function(a,b,c){return a[b]=c,a},this.push_counter=function(a){return void 0===d[a]&&(d[a]=0),d[a]++},a.each(a(this).serializeArray(),function(d,f){var g,h,i,j,k;if(c.validate.test(f.name)){for(h=f.name.match(c.key),i=f.value,k=f.name;void 0!==(g=h.pop());)c.push.test(g)?(j=new RegExp("\\["+g+"\\]$"),k=k.replace(j,""),i=e.build([],e.push_counter(k),i)):c.fixed.test(g)?i=e.build([],g,i):c.named.test(g)&&(i=e.build({},g,i));return b=a.extend(!0,b,i)}}),b}}(jQuery),L.Tooltip.prototype.updatePosition=function(a){var b=this._map.latLngToLayerPoint(a);return L.DomUtil.setPosition(this._container,b),this._container.style.display="inline-block",this},L.Polygon.prototype.getCenter=function(){for(var a,b,c,d=this._latlngs,e=d[0],f=0,g=0,h=0,i=d.length,j=0,k=i-1;i>j;k=j++)a=d[j],b=d[k],c=(a.lat-e.lat)*(b.lng-e.lng)-(b.lat-e.lat)*(a.lng-e.lng),f+=c,g+=(a.lat+b.lat-2*e.lat)*c,h+=(a.lng+b.lng-2*e.lng)*c;return c=3*f,new L.LatLng(g/c+e.lat,h/c+e.lng)},function(a){"use strict";for(var b,c,d={},e=function(){},f="memory".split(","),g="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,time,timeEnd,trace,warn".split(",");b=f.pop();)a[b]=a[b]||d;for(;c=g.pop();)a[c]=a[c]||e}(window.console=window.console||{}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),function(a){window.underscoreDeepExtend=a()}(function(){return function(a){return function(b){var c=/#{\s*?_\s*?}/,d=Array.prototype.slice,e=Object.prototype.hasOwnProperty;return a.each(d.call(arguments,1),function(d){for(var f in d)if(e.call(d,f))if(a.isUndefined(b[f]))b[f]=d[f];else if(a.isString(d[f])&&c.test(d[f]))a.isString(b[f])&&(b[f]=d[f].replace(c,b[f]));else if(a.isArray(b[f])||a.isArray(d[f])){if(!a.isArray(b[f])||!a.isArray(d[f]))throw"Error: Trying to combine an array with a non-array ("+f+")";b[f]=a.reject(a.deepExtend(b[f],d[f]),function(b){return a.isNull(b)})}else if(a.isObject(b[f])||a.isObject(d[f])){if(!a.isObject(b[f])||!a.isObject(d[f]))throw"Error: Trying to combine an object with a non-object ("+f+")";b[f]=a.deepExtend(b[f],d[f])}else b[f]=d[f]}),b}}}),function(){_.mixin({deepExtend:underscoreDeepExtend(_)})}(),Geotrigger.Editor.module("API",function(a,b,c,d,e,f){function g(){if(!b.config.session||!b.config.session.clientId||!b.config.session.clientSecret)throw new Error("Geotrigger.Editor requires a `session` object with `clientId` and `clientSecret` properties");this.session=new Geotrigger.Session(b.config.session)}this.startWithParent=!1,a.addInitializer(g)}),Geotrigger.Editor.module("Config",function(a,b,c,d,e,f){function g(a){b.config=f.deepExtend(k,a)}this.startWithParent=!1;var h={showArea:!1,shapeOptions:{stroke:!0,color:"#00b1dc",weight:2,opacity:.8,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},i={showArea:!1,shapeOptions:{color:"#00dcb1",opacity:.8,dashArray:"10, 10",weight:2,fill:!0,fillOpacity:.2}},j={showArea:!1,shapeOptions:{color:"#00dcb1",opacity:.8,stroke:!0,weight:2,fill:!0,fillOpacity:.2}},k={el:"#gt-editor",session:{},map:{basemap:"Topographic",center:[0,0],zoom:2,options:{}},fitOnLoad:!0,imagePath:"/images",sharedOptions:h,editOptions:i,highlightOptions:j};a.addInitializer(g)}),Geotrigger.Editor.module("util",function(a,b,c,d,e,f){a.removeEmptyStrings=function(b){for(var c in b){if(""===b[c]&&delete b[c],b[c]instanceof Array){for(var d=!0,e=0;e<b[c].length;e++)if(""!==b[c][e]){d=!1;break}d&&delete b[c]}if("object"==typeof b[c]){b[c]=a.removeEmptyStrings(b[c]);var f=!1;for(var g in b[c]){f=!0;break}f||delete b[c]}}return b},a.isObject=function(a){return"[object Object]"===Object.prototype.toString.call(a)},a.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}}),Geotrigger.Editor.module("Map.Draw",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_tools:{polygon:null,radius:null},_setup:function(){this._tools.polygon=new L.Draw.Polygon(b.map,b.config.editOptions),this._tools.radius=new L.Draw.Circle(b.map,b.config.editOptions),this._eventBindings()},_eventBindings:function(){b.vent.on("draw:new",this.editLayer,this),b.vent.on("index trigger:list trigger:edit",this.clear,this),b.vent.on("trigger:new:ready",this.panToNewTrigger,this),b.vent.on("trigger:edit",this.panToTrigger,this),b.vent.on("draw:enable",this.enableTool,this),b.vent.on("draw:disable",this.disableTool,this),b.map.on("draw:created",this.broadcastLayer),b.reqres.setHandler("draw:layer",this.getEditLayer,this),b.commands.setHandler("draw:clear",this.clear,this)},panToNewTrigger:function(){var a=b.request("draw:layer");a&&b.Map.panToLayer(a)},panToTrigger:function(a){var c=this.newShape(a);this.editLayer(c),b._zoomToLayer?(delete b._zoomToLayer,b.Map.zoomToLayer(c)):b.Map.panToLayer(c)},broadcastLayer:function(a){var c=(a.layerType,a.layer);b.vent.trigger("draw:new",c)},getEditLayer:function(){return b.Map.Layers.edit.getLayers()[0]},newShape:function(a){var c,d=b.collections.triggers.findWhere({triggerId:a}),e=(d.get("triggerId"),d.get("condition").geo);if(e.distance)c=b.Map.circle(e,b.config.editOptions.shapeOptions,!1);else{if(!e.geojson)return void(console&&console.error&&console.error("invalid geo data",e));c=b.Map.polygon(e.geojson,b.config.editOptions.shapeOptions,!1).getLayers()[0]}return c},editLayer:function(a){this.clear();var c=function(){return a&&a.feature&&a.feature.geometry&&a.feature.geometry.type?"MultiPolygon"===a.feature.geometry.type:!1}();return c?(window.layer=a,b.vent.trigger("notify","Editing multipolygon trigger boundaries is not yet supported"),b.Map.Layers.edit.addLayer(a)):a.editing?(a.editing.enable(),b.Map.Layers.edit.addLayer(a)):(b.vent.trigger("notify",{type:"error",message:"Unknown error while trying to enable editing"}),void console.error("LayerError",a))},clear:function(){b.Map.Layers.edit.clearLayers()},enableTool:function(a){this.disableTool(),this._tools[a].enable()},disableTool:function(a){for(var b in this._tools)("undefined"==typeof a||b===a)&&this._tools[b].disable()}}),a.addInitializer(function(){this._setup()})}),Geotrigger.Editor.module("Editor",function(a,b,c,d,e,f){function g(){("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)&&b.vent.trigger("notify",{type:"error",message:"Drawing and editing shapes is not currently supported for this browser."})}var h=d.AppRouter.extend({appRoutes:{"":"index","list(/)":"list","list/:term":"list","new(/)":"create","edit(/)":"redirect","edit/:id":"edit","*notfound":"notFound"}}),i=function(){};f.extend(i.prototype,{start:function(){this.setup(),b.vent.trigger("notify","Fetching application data.."),window.location.hash.match("edit")&&(b._zoomToLayer=!0),b.collections.triggers.fetch({fetch:!0,reset:!0,success:function(a,d,e){b.vent.trigger("notify:clear"),g(),c.history.start(),d&&0===d.length?b.router.navigate("list",{trigger:!0}):b.config.fitOnLoad&&!c.history.fragment.match("edit")&&b.execute("map:fit")}}),b.vent.on("draw:new",function(a){"new"===c.history.fragment||c.history.fragment.match("edit")||b.router.navigate("new",{trigger:!0})},this),b.vent.on("trigger:create",this.createTrigger,this),b.vent.on("trigger:update",this.updateTrigger,this),b.vent.on("trigger:destroy",this.deleteTrigger,this)},setup:function(){this.setupMap(),this.setupDrawer(),this.setupControls(),this.setupNotifications()},setupMap:function(){var a=new b.Views.Map({collection:b.collections.triggers});b.regions.map.show(a)},setupDrawer:function(){var a=b.regions.drawer,c=b.mainRegion.$el.find("#gt-content");a.on("show",function(){c.addClass("gt-active")}),a.on("close",function(){c.removeClass("gt-active")})},setupControls:function(){var a=new b.Views.Controls;b.regions.controls.show(a)},setupNotifications:function(){var a=new b.Views.NotificationList({collection:b.collections.notifications});b.regions.notes.show(a),b.vent.on("notify",function(a){"string"==typeof a&&(a={type:"info",message:a});var c=new b.Models.Notification(a);b.collections.notifications.add(c)},this)},index:function(){b.vent.trigger("index"),b.regions.drawer.close()},list:function(a){if(b.regions.drawer.$el&&b.regions.drawer.$el.has(".gt-list").length)a||b.vent.trigger("trigger:list:reset");else{b.vent.trigger("trigger:list");var d=new c.Model({count:b.collections.triggers.length}),e=new b.Views.List({model:d,collection:b.collections.triggers});b.regions.drawer.show(e)}a&&(a=decodeURIComponent(a.replace(/\+/g,"%20")),b.vent.trigger("trigger:list:search",a))},create:function(){b.vent.trigger("trigger:new");var a=new b.Views.Form;b.regions.drawer.show(a),b.vent.trigger("trigger:new:ready")},edit:function(a){var c=this.getTrigger(a);if(c){var d=new b.Views.Form({model:c});b.regions.drawer.show(d),b.vent.trigger("trigger:edit",a),d.parseShape()}else b.vent.trigger("notify",{type:"error",message:"That trigger doesn't exist!"})},redirect:function(){b.router.navigate("",{trigger:!0,replace:!0})},notFound:function(){b.vent.trigger("notify",{type:"error",message:"Couldn't find page: \""+c.history.fragment+'"'})},createTrigger:function(a){b.execute("draw:clear"),b.collections.triggers.create(a,{success:function(){b.router.navigate("list",{trigger:!0})}})},getTrigger:function(a){var c=b.collections.triggers.findWhere({triggerId:a});return c},updateTrigger:function(a){b.collections.triggers.once("change",function(a){b.router.navigate("list",{trigger:!0})});var c=b.collections.triggers.findWhere({triggerId:a.triggerId});c.set(a),c.set("id",c.get("triggerId")),c.save()},deleteTrigger:function(a){b.collections.triggers.once("remove",function(a){c.history.fragment.match("edit")&&b.router.navigate("list",{trigger:!0})}),a.set("id",a.get("triggerId")),a.destroy()}}),a.addInitializer(function(){b.collections=b.collections||{},b.collections.triggers=new b.Models.Triggers,b.collections.notifications=new b.Models.Notifications;var a=new i;b.router=new h({controller:a}),a.start()})}),Geotrigger.Editor.module("Map.Layers",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_setup:function(){this.main=new L.FeatureGroup,b.map.addLayer(this.main),this.edit=new L.FeatureGroup,b.map.addLayer(this.edit)}}),a.addInitializer(function(){this._setup()})}),Geotrigger.Editor.module("Map",function(a,b,c,d,e,f){this.startWithParent=!1,f.extend(a,{_setup:function(a){b.config.session.proxy&&(L.esri.get=L.esri.Request.get.JSONP);var c=this._getDefaultBasemap();if(b.map=this.map=L.map(a.el,{center:b.config.map.center,zoom:b.config.map.zoom,layers:[c]}),this.map.zoomControl.setPosition("topright"),L.control.layers(this.basemaps).addTo(b.map),L.esri&&L.esri.Geocoding.Controls&&L.esri.Geocoding.Controls.Geosearch){new L.esri.Geocoding.Controls.Geosearch({position:"topright"
}).addTo(b.map)}this.Layers.start(),this._eventBindings()},_getDefaultBasemap:function(){if(this._setupBasemaps(),b.config.map.basemap&&this.basemaps.hasOwnProperty(b.config.map.basemap))return this.basemaps[b.config.map.basemap];if(b.util.isArray(b.config.map.basemaps)){for(var a=L.layerGroup(),c=0;c<b.config.map.basemaps.length;c++)a.addLayer(b.config.map.basemaps[c],b.config.map.options);return a}return L.esri.basemapLayer(b.config.map.basemap,b.config.map.options)},_eventBindings:function(){b.commands.setHandler("map:fit",f.bind(function(){if(0!==this.Layers.main.getLayers().length){var a=this.Layers.main.getBounds(),b=this.getDrawerWidth();this.map.fitBounds(a,{animate:!1,paddingTopLeft:[b,0]})}},this))},_setupBasemaps:function(){var a=L.esri.basemapLayer("Streets",b.config.map.options),c=L.esri.basemapLayer("Topographic",b.config.map.options),d=L.esri.basemapLayer("Oceans",b.config.map.options),e=L.esri.basemapLayer("NationalGeographic",b.config.map.options),f=L.layerGroup([L.esri.basemapLayer("Gray",b.config.map.options),L.esri.basemapLayer("GrayLabels",b.config.map.options)]),g=L.layerGroup([L.esri.basemapLayer("DarkGray",b.config.map.options),L.esri.basemapLayer("DarkGrayLabels",b.config.map.options)]),h=L.layerGroup([L.esri.basemapLayer("Imagery",b.config.map.options),L.esri.basemapLayer("ImageryLabels",b.config.map.options)]),i=L.layerGroup([L.esri.basemapLayer("ShadedRelief",b.config.map.options),L.esri.basemapLayer("ShadedReliefLabels",b.config.map.options)]);this.basemaps={Streets:a,Topographic:c,Oceans:d,NationalGeographic:e,Gray:f,DarkGray:g,Imagery:h,ShadedRelief:i}},getDrawerWidth:function(){var a=b.mainRegion.$el.find("#gt-content"),c=a.find("#gt-drawer-region");return a.hasClass("gt-active")?c.width():0},panToLayer:function(a){var b;a.getLatLng?b=a.getLatLng():a.getCenter&&(b=a.getCenter());var c=this.getDrawerWidth();if(c){var d=this.map.project(b);d.x=d.x-c/2,b=this.map.unproject(d)}b&&this.map.panTo(b,{animate:!0})},zoomToLayer:function(a){var b=a.getBounds(),c=this.getDrawerWidth();this.map.fitBounds(b,{animate:!1,paddingTopLeft:[c,0]})},removeShape:function(a){this.map.removeLayer(a)},focusShape:function(a){a.setStyle(b.config.highlightOptions.shapeOptions)},unfocusShape:function(a){a.setStyle(b.config.sharedOptions.shapeOptions)},polygon:function(a,c,d){c=c||b.config.sharedOptions.shapeOptions;var e=new L.GeoJSON(a,{style:function(a){return c}});return d!==!1&&this.Layers.main.addLayer(e),e},circle:function(a,c,d){c=c||b.config.sharedOptions.shapeOptions;var e=L.circle([a.latitude,a.longitude],a.distance,c);return d!==!1&&this.Layers.main.addLayer(e),e}}),a.addInitializer(function(a){this._setup(a),this.Draw.start()})}),Geotrigger.Editor.module("Models",function(a,b,c,d,e,f){a.Notification=c.Model.extend({defaults:{type:"info",message:"everything's fine"}}),a.Notifications=c.Collection.extend({model:a.Notification})}),Geotrigger.Editor.module("Models",function(a,b,c,d,e,f){function g(a){var b="Error creating trigger",c=JSON.stringify(a);return null!==c.match("Coordinate values are out of range")&&(b="Coordinate values are out of range"),null!==c.match("no triggers found")&&(b="Deleted triggers can't be updated"),null!==c.match("Error performing intersection")&&(b="Polygons can't intersect themselves"),null!==c.match("message:Not a valid parameter for this request")&&(b="Notifications must have a valid message"),b}a.Trigger=c.Model.extend({sync:function(a,c,d){var e,h=this.get("triggerId"),i=f.bind(function(c,e){c?(b.vent.trigger("notify",{type:"error",message:g(c)}),d&&d.error&&d.error("Record Not Found")):("read"!==a&&b.vent.trigger("notify",{message:"Trigger "+a+"d successfully",timeout:3500}),d&&d.success&&d.success(e))},this);switch(a){case"read":b.API.session.request("trigger/list",{triggerIds:[h]},i);break;case"create":e={setTags:this.get("tags"),condition:this.get("condition"),action:this.get("action"),properties:this.get("properties"),rateLimit:this.get("rateLimit"),times:this.get("times")},h&&(e.triggerId=h),b.API.session.request("trigger/create",e,i);break;case"update":e={triggerIds:h,setTags:this.get("tags"),condition:this.get("condition"),action:this.get("action"),properties:this.get("properties"),rateLimit:this.get("rateLimit"),times:this.get("times")},b.API.session.request("trigger/update",e,i);break;case"delete":b.API.session.request("trigger/delete",{triggerIds:h},i);break;default:throw new Error("Unsupported method: "+a)}},parse:function(a){return a.triggers?a.triggers:a}}),a.Triggers=c.Collection.extend({model:a.Trigger,fetch:function(a){var c=f.bind(function(b,c){a&&a.reset?this.reset(this.parse(c)):this.set(this.parse(c)),a&&a.success&&a.success(this,this.parse(c),a)},this);b.API.session.request("trigger/list",c)},parse:function(a){return a.triggers}})}),Geotrigger.Editor.module("Views",function(a,b,c,d,e,f){a.Controls=d.ItemView.extend({template:b.Templates.controls,className:"gt-control-group",events:{"click .gt-tool-list":"toggleList","click .gt-tool-create":"toggleNew","click .gt-tool-polygon":"togglePolygon","click .gt-tool-radius":"toggleRadius"},ui:{drawers:".gt-drawer-controls",tools:".gt-tool-controls",list:".gt-drawer-controls .gt-tool-list",create:".gt-drawer-controls .gt-tool-create",polygon:".gt-tool-controls .gt-tool-polygon",radius:".gt-tool-controls .gt-tool-radius",all:".gt-tool"},onRender:function(){this.listenTo(b.router,"route",this.handleStateChange),this.listenTo(b.vent,"draw:new",this.disableTool),this.listenTo(b.vent,"draw:enable",function(a){this.activate(a)}),this.listenTo(b.vent,"draw:disable",function(a){this.ui.tools.find(".gt-tool").removeClass("gt-active")})},handleStateChange:function(a){switch(this.clear("drawers"),a){case"new":this.activate("list");break;case"edit":this.activate("list");break;case"list":this.activate("list")}},toggleList:function(a){this.ui.list.hasClass("gt-active")&&(a.preventDefault(),b.router.navigate("",{trigger:!0}))},toggleNew:function(a){this.ui.create.hasClass("gt-active")&&(a.preventDefault(),b.router.navigate("",{trigger:!0}))},togglePolygon:function(a){this.ui.polygon.hasClass("gt-active")?this.disableTool("polygon"):this.enableTool("polygon")},toggleRadius:function(a){this.ui.radius.hasClass("gt-active")?this.disableTool("radius"):this.enableTool("radius")},enableTool:function(a){this.disableTool(),b.vent.trigger("draw:enable",a)},disableTool:function(a){b.vent.trigger("draw:disable",a)},activate:function(a){this.ui[a].addClass("gt-active")},toggle:function(a){"list"===a?(this.ui.list.toggleClass("gt-active"),this.ui.create.removeClass("gt-active")):"create"===a&&(this.ui.create.toggleClass("gt-active"),this.ui.list.removeClass("gt-active"))},clear:function(a){"drawers"===a?this.ui.drawers.find(".gt-tool").removeClass("gt-active"):"tools"===a?this.ui.tools.find(".gt-tool").removeClass("gt-active"):this.ui.all.removeClass("gt-active")}})}),Geotrigger.Editor.module("Views",function(a,b,c,d,e,f){a.Form=d.ItemView.extend({template:b.Templates["form/index"],className:"gt-panel",events:{"click .gt-add-extra":"addExtra","click .gt-remove-extra":"removeExtra","click .gt-add-action":"addAction","click .gt-remove-action":"removeAction","click .gt-add-notification":"addNotification","click .gt-remove-notification":"removeNotification","click .gt-submit":"parseForm","click .gt-item-delete":"confirmDelete","click .gt-reset-delete":"resetDelete","click .gt-item-confirm-delete":"destroyModel"},ui:{actions:".gt-actions",extras:".gt-extras",addAction:".gt-add-action",form:"form",deleteItem:".gt-item-delete",confirm:".gt-item-confirm-delete",reset:".gt-reset-delete"},onShow:function(){this.model?this.buildEditForm():this.buildNewForm(),this.listenTo(b.vent,"draw:new",this.parseShape)},buildNewForm:function(){var a=this.serializeData(),c="",d="";this.parseShape(),c=b.Templates["form/actions/notification/index"](a),d=b.Templates["form/actions/notification/text"](a),this.ui.actions.html(c),this.ui.actions.find(".gt-notification-actions").html(d),this.ui.form.find('.gt-add-action[data-action="notification"]').hide(),this.ui.form.find('.gt-add-notification[data-notification="text"]').hide()},buildEditForm:function(){function a(a,b){return a.hasOwnProperty(b)&&void 0!==a[b]&&null!==a[b]}var c,d,e=this.model.get("action"),f=this.serializeData(),g="",h="",i="",j=a(e,"notification");if(j){for(c in e.notification)a(e.notification,c)&&(h+=b.Templates["form/actions/notification/"+c](f));""!==h&&(g+=b.Templates["form/actions/notification/index"](f),this.ui.form.find('.gt-add-action[data-action="notification"]').hide())}var k=["callbackUrl","trackingProfile"];for(d=0;d<k.length;d++)a(e,k[d])&&(g+=b.Templates["form/actions/"+k[d]](f),this.ui.form.find('.gt-add-action[data-action="'+k[d]+'"]').hide());if(this.ui.actions.html(g),""!==h){this.ui.actions.find(".gt-notification-actions").html(h);for(c in e.notification)if(a(e.notification,c)){var l=this.ui.form.find('.gt-add-notification[data-notification="'+c+'"]');l.hide()}}var m=a(this.model.attributes,"properties");m&&(i+=b.Templates["form/extras/properties"](f),this.ui.form.find('.gt-add-extra[data-extra="properties"]').hide());var n,o=["rateLimit","times"];for(d=0;d<o.length;d++)n=a(this.model.attributes,o[d])&&0!==parseInt(this.model.attributes[o[d]],10),n&&(i+=b.Templates["form/extras/"+o[d]](f),this.ui.form.find('.gt-add-extra[data-extra="'+o[d]+'"]').hide());this.ui.extras.html(i)},addAction:function(a){var c,d,f,g;"object"==typeof a&&a.preventDefault?(a.preventDefault(),c=e(a.target),d=c.data("action")):"string"==typeof a&&(d=a,c=this.ui.form.find(".gt-add-action[data-action='"+d+"']")),"notification"===d?(f=b.Templates["form/actions/notification/index"]({}),g=b.Templates["form/actions/notification/text"]({}),this.ui.actions.append(f),this.ui.actions.find(".gt-notification-actions").html(g),this.ui.form.find('.gt-add-notification[data-notification="text"]').hide()):(f=b.Templates["form/actions/"+d]({}),this.ui.actions.append(f)),c.hide()},removeAction:function(a){var b,c;"object"==typeof a&&a.preventDefault?(a.preventDefault(),b=e(a.target).closest(".gt-property"),c=b.data("action")):"string"==typeof a&&(c=a,b=this.ui.form.find(".gt-property[data-action='"+c+"']")),b.remove(),this.ui.form.find('.gt-add-action[data-action="'+c+'"]').show()},addNotification:function(a){a&&a.preventDefault&&a.preventDefault();var c=e(a.target),d=c.data("notification"),f=b.Templates["form/actions/notification/"+d]({});this.ui.actions.find(".gt-notification-actions").append(f),c.hide()},removeNotification:function(a){a&&a.preventDefault&&a.preventDefault();var b=e(a.target).closest(".gt-notification-action"),c=b.data("notification");b.remove(),this.ui.form.find('.gt-add-notification[data-notification="'+c+'"]').show()},addExtra:function(a){var c,d,f;"object"==typeof a&&a.preventDefault?(a.preventDefault(),c=e(a.target),d=c.data("extra")):"string"==typeof a&&(d=a,c=this.ui.form.find(".gt-add-extra[data-extra='"+d+"']")),f=b.Templates["form/extras/"+d]({}),this.ui.extras.append(f),c.hide()},removeExtra:function(a){var b,c;"object"==typeof a&&a.preventDefault?(a.preventDefault(),b=e(a.target).closest(".gt-property"),c=b.data("extra")):"string"==typeof a&&(c=a,b=this.ui.form.find(".gt-property[data-extra='"+c+"']")),b.remove(),this.ui.form.find('.gt-add-extra[data-extra="'+c+'"]').show()},parseShape:function(){var a,c,d,e=b.request("draw:layer"),f=this.ui.form.find('[name="condition[direction]"]'),g=this.ui.form.find('[name="geometry-type"]'),h=this.ui.form.find(".gt-shape-indicator"),i=this.ui.form.find(".gt-form-section");null===f.val()&&f.val("enter"),e instanceof L.Polygon?(a=Math.round(1e4*e.getCenter().lat)/1e4,c=Math.round(1e4*e.getCenter().lng)/1e4,g.val("polygon"),h.text("a polygon around "+a+", "+c),i.show()):e instanceof L.Circle?(a=Math.round(1e4*e.getLatLng().lat)/1e4,c=Math.round(1e4*e.getLatLng().lng)/1e4,d=Math.round(e.getRadius()),g.val("radius"),h.text("a "+d+"m radius around "+a+", "+c),i.show()):e instanceof L.MultiPolygon?(g.val("multipolygon"),h.text("a multipolygon"),i.show()):i.filter(":not(:first-child)").hide()},parseForm:function(a){function c(a){return!isNaN(a)&&isFinite(a)}a&&a.preventDefault&&a.preventDefault();var d,e=[],f=this.ui.form.serializeObject();if(f=b.util.removeEmptyStrings(f),f.tags){var g=f.tags;for(g=g.split(","),d=g.length-1;d>=0;d--)g[d]=g[d].trim();f.tags=g}else e.push("at least one tag is required");if(f.condition){var h=b.request("draw:layer");if(h instanceof L.Polygon||h instanceof L.MultiPolygon)f.condition.geo={geojson:h.toGeoJSON().geometry};else if(h instanceof L.Circle){var i=h.getLatLng();f.condition.geo={latitude:i.lat,longitude:i.lng,distance:Math.round(h.getRadius())}}else e.push("missing trigger shape")}else e.push("direction for trigger condition is required");if(f.action){if(f.action.notification){if(f.action.notification.data)try{f.action.notification.data=JSON.parse(f.action.notification.data)}catch(j){e.push("notification data must be valid JSON")}}else f.action.notification=null;f.action.trackingProfile||(f.action.trackingProfile=null),f.action.callbackUrl||(f.action.callbackUrl=null)}else e.push("at least one action required");if(f.properties)try{f.properties=JSON.parse(f.properties)}catch(j){e.push("properties must be valid JSON")}else f.properties=null;if(f.rateLimit?(f.rateLimit=parseInt(f.rateLimit,10),c(f.rateLimit)||e.push("rate limit must be valid integer")):f.rateLimit=0,f.times?(f.times=parseInt(f.times,10),c(f.times)||e.push("times must be valid integer")):f.times=0,e.length>0)for(d=e.length-1;d>=0;d--)b.vent.trigger("notify",{type:"error",message:e[d]});else this.createOrUpdateTrigger(f)},createOrUpdateTrigger:function(a){var c=b.collections.triggers.findWhere({triggerId:a.triggerId}),d=!this.model&&!c,e=!this.model&&!!c,f=!!this.model,g='A trigger with the ID "'+a.triggerId+'" already exists. Do you want to overwrite it?';return d?b.vent.trigger("trigger:create",a):e&&confirm(g)?b.vent.trigger("trigger:update",a):f?(a.triggerId=this.model.get("triggerId"),b.vent.trigger("trigger:update",a)):void 0},confirmDelete:function(a){a&&a.preventDefault&&a.preventDefault(),this.ui.deleteItem.addClass("gt-item-confirm-delete"),this.ui.reset.addClass("gt-reset-flyout-right")},resetDelete:function(a){a&&a.preventDefault&&a.preventDefault(),this.ui.deleteItem.removeClass("gt-item-confirm-delete"),this.ui.reset.removeClass("gt-reset-flyout-right")},destroyModel:function(a){a&&a.preventDefault&&a.preventDefault(),b.vent.trigger("trigger:destroy",this.model)}})}),Geotrigger.Editor.module("Views",function(a,b,c,d,e,f){a.ListItem=d.ItemView.extend({template:b.Templates.item,tagName:"li",className:"gt-result",events:{"click .gt-item-edit":"editItem","click .gt-tags":"tagsClick","click .gt-delete-icon":"confirmDelete","click .gt-cancel-delete":"resetDelete","click .gt-confirm-delete":"destroyModel"},ui:{deleteItem:".gt-list-delete",confirm:".gt-item-confirm-delete",reset:".gt-reset-delete"},modelEvents:{change:"modelChanged"},onShow:function(){var a=this.model.get("triggerId");this.$el.hover(function(){b.vent.trigger("trigger:focus",a)},function(){b.vent.trigger("trigger:unfocus",a)})},modelChanged:function(){this.render()},editItem:function(){var a=this.model.get("triggerId");b.router.navigate("edit/"+a,{trigger:!0})},tagsClick:function(a){a.stopPropagation()},confirmDelete:function(a){a.preventDefault(),a.stopPropagation(),this.ui.deleteItem.addClass("gt-visible")},resetDelete:function(a){a.preventDefault(),a.stopPropagation(),this.ui.deleteItem.removeClass("gt-visible")},destroyModel:function(a){a.preventDefault(),a.stopPropagation(),b.vent.trigger("trigger:destroy",this.model)}}),a.Empty=d.ItemView.extend({template:b.Templates.empty,className:"gt-list-empty"}),a.List=d.CompositeView.extend({template:b.Templates.list,className:"gt-list gt-panel",itemView:a.ListItem,itemViewContainer:".gt-results",emptyView:a.Empty,events:{"keyup .gt-search":"filter","click .gt-icon-clear":"clearFilter"},ui:{header:".gt-list-header",search:".gt-search input",results:".gt-results"},onShow:function(){this.refresh(),this.listenTo(this.collection,"change reset add remove",this.refresh),this.listenTo(b.vent,"trigger:list:search",this.search),this.listenTo(b.vent,"trigger:list:reset",this.clearFilter)},refresh:function(){var a=this.collection.length;this.model.set("count",a),this.render(),a?this.ui.header.removeClass("gt-hide"):this.ui.header.addClass("gt-hide")},search:function(a){this.ui.search.val(a),this.filter()},clearFilter:function(){this.ui.search.val(""),this.$el.removeClass("gt-filtering")},filter:function(a){var d=this.ui.search.val();if(d.length)if("undefined"!=typeof a&&13===a.keyCode){var f="list/"+encodeURIComponent(d).replace(/%20/g,"+");b.router.navigate(f,{trigger:!0})}else{this.$el.addClass("gt-filtering");var g=this.ui.results.find(".gt-result"),h=this.ui.search.val().split(/\s+/),i="(?=.*"+h.join(")(?=.*")+")",j=new RegExp(i,"i");g.each(function(){var a=e(this),b="";b+=a.find(".gt-id").text(),a.find(".gt-tags a").each(function(){b+=e(this).text()}),j.exec(b)?a.addClass("gt-list-visible"):a.removeClass("gt-list-visible")})}else this.$el.removeClass("gt-filtering"),"list"!==c.history.fragment&&b.router.navigate("list",{trigger:!1})}})}),Geotrigger.Editor.module("Layouts",function(a,b,c,d,e,f){a.Main=c.Marionette.Layout.extend({template:b.Templates.main,id:"gt-regions",regions:{controls:"#gt-controls-region",drawer:"#gt-drawer-region",map:"#gt-map-region",notes:"#gt-notes-region"}})}),Geotrigger.Editor.module("Views",function(a,b,c,d,e,f){a.Shape=d.View.extend({modelEvents:{change:"render"},render:function(){return this.isClosed=!1,this.triggerMethod("before:render",this),this.triggerMethod("item:before:render",this),this.renderShape(),this.triggerMethod("render",this),this.triggerMethod("item:rendered",this),this},renderShape:function(){var a=(this.model.get("triggerId"),this.model.get("condition").geo);if(this.removeShape(),a.distance)this._shape=b.Map.circle(a);else{if(!a.geojson)return void(console&&console.error&&console.error("invalid geo data",a));this._shape=b.Map.polygon(a.geojson)}this._shape.on("click",f.bind(function(){b.router.navigate("edit/"+this.model.get("triggerId"),{trigger:!0})},this)),this._shape.on("mouseover",f.bind(function(){b.Map.focusShape(this._shape)},this)),this._shape.on("mouseout",f.bind(function(){b.Map.unfocusShape(this._shape)},this))},removeShape:function(){this._shape&&(b.Map.removeShape(this._shape),delete this._shape)},focusShape:function(){this._shape&&b.Map.focusShape(this._shape)},unfocusShape:function(){this._shape&&b.Map.unfocusShape(this._shape)},onClose:function(){this.removeShape()}}),a.Map=d.CollectionView.extend({id:"gt-map",itemView:a.Shape,onShow:function(){b.Map.start({el:this.el}),this.listenTo(b.vent,"trigger:edit",this.hideShape),this.listenTo(b.vent,"index trigger:new trigger:list trigger:edit",this.restore),this.listenTo(b.vent,"trigger:focus",this.focusShape),this.listenTo(b.vent,"trigger:unfocus",this.unfocusShape)},hideShape:function(a){var c=b.collections.triggers.findWhere({triggerId:a}),d=this.children.findByModel(c);d.removeShape()},focusShape:function(a){var c=b.collections.triggers.findWhere({triggerId:a}),d=this.children.findByModel(c);d.focusShape()},unfocusShape:function(a){var c=b.collections.triggers.findWhere({triggerId:a}),d=this.children.findByModel(c);d.unfocusShape()},restore:function(a){this.children.each(function(b,c,d){if(!b._shape){var e=b.model.get("triggerId");a&&e===a||b.render()}})}})}),Geotrigger.Editor.module("Views",function(a,b,c,d,e,f){a.Notification=d.ItemView.extend({template:b.Templates.notification,className:"gt-notification",tagName:"li",events:{"click .gt-close":"destroyNotification"},render:function(){d.ItemView.prototype.render.apply(this,arguments);var a=this.model.get("type")||"info";this.$el.addClass(a),this.listenTo(b.vent,"notify:clear",this.destroyNotification)},onShow:function(){this.$el.fadeIn();var a=this.model.get("timeout");"number"==typeof a&&setTimeout(f.bind(function(){this.destroyNotification()},this),a)},destroyNotification:function(){this.$el.fadeOut(f.bind(function(){this.model.destroy()},this))}}),a.NotificationList=d.CollectionView.extend({itemView:a.Notification,className:"gt-notification-list",tagName:"ul"})})}();