/*! geotrigger-editor 2013-08-28 */
GeotriggerEditor.module("Config",function(a,b,c,d,e,f){var g={showArea:!1,shapeOptions:{stroke:!0,color:"#00b1dc",weight:2,opacity:.8,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},h=L.icon({iconUrl:"img/blue-dot.png",iconRetinaUrl:"img/blue-dot@2x.png",iconSize:[12,12],iconAnchor:[6,6],popupAnchor:[0,0],shadowUrl:null,shadowRetinaUrl:null,shadowSize:[0,0],shadowAnchor:[0,0]});f.extend(a,{Map:{basemap:"Streets",center:[45.516484,-122.676339],zoom:12},imagePath:"/images",polygonOptions:g,circleOptions:g,drivetimeOptions:{icon:h}})}),GeotriggerEditor.module("Editor",function(a,b,c,d,e,f){a.Router=d.AppRouter.extend({appRoutes:{}});var g=function(){this.triggerCollection=new b.Collections.Triggers};f.extend(g.prototype,{start:function(){this.showMap(),this.showControls(),this.setupDrawers(this.triggerCollection),this.triggerCollection.fetch({success:function(){},error:function(){},complete:function(){}})},showMap:function(){var a=new b.Views.Map;b.mapRegion.show(a)},showControls:function(){b.Editor.Controller.controlsView=new b.Views.Controls,b.controlsRegion.show(b.Editor.Controller.controlsView)},setupDrawers:function(a){this.drawerLayout=new b.Layout.Drawer;var c=new b.Views.List({collection:a});new b.Views.Empty,b.listDrawerRegion.show(this.drawerLayout),this.drawerLayout.listRegion.show(c),b.Editor.Controller.controlsView.toggleList()}}),a.addInitializer(function(){a.Controller=new g,new a.Router({controller:a.Controller}),a.Controller.start()})}),GeotriggerEditor.module("Layout",function(a,b,c){a.Drawer=c.Marionette.Layout.extend({template:"drawer-list",className:"gt-panel-wrap",events:{"click .gt-back-to-list":"backToList","click .gt-close-drawer":"closeDrawer"},regions:{listRegion:".gt-panel-list",editRegion:".gt-panel-edit"},backToList:function(a){a.preventDefault(),this.$el.removeClass("gt-panel-editing")},closeDrawer:function(a){"undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),b.Editor.Controller.controlsView.restoreShape(),b.listDrawerRegion.$el.removeClass("gt-open"),b.controlsRegion.$el.find(".gt-tool-list").removeClass("gt-active")}})}),GeotriggerEditor.module("Map",function(a,b,c,d,e,f){var g={editLayer:null,tools:{polygon:null,radius:null},init:function(){this.editLayer=new L.FeatureGroup,a.instance.addLayer(this.editLayer),this.tools.polygon=new L.Draw.Polygon(a.instance,b.Config.polygonOptions),this.tools.radius=new L.Draw.Circle(a.instance,b.Config.circleOptions),a.instance.on("draw:created",function(c){c.layerType;var d=c.layer;d.editing.enable(),a.Draw.clear(),a.Draw.editLayer.addLayer(d),b.controlsRegion.currentView.disableDrawTool(),b.controlsRegion.currentView.showNew()})},polygon:function(c){return polygon=new L.GeoJSON(c,{style:function(){return b.Config.polygonOptions.shapeOptions}}),polygon.addTo(a.instance),polygon},radius:function(c){var d=L.circle([c.latitude,c.longitude],c.distance,b.Config.circleOptions.shapeOptions);return d.addTo(a.instance),d},clearShape:function(b){a.instance.removeLayer(b)},clear:function(){a.Draw.editLayer.clearLayers()},enableTool:function(a){this.disableTool(),this.tools[a].enable()},disableTool:function(a){for(var b in this.tools)("undefined"==typeof a||b===a)&&this.tools[b].disable()}};f.extend(a,{init:function(a){this.instance=L.map(a).setView(b.Config.Map.center,b.Config.Map.zoom),this.instance.zoomControl.setPosition("topright"),L.esri.basemapLayer(b.Config.Map.basemap).addTo(this.instance),this.Draw.init()},zoomToLayer:function(a){this.instance.fitBounds(a.getBounds(),{paddingTopLeft:[b.listDrawerRegion.$el.width(),0]})},Draw:g})}),GeotriggerEditor.module("Models",function(a,b,c){a.Trigger=c.Model.extend({defaults:{condition:{direction:"enter",geo:{latitude:45.5165,longitude:-122.6764,distance:240}},action:{message:"Welcome to Portland"},tags:["foodcarts","citygreetings"]}})}),GeotriggerEditor.module("Collections",function(a,b,c){a.Triggers=c.Collection.extend({model:b.Models.Trigger,url:"/dev/js/response.json",parse:function(a){return a.triggers}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Controls=d.ItemView.extend({template:"controls",className:"gt-control-group",events:{"click .gt-tool-list":"toggleList","click .gt-tool-create":"toggleNew","click .gt-tool-polygon":"polygon","click .gt-tool-radius":"radius"},toggleList:function(a){"undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),b.newDrawerRegion.currentView&&b.newDrawerRegion.currentView.closeDrawer(),b.listDrawerRegion.$el.toggleClass("gt-open"),b.controlsRegion.$el.find(".gt-tool-list").toggleClass("gt-active"),this.resetDeleteButtons(),this.restoreShape()},toggleNew:function(a){if("undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),b.listDrawerRegion.currentView.closeDrawer(),!b.newDrawerRegion.currentView||!b.newDrawerRegion.$el.hasClass("gt-open")){var c=new b.Views.New;b.newDrawerRegion.show(c)}b.newDrawerRegion.$el.toggleClass("gt-open"),b.controlsRegion.$el.find(".gt-tool-create").toggleClass("gt-active"),this.resetDeleteButtons(),this.restoreShape()},showNew:function(){var a=new b.Views.New({layer:b.Map.Draw.editLayer});b.newDrawerRegion.show(a),b.listDrawerRegion.currentView.closeDrawer(),b.newDrawerRegion.$el.addClass("gt-open"),b.controlsRegion.$el.find(".gt-tool-create").addClass("gt-active"),this.resetDeleteButtons(),this.restoreShape()},polygon:function(a){a.preventDefault(),this.enableDrawTool("polygon")},radius:function(a){a.preventDefault(),this.enableDrawTool("radius")},enableDrawTool:function(a){this.disableDrawTool(),b.Map.Draw.enableTool(a),b.controlsRegion.$el.find(".gt-tool-"+a).addClass("gt-active"),this.resetDeleteButtons()},disableDrawTool:function(a){a&&b.Map.Draw.disableTool(a),b.controlsRegion.$el.find(".gt-draw-tools .gt-tool").removeClass("gt-active")},resetDeleteButtons:function(){b.Editor.Controller.drawerLayout.$el.find(".gt-item-confirm-delete").removeClass("gt-item-confirm-delete"),b.Editor.Controller.drawerLayout.$el.find(".gt-reset-delete").removeClass("gt-reset-flyout")},restoreShape:function(){b.Editor.Controller.drawerLayout.editRegion.currentView&&b.Editor.Controller.drawerLayout.editRegion.currentView.restoreShape()}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Edit=d.ItemView.extend({template:"edit",className:"gt-edit",onShow:function(){var a,c=this.options.item;if(c.shape.getLayers)a=c.shape.getLayers()[0];else{if(!c.shape.editing)throw new Error("Unknown Layer Error");a=c.shape}b.Map.Draw.clearShape(a),a.editing.enable(),b.Map.Draw.editLayer.addLayer(a),b.Map.zoomToLayer(a)},restoreShape:function(){this.options.item.restoreShape()}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.ListItem=d.ItemView.extend({template:"item",tagName:"li",className:"gt-result",events:{"click .gt-item-edit":"editItem","click .gt-item-delete":"confirmDelete","click .gt-reset-delete":"resetDelete","click .gt-item-confirm-delete":"destroyModel"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change",this.renderShape)},onShow:function(){b.listDrawerRegion.$el.find(".gt-list-header").removeClass("gt-hide"),this.renderShape()},renderShape:function(){this.shape&&(b.Map.Draw.clearShape(this.shape),this.shape=null);var a=this.model.get("condition").geo;this.shape=a.geojson?b.Map.Draw.polygon(a.geojson):b.Map.Draw.radius(a)},restoreShape:function(){b.Map.instance.hasLayer(this.shape)||(b.Map.Draw.clear(),this.renderShape())},editItem:function(a){a.preventDefault();var c=new b.Views.Edit({model:this.model,item:this});b.Editor.Controller.drawerLayout.editRegion.show(c),b.Editor.Controller.drawerLayout.$el.addClass("gt-panel-editing"),b.Editor.Controller.controlsView.resetDeleteButtons()},confirmDelete:function(a){a.preventDefault(),this.$el.find(".gt-item-delete").addClass("gt-item-confirm-delete"),this.$el.find(".gt-reset-delete").addClass("gt-reset-flyout")},resetDelete:function(a){a.preventDefault(),this.$el.find(".gt-item-confirm-delete").removeClass("gt-item-confirm-delete"),this.$el.find(".gt-reset-delete").removeClass("gt-reset-flyout")},destroyModel:function(a){a.preventDefault(),b.Map.Draw.clearShape(this.shape),this.model.destroy()}}),a.Empty=d.ItemView.extend({template:"empty",className:"gt-list-empty",events:{"click .gt-tool-create":"newTrigger"},onShow:function(){b.listDrawerRegion.$el.find(".gt-list-header").addClass("gt-hide")},newTrigger:function(a){a.preventDefault(),b.Editor.Controller.controlsView.toggleNew()}}),a.List=d.CompositeView.extend({template:"list",className:"gt-list",itemView:a.ListItem,itemViewContainer:".gt-results",emptyView:a.Empty})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.Map=d.ItemView.extend({id:"gt-map",render:function(){return this.isClosed=!1,this.triggerMethod("before:render",this),this.triggerMethod("item:before:render",this),this.triggerMethod("render",this),this.triggerMethod("item:rendered",this),this},onShow:function(){b.Map.init(this.el)}})}),GeotriggerEditor.module("Views",function(a,b,c,d){a.New=d.ItemView.extend({template:"new",className:"gt-new gt-panel-wrap",events:{"click .gt-close-drawer":"closeDrawer","click .gt-submit":"parseForm"},initialize:function(a){"undefined"!=typeof a&&a.layer&&b.Map.zoomToLayer(a.layer)},closeDrawer:function(a){"undefined"!=typeof a&&a.preventDefault&&a.preventDefault(),b.Map.Draw.clear(),b.newDrawerRegion.$el.removeClass("gt-open"),b.controlsRegion.$el.find(".gt-tool-create").removeClass("gt-active")},parseForm:function(a){a.preventDefault();var c=this.$el.find("form").serializeObject();c&&(this.createTrigger(c),b.Editor.Controller.controlsView.toggleList())},createTrigger:function(){var a=b.Map.Draw.editLayer.getLayers()[0],c={condition:{direction:"enter",geo:{geojson:a.toGeoJSON()}},action:{message:"Welcome to Portland - The Mayor",callback:"http://pdx.gov/welcome"},tags:["newtags"]};b.Map.Draw.clear(),b.Editor.Controller.triggerCollection.add(new b.Models.Trigger(c))}})});